<!-- Componente UC Selector Jer√°rquico Mejorado -->
<div class="form-group">
  <label for="uc-selector" class="form-label">
    UC (C√≥digo √önico)
    <span class="tooltip-icon ml-2" data-tooltip="Selecciona la Unidad Constructiva usando el sistema jer√°rquico">
      <i class="fas fa-info-circle text-gray-400"></i>
    </span>
  </label>
  
  <!-- Contenedor del selector jer√°rquico -->
  <div id="uc-selector-container" class="mb-4">
    <!-- El selector jer√°rquico se renderizar√° aqu√≠ -->
  </div>
  
  <!-- Campos ocultos para almacenar los valores -->
  <input type="hidden" id="uc_nueva" name="uc_nueva" value="">
  <input type="hidden" id="descripcion_uc" name="descripcion_uc" value="">
  
  <!-- Vista previa del UC seleccionado -->
  <div id="uc-preview" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="font-semibold text-blue-900">UC Seleccionado:</p>
        <p id="uc-code-display" class="text-lg font-mono text-blue-700"></p>
        <p id="uc-desc-display" class="text-sm text-gray-600 mt-1"></p>
      </div>
      <button type="button" onclick="clearUCSelection()" class="text-red-500 hover:text-red-700">
        <i class="fas fa-times-circle"></i>
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Inicializando selector UC jer√°rquico...');
    
    // Funci√≥n para inicializar el selector cuando los scripts est√©n listos
    let intentos = 0;
    const maxIntentos = 30; // 3 segundos m√°ximo
    
    function initializeUCSelector() {
        intentos++;
        
        // Solo verificar lo que realmente necesitamos: UCHierarchicalSelector y UC_HIERARCHICAL_STRUCTURE
        const scriptsListos = typeof UCHierarchicalSelector !== 'undefined' && 
                             typeof window.UC_HIERARCHICAL_STRUCTURE !== 'undefined';
        
        if (!scriptsListos && intentos < maxIntentos) {
            console.log(`‚è≥ Estructura - Intento ${intentos}: Esperando scripts UC...`, {
                UCHierarchicalSelector: typeof UCHierarchicalSelector !== 'undefined',
                UC_HIERARCHICAL_STRUCTURE: typeof window.UC_HIERARCHICAL_STRUCTURE !== 'undefined',
                intentos: intentos,
                maxIntentos: maxIntentos
            });
            setTimeout(initializeUCSelector, 100);
            return;
        }
        
        if (!scriptsListos) {
            console.warn('‚ö†Ô∏è Timeout esperando scripts UC para estructuras. Inicializando sin UC_MAPPING.');
        }
        
        // Crear UC_MAPPING vac√≠o si no existe para evitar errores
        if (typeof window.UC_MAPPING === 'undefined') {
            window.UC_MAPPING = {};
            console.log('‚úÖ UC_MAPPING creado como objeto vac√≠o');
        }
        
        console.log('‚úÖ Scripts UC cargados, inicializando selector...');
        
        // Verificar que las categor√≠as de estructuras existan
        if (window.UC_HIERARCHICAL_STRUCTURE) {
            const expectedCategories = ['N1', 'N2', 'N3', 'N4'];
            const missingCategories = expectedCategories.filter(cat => !window.UC_HIERARCHICAL_STRUCTURE[cat]);
            if (missingCategories.length > 0) {
                console.error('‚ùå Categor√≠as de estructura faltantes:', missingCategories);
                console.log('Categor√≠as disponibles:', Object.keys(window.UC_HIERARCHICAL_STRUCTURE));
            } else {
                console.log('‚úÖ Todas las categor√≠as de estructura est√°n disponibles');
            }
        }
        
        // Crear el selector jer√°rquico espec√≠fico para estructuras
        const selector = new UCHierarchicalSelector(
            'uc-selector-container',
            {
                categoryFilter: ['N1', 'N2', 'N3', 'N4'], // Solo estructuras
                onSelectionChange: (selections, category) => {
                    console.log('üîÑ Estructura - Selecci√≥n cambiada:', { selections, category });
                },
                onComplete: (result) => {
                    console.log('‚úÖ Estructura - Selecci√≥n completada:', result);
                    handleUCSelection(result);
                },
                showPreview: false,
                theme: 'modern'
            }
        );
        
        // Guardar referencia global
        window.ucSelector = selector;
        
        console.log('‚úÖ Selector UC inicializado correctamente');
    }
    
    // Manejar la selecci√≥n de UC
    function handleUCSelection(result) {
        console.log('üìã UC seleccionado:', result);
        
        // El resultado puede venir en diferentes formatos seg√∫n la versi√≥n
        const code = result.code || result.codigo || '';
        const description = result.description || result.descripcion || result.fullDescription || '';
        
        // Actualizar campos ocultos
        document.getElementById('uc_nueva').value = code;
        document.getElementById('descripcion_uc').value = description;
        
        // Mostrar vista previa
        document.getElementById('uc-code-display').textContent = code || 'N/A';
        document.getElementById('uc-desc-display').textContent = description || 'Sin descripci√≥n';
        document.getElementById('uc-preview').classList.remove('hidden');
        
        // Ocultar el selector principal temporalmente
        // document.getElementById('uc-selector-container').classList.add('hidden');
        
        console.log('‚úÖ UC actualizado en campos:', { code, description });
    }
    
    // Limpiar selecci√≥n
    window.clearUCSelection = function() {
        console.log('üîÑ Limpiando selecci√≥n UC...');
        
        // Limpiar campos
        document.getElementById('uc_nueva').value = '';
        document.getElementById('descripcion_uc').value = '';
        
        // Ocultar vista previa
        document.getElementById('uc-preview').classList.add('hidden');
        
        // Mostrar selector nuevamente
        document.getElementById('uc-selector-container').classList.remove('hidden');
        
        // Reiniciar selector si existe
        if (window.ucSelector && typeof window.ucSelector.reset === 'function') {
            window.ucSelector.reset();
        }
        
        console.log('‚úÖ Selecci√≥n UC limpiada');
    };
    
    // Funci√≥n para establecer una selecci√≥n program√°ticamente
    window.setUCSelection = function(data) {
        if (data && data.code) {
            handleUCSelection(data);
        }
    };
    
    // Iniciar cuando todo est√© listo
    initializeUCSelector();
});
</script>
<!-- Estilos adicionales espec√≠ficos para la integraci√≥n -->
<style>
#uc-selector-container {
    min-height: 400px;
    transition: all 0.3s ease;
}

#uc-preview {
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.uc-hierarchical-selector {
    border: none;
    box-shadow: none;
    padding: 0;
    background: transparent;
}

.uc-hierarchical-selector .uc-selector-header h3 {
    font-size: 1.1rem;
    margin-bottom: 15px;
}

.uc-category-card:hover {
    transform: translateY(-1px);
}

.uc-actions {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e5e7eb;
}

/* Responsive adjustments */
@media (max-width: 640px) {
    .uc-category-grid {
        grid-template-columns: 1fr;
    }
}
</style>
