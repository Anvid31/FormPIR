{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESS - Sistema de Formularios</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #f9fafb;
            font-family: 'Inter', sans-serif;
            color: #111827;
        }
        .required::after {
            content: " *";
            color: #ef4444;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        .form-input,
        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: #111827;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 150ms ease-in-out;
        }
        .form-select {
            padding-right: 2.5rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            appearance: none;
        }
        .form-input:hover,
        .form-select:hover {
            border-color: #d1d5db;
        }
        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        /* Estructura Nueva */
        .bg-emerald-50\/50 .form-input,
        .bg-emerald-50\/50 .form-select {
            border-color: #a7f3d0;
        }
        .bg-emerald-50\/50 .form-input:focus,
        .bg-emerald-50\/50 .form-select:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        /* Estructura Retirada */
        .bg-amber-50\/50 .form-input,
        .bg-amber-50\/50 .form-select {
            border-color: #fcd34d;
        }
        .bg-amber-50\/50 .form-input:focus,
        .bg-amber-50\/50 .form-select:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }
        /* Campos de solo lectura o deshabilitados */
        .form-input[readonly],
        .form-input:disabled,
        .form-select:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
            color: #6b7280;
            border-color: #e5e7eb;
        }
        /* Campos autocompletados */
        .form-input.bg-green-50,
        .form-select.bg-green-50 {
            background-color: #f0fdf4 !important;
            border-color: #bbf7d0 !important;
            color: #166534 !important;
        }
        /* Zona de arrastrar y soltar archivos */
        .file-drop-zone {
            border: 2px dashed #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 200ms ease-in-out;
        }
        .file-drop-zone:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        /* Placeholders */
        .form-input::placeholder {
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <!-- Header con fondo azul -->
    <header class="bg-blue-600 text-white py-8 px-4 mb-8">
        <div class="container mx-auto max-w-6xl">
            <h1 class="text-3xl font-bold mb-2">Sistema de Formularios DESS</h1>
            <p class="text-blue-100">Gestión de Estructuras y Postes</p>
        </div>
    </header>

    <main class="container mx-auto px-4 max-w-6xl">
    <form id="mainForm" method="post" enctype="multipart/form-data" action="{% url 'submit_form' %}">
        {% csrf_token %}
        
        <!-- Sección 1: ESTRUCTURAS DE BAJA TENSIÓN -->
        <div class="bg-white rounded-lg shadow-sm p-8 mb-8">
            <h2 class="text-xl font-semibold mb-6 flex items-center text-blue-600">
                <i class="fas fa-info-circle mr-2"></i>
                ESTRUCTURAS DE BAJA TENSIÓN
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="form-group">
                    <label class="form-label required">FECHA</label>
                    <input type="date" id="fecha" name="fecha" class="form-input" required />
                </div>
                <div class="form-group">
                    <label class="form-label required">COD. USUARIO</label>
                    <input type="text" id="cod_usuario" name="cod_usuario" 
                           class="form-input" 
                           placeholder="Código de usuario" required />
                </div>
                <div class="form-group">
                    <label class="form-label required">E.P.S</label>
                    <select id="eps" name="eps" class="form-select" required>
                        <option value="">Seleccionar EPS</option>
                        <option value="Consigna">Consigna</option>
                        <option value="Entrega">Entrega</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                    </select>
                </div>
                <!-- Resto de campos en el mismo formato de 3 columnas -->
                <div class="form-group">
                    <label class="form-label required">T. INV.</label>
                    <select id="t_inv" name="t_inv" class="form-select" required>
                        <option value="">Seleccionar</option>
                        <option value="I">I</option>
                        <option value="II">II</option>
                        <option value="III">III</option>
                        <option value="IV">IV</option>
                        <option value="V">V</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">MUNICIPIO</label>
                    <select id="municipio" name="municipio" class="form-select" required>
                        <option value="">Seleccionar municipio</option>
                        <option value="Medellín">Medellín</option>
                        <option value="Bello">Bello</option>
                        <option value="Itagüí">Itagüí</option>
                        <option value="Envigado">Envigado</option>
                        <option value="Sabaneta">Sabaneta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">NÚMERO X</label>
                    <input type="number" id="numero_x" name="numero_x" 
                           class="form-input" 
                           placeholder="1089777" />
                </div>
                <div class="form-group">
                    <label class="form-label required">REGIONAL</label>
                    <select id="regional" name="regional" class="form-select" required>
                        <option value="">Seleccionar</option>
                        <option value="Ocaña">Ocaña</option>
                        <option value="Norte">Norte</option>
                        <option value="Sur">Sur</option>
                        <option value="Oriente">Oriente</option>
                        <option value="Occidente">Occidente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">DIRECCIÓN</label>
                    <input type="text" id="direccion" name="direccion" 
                           class="form-input" 
                           placeholder="Dirección completa" required />
                </div>
                <div class="form-group">
                    <label class="form-label">NÚMERO Y</label>
                    <input type="number" id="numero_y" name="numero_y" 
                           class="form-input" 
                           placeholder="1386035" />
                </div>
                <div class="form-group">
                    <label class="form-label required">ALIMENTADOR</label>
                    <select id="alimentador" name="alimentador" class="form-select" required>
                        <option value="">Seleccionar</option>
                        <option value="OCAOCANA1">OCAOCANA1</option>
                        <option value="OCAOCANA2">OCAOCANA2</option>
                        <option value="OCAOCANA3">OCAOCANA3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">BARRIO/VEREDA</label>
                    <input type="text" id="barrio_vereda" name="barrio_vereda" 
                           class="form-input" 
                           placeholder="Nombre del barrio o vereda" required />
                </div>
                <div class="form-group">
                    <label class="form-label">NÚMERO Z</label>
                    <input type="number" id="numero_z" name="numero_z" 
                           class="form-input" 
                           placeholder="" />
                </div>
                <div class="form-group">
                    <label class="form-label required">NIVEL DE TENSIÓN</label>
                    <select id="nivel_tension" name="nivel_tension" class="form-select" required>
                        <option value="">Seleccionar</option>
                        <option value="1">1 - Baja Tensión</option>
                        <option value="2">2 - Media Tensión</option>
                        <option value="3">3 - Alta Tensión</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">CIRCUITO</label>
                    <input type="text" id="circuito" name="circuito" 
                           class="form-input" 
                           placeholder="Código del circuito" required />
                </div>
            </div>
        </div>

        <!-- Sección 2: Información de Estructuras -->
        <div class="bg-white rounded-lg shadow-sm p-8 mb-8">
            <h2 class="text-xl font-semibold mb-6 flex items-center text-blue-600">
                <i class="fas fa-building mr-2"></i>
                Información de Estructuras
            </h2>

            <!-- Estructura Nueva -->
            <div class="bg-emerald-50/50 rounded-lg border border-emerald-200 p-6 mb-6">
                <h3 class="text-lg font-semibold text-emerald-700 mb-6 flex items-center">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Estructura Nueva
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-group">
                        <label class="form-label required">COD EST.</label>
                        <input type="text" id="cod_est_nueva" name="cod_est_nueva" class="form-input focus:ring-emerald-100 focus:border-emerald-500" 
                               placeholder="Código estructura" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label required">APOYO</label>
                        <select id="apoyo_nueva" name="apoyo_nueva" 
                                class="form-select focus:ring-emerald-100 focus:border-emerald-500" 
                                required>
                            <option value="">Seleccionar</option>
                            <option value="Poste">Poste</option>
                            <option value="Estructura">Estructura</option>
                            <option value="Torrecilla">Torrecilla</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">MATERIAL</label>
                        <select id="material_nueva" name="material_nueva" 
                                class="form-select focus:ring-emerald-100 focus:border-emerald-500" 
                                required>
                            <option value="">Seleccionar</option>
                            <option value="fibra de vidrio">fibra de vidrio</option>
                            <option value="concreto">concreto</option>
                            <option value="metálico">metálico</option>
                            <option value="madera">madera</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">ALTURA</label>
                        <select id="altura_nueva" name="altura_nueva" 
                                class="form-select focus:ring-emerald-100 focus:border-emerald-500" 
                                required>
                            <option value="">Seleccionar</option>
                            <option value="8">8</option>
                            <option value="10">10</option>
                            <option value="12">12</option>
                            <option value="14">14</option>
                            <option value="16">16</option>
                            <option value="27">27</option>
                            <option value="29">29</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">POBLACIÓN</label>
                        <select id="poblacion_nueva" name="poblacion_nueva" 
                                class="form-select focus:ring-emerald-100 focus:border-emerald-500" 
                                required>
                            <option value="">Seleccionar</option>
                            <option value="urbana">urbana</option>
                            <option value="rural">rural</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">DISPOSICIÓN</label>
                        <select id="disposicion_nueva" name="disposicion_nueva" 
                                class="form-select focus:ring-emerald-100 focus:border-emerald-500" 
                                required>
                            <option value="">Seleccionar</option>
                            <option value="retención">retención</option>
                            <option value="suspensión">suspensión</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">KGF</label>
                        <select id="kgf_nueva" name="kgf_nueva" 
                                class="form-select focus:ring-emerald-100 focus:border-emerald-500" 
                                required>
                            <option value="">Seleccionar</option>
                            <option value="510">510</option>
                            <option value="750">750</option>
                            <option value="1000">1000</option>
                            <option value="1050">1050</option>
                            <option value="1350">1350</option>
                            <option value="1500">1500</option>
                            <option value="2000">2000</option>
                            <option value="3000">3000</option>
                            <option value="4000">4000</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">TIPO RED</label>
                        <select id="tipo_red_nueva" name="tipo_red_nueva" 
                                class="form-select focus:ring-emerald-100 focus:border-emerald-500" 
                                required>
                            <option value="">Seleccionar</option>
                            <option value="red común">red común</option>
                            <option value="red trenzada">red trenzada</option>
                        </select>
                    </div>
                </div>

                <!-- UC y Descripción -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="form-group md:col-span-1">
                        <label class="form-label required">UC</label>
                        <div class="relative">
                            <select id="uc_codigo" class="form-select bg-gray-50 focus:ring-emerald-100 focus:border-emerald-500" required disabled>
                                <option value="">Autocompletado</option>
                            </select>
                            <div id="uc_indicator" class="absolute right-8 top-1/2 transform -translate-y-1/2 hidden">
                                <i class="fas fa-check-circle text-green-500"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form-group md:col-span-3">
                        <label class="form-label required">DESCRIPCIÓN</label>
                        <input type="text" id="descripcion_uc" 
                               class="form-input bg-gray-50 focus:ring-emerald-100 focus:border-emerald-500" 
                               placeholder="Se autocompletará según la estructura nueva"
                               readonly />
                    </div>
                </div>

                <!-- Fotografías Estructura Nueva -->
                <div class="mt-6">
                    <label class="form-label required">Fotografías</label>
                    <div class="file-drop-zone border-emerald-300 hover:border-emerald-500 hover:bg-emerald-50/50">
                        <input type="file" id="fotos_nueva" name="fotos_nueva" class="hidden" accept="image/*" multiple required />
                        <div class="text-center">
                            <i class="fas fa-camera text-2xl text-emerald-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Arrastra las fotos aquí o haz clic para seleccionar</p>
                            <p class="text-xs text-gray-500 mt-1">Se requiere al menos 1 foto (JPG, PNG, máx. 5MB)</p>
                        </div>
                    </div>
                    <div id="preview_nueva" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 mt-4"></div>
                </div>
            </div>

            <!-- Estructura Retirada -->
            <div class="bg-amber-50/50 rounded-lg border border-amber-200 p-6 mb-6">
                <h3 class="text-lg font-semibold text-amber-700 mb-4 flex items-center">
                    <i class="fas fa-minus-circle mr-2"></i>
                    Estructura Retirada
                </h3>
                <div class="form-group max-w-md">
                    <label class="form-label">Código de Estructura</label>
                    <input type="text" id="cod_est_retirada" name="cod_est_retirada" 
                           class="form-input focus:ring-amber-100 focus:border-amber-500" 
                           placeholder="Ingrese el código de la estructura a retirar" />
                </div>
            </div>

            <!-- Botón Agregar Iteración -->
            <div class="mt-6 flex justify-end">
                <button id="addIteration" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg transition-all duration-200 
                               flex items-center gap-2 font-medium shadow-sm hover:shadow-md active:transform active:scale-95">
                    <i class="fas fa-plus-circle"></i>
                    Agregar Iteración
                </button>
            </div>
        </div>

        <!-- Sección 3: Información del Proyecto -->
        <div class="bg-white rounded-lg shadow-sm p-8 mb-8">
            <h2 class="text-xl font-semibold mb-6 flex items-center text-blue-600">
                <i class="fas fa-project-diagram mr-2"></i>
                Información del Proyecto
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="form-group">
                    <label class="form-label required">NOMBRE</label>
                    <select id="nombre" name="nombre" class="form-select" required>
                        <option value="">Seleccionar responsable</option>
                        <option value="Juan Pérez">Juan Pérez</option>
                        <option value="María González">María González</option>
                        <option value="Carlos Rodríguez">Carlos Rodríguez</option>
                        <option value="Ana Martínez">Ana Martínez</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">OT MANO OBR.</label>
                    <input type="text" id="ot_mano_obra" name="ot_mano_obra" 
                           class="form-input bg-amber-50/50" 
                           placeholder="Orden trabajo mano obra" />
                </div>
                <div class="form-group">
                    <label class="form-label">OT MATERIA.</label>
                    <input type="text" id="ot_materia" name="ot_materia" 
                           class="form-input bg-amber-50/50" 
                           placeholder="Orden trabajo material" />
                </div>
                <div class="form-group">
                    <label class="form-label required">CONTRATO</label>
                    <select id="contrato" name="contrato" class="form-select" required>
                        <option value="">Seleccionar contrato</option>
                        <option value="CONT-2025-001">CONT-2025-001</option>
                        <option value="CONT-2025-002">CONT-2025-002</option>
                        <option value="CONT-2025-003">CONT-2025-003</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">PRO.TERC.</label>
                    <select id="pro_terc" name="pro_terc" class="form-select" required>
                        <option value="">Seleccionar</option>
                        <option value="Reposición anual de postes B.T">Reposición anual de postes B.T</option>
                        <option value="Mantenimiento preventivo">Mantenimiento preventivo</option>
                        <option value="Expansión de red">Expansión de red</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">MÓVIL</label>
                    <select id="movil" name="movil" class="form-select" required>
                        <option value="">Seleccionar móvil</option>
                        <option value="MOV-001">MOV-001</option>
                        <option value="MOV-002">MOV-002</option>
                        <option value="MOV-003">MOV-003</option>
                        <option value="MOV-004">MOV-004</option>
                    </select>
                </div>
            </div>

            <!-- Proyect. con contadores -->
            <div class="mt-6">
                <label class="form-label">PROYECT.</label>
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-2">
                        <input type="number" id="instalados" name="instalados" 
                               class="form-input w-20" 
                               placeholder="0" min="0" />
                        <span class="text-sm font-medium text-gray-600">Instalados</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="pendientes" name="pendientes" 
                               class="form-input w-20 bg-red-50" 
                               placeholder="0" min="0" />
                        <span class="text-sm font-medium text-red-600">Pendientes</span>
                    </div>
                </div>
            </div>

            <!-- UC y Descripción -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="form-group md:col-span-1">
                    <label class="form-label required">UC</label>
                    <div class="relative">
                        <select id="uc_codigo_proyecto" class="form-select bg-gray-50" required disabled>
                            <option value="">Autocompletado</option>
                        </select>
                        <div id="uc_indicator_proyecto" class="absolute right-8 top-1/2 transform -translate-y-1/2 hidden">
                            <i class="fas fa-check-circle text-green-500"></i>
                        </div>
                    </div>
                </div>
                <div class="form-group md:col-span-3">
                    <label class="form-label required">DESCRIPCIÓN</label>
                    <input type="text" id="descripcion_uc_proyecto" 
                           class="form-input bg-gray-50" 
                           placeholder="Se mostrará automáticamente desde la estructura nueva"
                           readonly />
                </div>
            </div>
        </div>

        <!-- Resto del formulario -->
        <!-- Sección 4: Documentos -->
        <div class="bg-white rounded-lg shadow-sm p-8 mb-8">
            <h2 class="text-xl font-semibold mb-6 flex items-center text-blue-600">
                <i class="fas fa-file-alt mr-2"></i>
                Documentos y Archivos
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- AutoCAD -->
                <div class="space-y-4">
                    <label class="form-label required">Archivo AutoCAD</label>
                    <div class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50">
                        <input type="file" id="archivo_cad" name="archivo_cad" class="hidden" accept=".dwg,.dxf,.dws" required />
                        <div class="text-center">
                            <i class="fas fa-drafting-compass text-2xl text-blue-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Cargar archivo AutoCAD</p>
                            <p class="text-xs text-gray-500 mt-1">.dwg, .dxf, .dws (máx. 50MB)</p>
                        </div>
                    </div>
                    <!-- Preview AutoCAD -->
                    <div id="cad_preview" class="hidden">
                        <div class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                            <div class="flex-grow">
                                <p class="text-sm font-medium text-gray-900" id="cad_filename">archivo.dwg</p>
                                <p class="text-xs text-gray-500" id="cad_filesize">2.5 MB</p>
                            </div>
                            <button type="button" class="text-gray-400 hover:text-red-500 transition-colors" id="cad_remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- KMZ -->
                <div class="space-y-4">
                    <label class="form-label required">Archivo KMZ</label>
                    <div class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50">
                        <input type="file" id="archivo_kmz" name="archivo_kmz" class="hidden" accept=".kmz" required />
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt text-2xl text-blue-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Cargar archivo KMZ</p>
                            <p class="text-xs text-gray-500 mt-1">.kmz (máx. 50MB)</p>
                        </div>
                    </div>
                    <!-- Preview KMZ -->
                    <div id="kmz_preview" class="hidden">
                        <div class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                            <div class="flex-grow">
                                <p class="text-sm font-medium text-gray-900" id="kmz_filename">archivo.kmz</p>
                                <p class="text-xs text-gray-500" id="kmz_filesize">1.2 MB</p>
                            </div>
                            <button type="button" class="text-gray-400 hover:text-red-500 transition-colors" id="kmz_remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>         
        </div>

    <!-- Mover la tabla de iteraciones aquí -->
    <div class="bg-white rounded-lg shadow-sm p-8 mb-8">
        <h2 class="text-xl font-semibold mb-6 flex items-center text-blue-600">
            <i class="fas fa-table mr-2"></i>
            Registro de Iteraciones
        </h2>
        
        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th colspan="4" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50">
                            Estructura Retirada
                        </th>
                        <th colspan="6" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50">
                            Estructura Nueva
                        </th>
                        <th rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Acciones
                        </th>
                    </tr>
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50">Código</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50">Material</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50">Altura</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50">Fotos</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50">Código</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50">Material</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50">Altura</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50">Apoyo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50">UC</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50">Fotos</th>
                    </tr>
                </thead>
                <tbody id="iterationTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Las filas se agregarán dinámicamente aquí -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Botones de acción -->
    <div class="flex justify-end gap-4 mt-8">
        <a href="{% url 'form_list' %}" 
           class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 
                  transition-colors flex items-center gap-2">
            <i class="fas fa-list"></i>
            Ver Formularios
        </a>
        <button type="submit" id="submitFinal"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 
                       transition-colors flex items-center gap-2">
            <i class="fas fa-paper-plane"></i>
            Enviar Formulario
        </button>
    </div>
    
    </form>
    </main>

    <!-- Incluir el archivo de mapping de UCs -->
    <script src="{% static 'js/uc-mapping.js' %}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar que el mapping UC esté disponible
            if (typeof UC_MAPPING === 'undefined' || typeof getUCFromStructure === 'undefined') {
                console.error('Error: uc-mapping.js no se cargó correctamente');
                alert('Error al cargar el sistema de códigos UC. Por favor recarga la página.');
                return;
            }
            
            console.log('UC Mapping cargado correctamente:', Object.keys(UC_MAPPING).length, 'códigos disponibles');
            
            // Variables globales
            const ucSelect = document.getElementById('uc_codigo');
            const descripcionUc = document.getElementById('descripcion_uc');
            const ucSelectProyecto = document.getElementById('uc_codigo_proyecto');
            const descripcionUcProyecto = document.getElementById('descripcion_uc_proyecto');

            // Llenar el select de UC con el mapping completo (pero mantenlo disabled)
            for (const [codigo, descripcion] of Object.entries(UC_MAPPING)) {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = codigo;
                ucSelect.appendChild(option);
                
                // También llenar el select del proyecto
                const optionProyecto = document.createElement('option');
                optionProyecto.value = codigo;
                optionProyecto.textContent = codigo;
                ucSelectProyecto.appendChild(optionProyecto);
            }

            // Auto-completar UC basado en selecciones de estructura nueva
            function autoCompleteUC() {
                const material = document.getElementById('material_nueva').value;
                const altura = document.getElementById('altura_nueva').value;
                const poblacion = document.getElementById('poblacion_nueva').value;
                const disposicion = document.getElementById('disposicion_nueva').value;
                const tipoRed = document.getElementById('tipo_red_nueva').value;

                console.log('AutoComplete UC - Valores:', { material, altura, poblacion, disposicion, tipoRed });

                // Autocompletar cuando se llenen algunos campos clave
                if (material && altura && poblacion && disposicion && tipoRed) {
                    const suggestedUC = getUCFromStructure(material, altura, poblacion, disposicion, tipoRed);
                    console.log('UC sugerido:', suggestedUC);
                    
                    if (suggestedUC) {
                        // Autocompletar en la sección de estructura nueva
                        ucSelect.disabled = false;
                        ucSelect.value = suggestedUC;
                        descripcionUc.value = UC_MAPPING[suggestedUC];
                        ucSelect.disabled = true;
                        
                        // Agregar clase visual para indicar que está autocompletado
                        ucSelect.classList.add('bg-green-50', 'border-green-300');
                        descripcionUc.classList.add('bg-green-50', 'border-green-300');
                        
                        // Mostrar indicador visual
                        document.getElementById('uc_indicator').classList.remove('hidden');
                        
                        // También autocompletar en la sección del proyecto
                        ucSelectProyecto.disabled = false;
                        ucSelectProyecto.value = suggestedUC;
                        descripcionUcProyecto.value = UC_MAPPING[suggestedUC];
                        ucSelectProyecto.disabled = true;
                        
                        // Agregar clase visual para el proyecto
                        ucSelectProyecto.classList.add('bg-green-50', 'border-green-300');
                        descripcionUcProyecto.classList.add('bg-green-50', 'border-green-300');
                        
                        // Mostrar indicador visual del proyecto
                        document.getElementById('uc_indicator_proyecto').classList.remove('hidden');
                        
                        console.log('UC autocompletado exitosamente:', suggestedUC, UC_MAPPING[suggestedUC]);
                    } else {
                        console.log('No se encontró UC para la combinación:', { material, altura, poblacion, disposicion, tipoRed });
                    }
                } else {
                    // Si no todos los campos están llenos, limpiar UC
                    ucSelect.value = '';
                    descripcionUc.value = '';
                    ucSelect.classList.remove('bg-green-50', 'border-green-300');
                    descripcionUc.classList.remove('bg-green-50', 'border-green-300');
                    
                    // Limpiar también el proyecto
                    ucSelectProyecto.value = '';
                    descripcionUcProyecto.value = '';
                    ucSelectProyecto.classList.remove('bg-green-50', 'border-green-300');
                    descripcionUcProyecto.classList.remove('bg-green-50', 'border-green-300');
                    
                    // Ocultar indicadores visuales
                    document.getElementById('uc_indicator').classList.add('hidden');
                    document.getElementById('uc_indicator_proyecto').classList.add('hidden');
                }
            }

            // Agregar listeners a los campos de estructura nueva para auto-completar UC
            ['material_nueva', 'altura_nueva', 'poblacion_nueva', 'disposicion_nueva', 'tipo_red_nueva'].forEach(id => {
                document.getElementById(id).addEventListener('change', autoCompleteUC);
            });
            
            // Setup file upload for estructura nueva
            setupFileDropZone('fotos_nueva', 'preview_nueva', true);
            
            // Setup file uploads for documentos
            setupFileDropZone('archivo_cad', 'cad_preview', false);
            setupFileDropZone('archivo_kmz', 'kmz_preview', false);

            // Función para configurar zonas de drag & drop
            function setupFileDropZone(inputId, previewId, isImage) {
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);
                const dropZone = input.closest('.file-drop-zone');

                if (!dropZone) return;

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-blue-500', 'bg-blue-50/50');
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('border-blue-500', 'bg-blue-50/50');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-blue-500', 'bg-blue-50/50');
                    handleFiles(e.dataTransfer.files, isImage, preview, input);
                });

                dropZone.addEventListener('click', () => input.click());
                input.addEventListener('change', () => handleFiles(input.files, isImage, preview, input));
            }

            // Función para manejar archivos cargados
            function handleFiles(files, isImage, preview, input) {
                if (isImage) {
                    handleImageFiles(files, preview);
                } else {
                    handleDocumentFile(files[0], preview);
                }
            }

            // Función para manejar imágenes
            function handleImageFiles(files, preview) {
                preview.innerHTML = '';
                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/') && file.size <= 5 * 1024 * 1024) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const div = document.createElement('div');
                            div.className = 'relative group';
                            div.innerHTML = `
                                <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg" />
                                <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-xs" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            preview.appendChild(div);
                        };
                        reader.readAsDataURL(file);
                    } else if (file.size > 5 * 1024 * 1024) {
                        alert('La imagen ' + file.name + ' excede el tamaño máximo de 5MB');
                    }
                });
            }

            // Función para manejar documentos
            function handleDocumentFile(file, preview) {
                if (!file) return;
                
                const previewId = preview.id;
                const filename = document.getElementById(previewId.replace('preview', 'filename'));
                const filesize = document.getElementById(previewId.replace('preview', 'filesize'));
                const removeBtn = document.getElementById(previewId.replace('preview', 'remove'));
                
                if (filename) filename.textContent = file.name;
                if (filesize) filesize.textContent = formatFileSize(file.size);
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        preview.classList.add('hidden');
                        const input = document.getElementById(previewId.replace('_preview', ''));
                        if (input) input.value = '';
                    });
                }
                
                preview.classList.remove('hidden');
            }

            // Función para formatear tamaño de archivo
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Función para agregar iteración a la tabla
            function addIterationToTable(iteration) {
                const tbody = document.getElementById('iterationTableBody');
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${iteration.estructura_retirada_codigo || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_retirada_material || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_retirada_altura ? iteration.estructura_retirada_altura + 'm' : '-'}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            ${iteration.estructura_retirada_fotos && iteration.estructura_retirada_fotos.length > 0 ? 
                                iteration.estructura_retirada_fotos.map(foto => 
                                    `<img src="${foto}" class="w-12 h-12 object-cover rounded border" />`
                                ).join('') : '<span class="text-gray-400 text-xs">Sin fotos</span>'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${iteration.estructura_nueva_codigo || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_nueva_material || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_nueva_altura ? iteration.estructura_nueva_altura + 'm' : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_nueva_apoyo || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">
                        ${iteration.estructura_nueva_uc || '-'}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            ${iteration.estructura_nueva_fotos && iteration.estructura_nueva_fotos.length > 0 ? 
                                iteration.estructura_nueva_fotos.map(foto => 
                                    `<img src="${foto}" class="w-12 h-12 object-cover rounded border" />`
                                ).join('') : '<span class="text-gray-400 text-xs">Sin fotos</span>'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="removeIteration('${iteration.id}')" class="text-red-600 hover:text-red-900 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            }

            // Event Listener para el botón de agregar iteración
            document.getElementById('addIteration').addEventListener('click', function() {
                // Recopilar datos de estructura nueva
                const estructuraNueva = {
                    codigo_estructura: document.getElementById('cod_est_nueva').value,
                    apoyo: document.getElementById('apoyo_nueva').value,
                    material: document.getElementById('material_nueva').value,
                    altura: document.getElementById('altura_nueva').value,
                    poblacion: document.getElementById('poblacion_nueva').value,
                    disposicion: document.getElementById('disposicion_nueva').value,
                    kgf: document.getElementById('kgf_nueva').value,
                    tipo_red: document.getElementById('tipo_red_nueva').value,
                    uc: document.getElementById('uc_codigo').value,
                    fotos: Array.from(document.getElementById('fotos_nueva').files)
                };

                // Recopilar datos de estructura retirada
                const estructuraRetirada = {
                    codigo: document.getElementById('cod_est_retirada').value,
                    // Datos adicionales que podrían estar en otros campos (para futuras expansiones)
                    material: '', // Se puede agregar campo si es necesario
                    altura: ''    // Se puede agregar campo si es necesario
                };

                // Validar que se tengan los datos mínimos requeridos
                if (!estructuraNueva.uc) {
                    alert('Por favor complete todos los campos de estructura nueva para generar el código UC automáticamente');
                    return;
                }

                if (estructuraNueva.fotos.length === 0) {
                    alert('Por favor agregue al menos una foto de la estructura nueva');
                    return;
                }

                // Crear objeto de iteración con todos los datos
                const iteration = {
                    id: Date.now().toString(),
                    // Datos de estructura nueva
                    estructura_nueva_codigo: estructuraNueva.codigo_estructura,
                    estructura_nueva_apoyo: estructuraNueva.apoyo,
                    estructura_nueva_material: estructuraNueva.material,
                    estructura_nueva_altura: estructuraNueva.altura,
                    estructura_nueva_poblacion: estructuraNueva.poblacion,
                    estructura_nueva_disposicion: estructuraNueva.disposicion,
                    estructura_nueva_kgf: estructuraNueva.kgf,
                    estructura_nueva_tipo_red: estructuraNueva.tipo_red,
                    estructura_nueva_uc: estructuraNueva.uc,
                    estructura_nueva_fotos: [],
                    // Datos de estructura retirada
                    estructura_retirada_codigo: estructuraRetirada.codigo,
                    estructura_retirada_material: estructuraRetirada.material,
                    estructura_retirada_altura: estructuraRetirada.altura,
                    estructura_retirada_fotos: []
                };

                // Procesar fotos de estructura nueva
                Array.from(estructuraNueva.fotos).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        iteration.estructura_nueva_fotos.push(e.target.result);
                        
                        // Si es la última foto, agregar a tabla
                        if (index === estructuraNueva.fotos.length - 1) {
                            addIterationToTable(iteration);
                            
                            // Limpiar formulario
                            clearForm();
                        }
                    };
                    reader.readAsDataURL(file);
                });
            });

            // Función para limpiar el formulario después de agregar iteración
            function clearForm() {
                // Limpiar estructura nueva
                document.getElementById('cod_est_nueva').value = '';
                document.getElementById('apoyo_nueva').value = '';
                document.getElementById('material_nueva').value = '';
                document.getElementById('altura_nueva').value = '';
                document.getElementById('poblacion_nueva').value = '';
                document.getElementById('disposicion_nueva').value = '';
                document.getElementById('kgf_nueva').value = '';
                document.getElementById('tipo_red_nueva').value = '';
                document.getElementById('fotos_nueva').value = '';
                document.getElementById('preview_nueva').innerHTML = '';
                
                // Limpiar estructura retirada
                document.getElementById('cod_est_retirada').value = '';
                
                // Limpiar UC y restaurar estado deshabilitado
                document.getElementById('uc_codigo').value = '';
                document.getElementById('descripcion_uc').value = '';
                document.getElementById('uc_codigo').classList.remove('bg-green-50', 'border-green-300');
                document.getElementById('descripcion_uc').classList.remove('bg-green-50', 'border-green-300');
                document.getElementById('uc_codigo').disabled = true;
                
                // Ocultar indicador visual
                document.getElementById('uc_indicator').classList.add('hidden');
            }

            // Función global para remover iteración
            window.removeIteration = function(iterationId) {
                if (confirm('¿Está seguro de eliminar esta iteración?')) {
                    // Remover de la tabla
                    const row = document.querySelector(`[onclick*="${iterationId}"]`).closest('tr');
                    if (row) row.remove();
                }
            };

            // Event listeners para envío
            document.getElementById('submitFinal').addEventListener('click', function(e) {
                e.preventDefault();
                if (validateFormData()) {
                    // Mostrar loading
                    const submitBtn = document.getElementById('submitFinal');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                    submitBtn.disabled = true;
                    
                    // Enviar formulario de manera tradicional
                    document.getElementById('mainForm').submit();
                }
            });

            // Función para validar datos del formulario
            function validateFormData() {
                const requiredFields = [
                    'fecha', 'cod_usuario', 'eps', 't_inv', 'municipio', 
                    'regional', 'direccion', 'alimentador', 'barrio_vereda',
                    'nivel_tension', 'circuito', 'nombre', 'contrato', 
                    'pro_terc', 'movil', 'uc_codigo'
                ];

                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        alert(`Por favor complete el campo: ${field.previousElementSibling.textContent}`);
                        field.focus();
                        return false;
                    }
                }

                // Validar que hay al menos una foto de estructura nueva
                const fotosNueva = document.getElementById('fotos_nueva').files;
                if (fotosNueva.length === 0) {
                    alert('Por favor agregue al menos una foto de la estructura nueva');
                    return false;
                }

                // Validar archivos CAD y KMZ
                const archivoCad = document.getElementById('archivo_cad').files[0];
                const archivoKmz = document.getElementById('archivo_kmz').files[0];
                if (!archivoCad) {
                    alert('Por favor seleccione un archivo AutoCAD');
                    return false;
                }
                if (!archivoKmz) {
                    alert('Por favor seleccione un archivo KMZ');
                    return false;
                }

                return true;
            }

            // Función para obtener CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>
