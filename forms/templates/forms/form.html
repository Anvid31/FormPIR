{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DESS - Sistema de Formularios</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'forms/css/form.css' %}" />
  </head>
  <body>
    <!-- Header con fondo azul -->
    <header class="bg-blue-600 text-white py-8 px-4 mb-8">
      <div class="container mx-auto max-w-6xl">
        <h1 class="text-3xl font-bold mb-2">Sistema de Formularios DESS</h1>
        <p class="text-blue-100">Gestión de aaa y Postes</p>
      </div>
    </header>

    <main class="container mx-auto px-4 max-w-6xl">
      <!-- Navbar de navegación circular compacto - FUERA del formulario -->
      <div class="container mx-auto px-4 max-w-6xl mb-6">
        <div class="bg-white rounded-xl shadow-md p-6">
          <div
            class="flex flex-col lg:flex-row items-center justify-between space-y-6 lg:space-y-0"
          >
            <!-- Paso 1: ESTRUCTURAS N1-N2-N3 -->
            <div class="flex flex-col items-center group">
              <div
                class="nav-item active w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mb-3 cursor-pointer shadow-lg transition-all duration-300 hover:scale-105"
                data-step="estructuras"
                onclick="navigateToStep('estructuras')"
              >
                <i class="fas fa-building text-white text-lg"></i>
              </div>
              <div
                class="nav-step active px-3 py-1.5 rounded-full text-xs font-medium text-center min-w-max"
              >
                <div class="font-semibold">ESTRUCTURAS</div>
                <div class="text-xs opacity-75">N1-N2-N3</div>
              </div>
            </div>

            <!-- Línea de progreso 1 -->
            <div class="hidden lg:block flex-1 mx-4">
              <div
                class="progress-line h-0.5 rounded-full bg-gray-300"
                data-connection="estructuras-conductor_n1"
              ></div>
            </div>

            <!-- Paso 2: CONDUCTOR N1 -->
            <div class="flex flex-col items-center group">
              <div
                class="nav-item w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center mb-3 cursor-pointer shadow-lg transition-all duration-300 hover:scale-105 hover:bg-yellow-400"
                data-step="conductor_n1"
                onclick="navigateToStep('conductor_n1')"
              >
                <i class="fas fa-bolt text-gray-600 text-lg"></i>
              </div>
              <div
                class="nav-step px-3 py-1.5 rounded-full text-xs font-medium text-center min-w-max"
              >
                <div class="font-semibold">CONDUCTOR</div>
                <div class="text-xs opacity-75">N1</div>
              </div>
            </div>

            <!-- Línea de progreso 2 -->
            <div class="hidden lg:block flex-1 mx-4">
              <div
                class="progress-line h-0.5 rounded-full bg-gray-300"
                data-connection="conductor_n1-conductor_n2_n3"
              ></div>
            </div>

            <!-- Paso 3: CONDUCTOR N2-N3 -->
            <div class="flex flex-col items-center group">
              <div
                class="nav-item w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center mb-3 cursor-pointer shadow-lg transition-all duration-300 hover:scale-105 hover:bg-orange-400"
                data-step="conductor_n2_n3"
                onclick="navigateToStep('conductor_n2_n3')"
              >
                <i class="fas fa-bolt text-gray-600 text-lg"></i>
              </div>
              <div
                class="nav-step px-3 py-1.5 rounded-full text-xs font-medium text-center min-w-max"
              >
                <div class="font-semibold">CONDUCTOR</div>
                <div class="text-xs opacity-75">N2-N3</div>
              </div>
            </div>

            <!-- Línea de progreso 3 -->
            <div class="hidden lg:block flex-1 mx-4">
              <div
                class="progress-line h-0.5 rounded-full bg-gray-300"
                data-connection="conductor_n2_n3-equipos"
              ></div>
            </div>

            <!-- Paso 4: EQUIPOS PROTECCIÓN -->
            <div class="flex flex-col items-center group">
              <div
                class="nav-item w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center mb-3 cursor-pointer shadow-lg transition-all duration-300 hover:scale-105 hover:bg-green-400"
                data-step="equipos"
                onclick="navigateToStep('equipos')"
              >
                <i class="fas fa-shield-alt text-gray-600 text-lg"></i>
              </div>
              <div
                class="nav-step px-3 py-1.5 rounded-full text-xs font-medium text-center min-w-max"
              >
                <div class="font-semibold">EQUIPOS</div>
                <div class="text-xs opacity-75">PROTECCIÓN</div>
              </div>
            </div>

            <!-- Línea de progreso 4 -->
            <div class="hidden lg:block flex-1 mx-4">
              <div
                class="progress-line h-0.5 rounded-full bg-gray-300"
                data-connection="equipos-transformador"
              ></div>
            </div>

            <!-- Paso 5: TRANSFORMADOR DISTRIBUCIÓN -->
            <div class="flex flex-col items-center group">
              <div
                class="nav-item w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center mb-3 cursor-pointer shadow-lg transition-all duration-300 hover:scale-105 hover:bg-purple-400"
                data-step="transformador"
                onclick="navigateToStep('transformador')"
              >
                <i class="fas fa-microchip text-gray-600 text-lg"></i>
              </div>
              <div
                class="nav-step px-3 py-1.5 rounded-full text-xs font-medium text-center min-w-max"
              >
                <div class="font-semibold">TRANSFORMADOR</div>
                <div class="text-xs opacity-75">DISTRIBUCIÓN</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <form
        id="mainForm"
        method="post"
        enctype="multipart/form-data"
        action="{% url 'submit_form' %}"
      >
        {% csrf_token %}

        <!-- Sección 3: Información del Proyecto -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="estructuras"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-project-diagram mr-2"></i>
            Información del Proyecto
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="form-group">
              <label class="form-label required"
                >NOMBRE DEL PROYECTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Selecciona el proyecto específico al que pertenece esta
                    estructura. El proyecto determina el banco y los contratos
                    disponibles.
                  </span>
                </span>
              </label>
              <select id="nombre" name="nombre" class="form-select" required>
                <option value="">Seleccionar proyecto</option>
                <option value="Automatización de redes distribución CENS">
                  Automatización de redes distribución CENS
                </option>
                <option value="Compra de bien futuro">
                  Compra de bien futuro
                </option>
                <option value="Electrificación Rural CENS">
                  Electrificación Rural CENS
                </option>
                <option value="Expansión redes de distribución CENS">
                  Expansión redes de distribución CENS
                </option>
                <option value="Gestión y control pérdidas de energía - CENS">
                  Gestión y control pérdidas de energía - CENS
                </option>
                <option value="Mantenimiento redes de distribución">
                  Mantenimiento redes de distribución
                </option>
                <option value="Mantenimiento redes de distribución - MIT">
                  Mantenimiento redes de distribución - MIT
                </option>
                <option
                  value="Normalización subestación Sevilla 115/34.5 kV e interconexión a 115 kV"
                >
                  Normalización subestación Sevilla 115/34.5 kV e interconexión
                  a 115 kV
                </option>
                <option value="Nueva línea INSC77 - Guaduas 34.5 kV">
                  Nueva línea INSC77 - Guaduas 34.5 kV
                </option>
                <option value="Nuevo Alimentador Gabarra">
                  Nuevo Alimentador Gabarra
                </option>
                <option value="Reconfiguración Planta Zulia 13.8kV">
                  Reconfiguración Planta Zulia 13.8kV
                </option>
                <option value="Reposición redes de distribución CENS">
                  Reposición redes de distribución CENS
                </option>
                <option value="Reposición transformadores distribución CENS">
                  Reposición transformadores distribución CENS
                </option>
                <option value="Repotenciación de líneas CENS 115 kV">
                  Repotenciación de líneas CENS 115 kV
                </option>
                <option value="Reposición subestaciones y líneas CENS">
                  Reposición subestaciones y líneas CENS
                </option>
                <option
                  value="Expansión y normalización de subestaciones media tensión."
                >
                  Expansión y normalización de subestaciones media tensión.
                </option>
                <option value="Nueva subestación La Playa 34.5/13.8 kV">
                  Nueva subestación La Playa 34.5/13.8 kV
                </option>
                <option value="Gestión de Activos CENS">
                  Gestión de Activos CENS
                </option>
                <option value="Activos de Uso propiedad de Terceros">
                  Activos de Uso propiedad de Terceros
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label"
                >BANCO DEL PROYECTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Código del banco asociado al proyecto. Se autocompletará
                    automáticamente cuando selecciones un proyecto.
                  </span>
                </span>
              </label>
              <input
                type="text"
                id="banco_proyecto"
                name="banco_proyecto"
                class="form-input bg-gray-50"
                placeholder="Se autocompletará según el proyecto"
                readonly
              />
            </div>
            <div class="form-group">
              <label class="form-label required"
                >CONTRATO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Contrato específico del proyecto. Determina qué municipios
                    estarán disponibles según la regional asignada.
                  </span>
                </span>
              </label>
              <select
                id="contrato"
                name="contrato"
                class="form-select"
                required
              >
                <option value="">Seleccionar contrato</option>
                <option value="CONT-2025-001">CONT-2025-001</option>
                <option value="CONT-2025-002">CONT-2025-002</option>
                <option value="CONT-2025-003">CONT-2025-003</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Sección: Documentos y Archivos -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="estructuras"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-file-alt mr-2"></i>
            Documentos y Archivos
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- AutoCAD -->
            <div class="space-y-4">
              <label class="form-label required"
                >Archivo AutoCAD
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Archivo de diseño técnico en formato AutoCAD (.dwg, .dxf,
                    .dws). Debe contener el plano de la estructura. Tamaño
                    máximo: 50MB.
                  </span>
                </span>
              </label>
              <div
                class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50"
              >
                <input
                  type="file"
                  id="archivo_cad"
                  name="archivo_cad"
                  class="hidden"
                  accept=".dwg,.dxf,.dws"
                  required
                />
                <div class="text-center">
                  <i
                    class="fas fa-drafting-compass text-2xl text-blue-400 mb-2"
                  ></i>
                  <p class="text-sm text-gray-600">Cargar archivo AutoCAD</p>
                  <p class="text-xs text-gray-500 mt-1">
                    .dwg, .dxf, .dws (máx. 50MB)
                  </p>
                </div>
              </div>
              <!-- Preview AutoCAD -->
              <div id="cad_preview" class="hidden">
                <div
                  class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                  <div class="flex-grow">
                    <p
                      class="text-sm font-medium text-gray-900"
                      id="cad_filename"
                    >
                      archivo.dwg
                    </p>
                    <p class="text-xs text-gray-500" id="cad_filesize">
                      2.5 MB
                    </p>
                  </div>
                  <button
                    type="button"
                    class="text-gray-400 hover:text-red-500 transition-colors"
                    id="cad_remove"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- KMZ -->
            <div class="space-y-4">
              <label class="form-label required"
                >Archivo KMZ
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Archivo de geolocalización en formato KMZ de Google Earth.
                    Contiene la ubicación exacta del proyecto. Tamaño máximo:
                    50MB.
                  </span>
                </span>
              </label>
              <div
                class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50"
              >
                <input
                  type="file"
                  id="archivo_kmz"
                  name="archivo_kmz"
                  class="hidden"
                  accept=".kmz"
                  required
                />
                <div class="text-center">
                  <i
                    class="fas fa-map-marked-alt text-2xl text-blue-400 mb-2"
                  ></i>
                  <p class="text-sm text-gray-600">Cargar archivo KMZ</p>
                  <p class="text-xs text-gray-500 mt-1">.kmz (máx. 50MB)</p>
                </div>
              </div>
              <!-- Preview KMZ -->
              <div id="kmz_preview" class="hidden">
                <div
                  class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                  <div class="flex-grow">
                    <p
                      class="text-sm font-medium text-gray-900"
                      id="kmz_filename"
                    >
                      archivo.kmz
                    </p>
                    <p class="text-xs text-gray-500" id="kmz_filesize">
                      1.2 MB
                    </p>
                  </div>
                  <button
                    type="button"
                    class="text-gray-400 hover:text-red-500 transition-colors"
                    id="kmz_remove"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección 1: ESTRUCTURAS DE BAJA TENSIÓN -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="estructuras"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-bolt mr-2"></i>
            Información Tecnica
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="form-group">
              <label class="form-label required"
                >FECHA DE INSTALACION
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Fecha en la que se instaló. No puede ser posterior a la
                    fecha actual.
                  </span>
                </span>
              </label>
              <input
                type="date"
                id="fecha"
                name="fecha"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >NIVEL DE TENSIÓN
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Nivel de tensión eléctrica: 1-Baja Tensión (hasta 1kV),
                    2-Media Tensión (1-35kV), 3-Alta Tensión (mayor a 35kV).
                  </span>
                </span>
              </label>
              <select
                id="nivel_tension"
                name="nivel_tension"
                class="form-select"
                required
              >
                <option value="">Seleccionar</option>
                <option value="1">1 - Baja Tensión</option>
                <option value="2">2 - Media Tensión</option>
                <option value="3">3 - Alta Tensión</option>
              </select>
            </div>

            <!-- Resto de campos en el mismo formato de 3 columnas -->
            <div class="form-group">
              <label class="form-label required"
                >TIPO DE INVERSION
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Tipo de inversión: I y III requieren estructura retirada, II
                    y IV son instalaciones nuevas sin retirar estructura
                    existente.
                  </span>
                </span>
              </label>
              <select id="t_inv" name="t_inv" class="form-select" required>
                <option value="">Seleccionar</option>
                <option value="I">I</option>
                <option value="II">II</option>
                <option value="III">III</option>
                <option value="IV">IV</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label"
                >ESTRUCTURA RETIRADA
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Código de la estructura que se retira. Solo se habilita para
                    tipos de inversión I y III. Debe empezar con "Z" seguido de
                    números.
                  </span>
                </span>
              </label>
              <input
                type="text"
                id="estructura_retirada_campo"
                name="estructura_retirada_campo"
                class="form-input bg-yellow-50"
                placeholder="Z10000"
                disabled
              />
            </div>

            <!-- Campos de coordenadas -->
            <div class="md:col-span-3">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="form-group">
                  <label class="form-label required" id="longitud_label"
                    >LONGITUD
                    <span class="tooltip">
                      <i class="fas fa-question-circle help-icon"></i>
                      <span class="tooltip-content" id="longitud_tooltip">
                        Coordenada X (Longitud) de la ubicación exacta de la
                        estructura en el sistema de coordenadas MAGNA-SIRGAS.
                        Rango válido: 800,000 - 1,300,000.
                      </span>
                    </span>
                  </label>
                  <input
                    type="number"
                    id="numero_x"
                    name="numero_x"
                    class="form-input"
                    placeholder="1089777"
                    min="800000"
                    max="1300000"
                    step="0.001"
                    oninput="validateCoordinate(this, 'x')"
                  />
                  <div
                    id="numero_x_error"
                    class="error-message"
                    style="display: none"
                  ></div>
                </div>
                <div class="form-group">
                  <label class="form-label required" id="latitud_label"
                    >LATITUD
                    <span class="tooltip">
                      <i class="fas fa-question-circle help-icon"></i>
                      <span class="tooltip-content" id="latitud_tooltip">
                        Coordenada Y (Latitud) de la ubicación exacta de la
                        estructura en el sistema de coordenadas MAGNA-SIRGAS.
                        Rango válido: 1,000,000 - 1,600,000.
                      </span>
                    </span>
                  </label>
                  <input
                    type="number"
                    id="numero_y"
                    name="numero_y"
                    class="form-input"
                    placeholder="1386035"
                    min="1000000"
                    max="1600000"
                    step="0.001"
                    oninput="validateCoordinate(this, 'y')"
                  />
                  <div
                    id="numero_y_error"
                    class="error-message"
                    style="display: none"
                  ></div>
                </div>

                <!-- Campos adicionales para coordenadas finales - solo visibles en conductor, equipos y transformador -->
                <div
                  class="form-group"
                  id="longitud_final_group"
                  style="display: none"
                >
                  <label class="form-label required"
                    >LONGITUD FINAL
                    <span class="tooltip">
                      <i class="fas fa-question-circle help-icon"></i>
                      <span class="tooltip-content">
                        Coordenada X (Longitud Final) en el sistema de
                        coordenadas MAGNA-SIRGAS. Rango válido: 800,000 -
                        1,300,000.
                      </span>
                    </span>
                  </label>
                  <input
                    type="number"
                    id="numero_x_final"
                    name="numero_x_final"
                    class="form-input"
                    placeholder="1089777"
                    min="800000"
                    max="1300000"
                    step="0.001"
                    oninput="validateCoordinate(this, 'x_final')"
                  />
                  <div
                    id="numero_x_final_error"
                    class="error-message"
                    style="display: none"
                  ></div>
                </div>
                <div
                  class="form-group"
                  id="latitud_final_group"
                  style="display: none"
                >
                  <label class="form-label required"
                    >LATITUD FINAL
                    <span class="tooltip">
                      <i class="fas fa-question-circle help-icon"></i>
                      <span class="tooltip-content">
                        Coordenada Y (Latitud Final) en el sistema de
                        coordenadas MAGNA-SIRGAS. Rango válido: 1,000,000 -
                        1,600,000.
                      </span>
                    </span>
                  </label>
                  <input
                    type="number"
                    id="numero_y_final"
                    name="numero_y_final"
                    class="form-input"
                    placeholder="1386035"
                    min="1000000"
                    max="1600000"
                    step="0.001"
                    oninput="validateCoordinate(this, 'y_final')"
                  />
                  <div
                    id="numero_y_final_error"
                    class="error-message"
                    style="display: none"
                  ></div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label required"
                >MUNICIPIO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Municipio donde se ubica la estructura. La lista se filtra
                    automáticamente según el contrato seleccionado.
                  </span>
                </span>
              </label>
              <select
                id="municipio"
                name="municipio"
                class="form-select"
                required
              >
                <option value="">Seleccionar municipio</option>
                <option value="ÁBREGO">ÁBREGO</option>
                <option value="AGUACHICA">AGUACHICA</option>
                <option value="ARBOLEDAS">ARBOLEDAS</option>
                <option value="BOCHALEMA">BOCHALEMA</option>
                <option value="BUCARASICA">BUCARASICA</option>
                <option value="CÁCHIRA">CÁCHIRA</option>
                <option value="CÁCOTA">CÁCOTA</option>
                <option value="CHINÁCOTA">CHINÁCOTA</option>
                <option value="CHITAGÁ">CHITAGÁ</option>
                <option value="CONCEPCION">CONCEPCION</option>
                <option value="CONVENCIÓN">CONVENCIÓN</option>
                <option value="CÚCUTA">CÚCUTA</option>
                <option value="CUCUTILLA">CUCUTILLA</option>
                <option value="DURANIA">DURANIA</option>
                <option value="EL CARMEN">EL CARMEN</option>
                <option value="EL TARRA">EL TARRA</option>
                <option value="EL ZULIA">EL ZULIA</option>
                <option value="GAMARRA">GAMARRA</option>
                <option value="GONZALEZ">GONZALEZ</option>
                <option value="GRAMALOTE">GRAMALOTE</option>
                <option value="HACARÍ">HACARÍ</option>
                <option value="HERRÁN">HERRÁN</option>
                <option value="LA ESPERANZA">LA ESPERANZA</option>
                <option value="LA GLORIA">LA GLORIA</option>
                <option value="LA PLAYA">LA PLAYA</option>
                <option value="LABATECA">LABATECA</option>
                <option value="LOS PATIOS">LOS PATIOS</option>
                <option value="LOURDES">LOURDES</option>
                <option value="MORALES">MORALES</option>
                <option value="MUTISCUA">MUTISCUA</option>
                <option value="OCAÑA">OCAÑA</option>
                <option value="PAILITAS">PAILITAS</option>
                <option value="PAMPLONA">PAMPLONA</option>
                <option value="PAMPLONITA">PAMPLONITA</option>
                <option value="PELAYA">PELAYA</option>
                <option value="PUERTO SANTANDER">PUERTO SANTANDER</option>
                <option value="RAGONVALIA">RAGONVALIA</option>
                <option value="RIO DE ORO">RIO DE ORO</option>
                <option value="SALAZAR">SALAZAR</option>
                <option value="SAN ALBERTO">SAN ALBERTO</option>
                <option value="SAN CALIXTO">SAN CALIXTO</option>
                <option value="SAN CAYETANO">SAN CAYETANO</option>
                <option value="SAN MARTIN">SAN MARTIN</option>
                <option value="SANTIAGO">SANTIAGO</option>
                <option value="SARDINATA">SARDINATA</option>
                <option value="SILOS">SILOS</option>
                <option value="TEORAMA">TEORAMA</option>
                <option value="TIBÚ">TIBÚ</option>
                <option value="TOLEDO">TOLEDO</option>
                <option value="VILLA DEL ROSARIO">VILLA DEL ROSARIO</option>
                <option value="VILLA CARO">VILLA CARO</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label required">DEPARTAMENTO</label>
              <input
                type="text"
                id="departamento"
                name="departamento"
                class="form-input bg-gray-50"
                placeholder="Se autocompletará según el municipio"
                readonly
              />
            </div>
            <div class="form-group">
              <label class="form-label required">REGIONAL</label>
              <input
                type="text"
                id="regional"
                name="regional"
                class="form-input bg-gray-50"
                placeholder="Se autocompletará según el municipio"
                readonly
              />
            </div>
            <div class="form-group">
              <label class="form-label required">BARRIO/VEREDA</label>
              <input
                type="text"
                id="barrio_vereda"
                name="barrio_vereda"
                class="form-input"
                placeholder="Nombre del barrio o vereda"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label required">DIRECCIÓN</label>
              <input
                type="text"
                id="direccion"
                name="direccion"
                class="form-input"
                placeholder="Dirección completa"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >CIRCUITO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Circuito eléctrico (alimentador) al que se conecta la
                    estructura. Se actualiza automáticamente según el municipio
                    seleccionado.
                  </span>
                </span>
              </label>
              <select
                id="alimentador"
                name="alimentador"
                class="form-select"
                required
              >
                <option value="">Seleccionar</option>
                <option value="OCAOCANA1">OCAOCANA1</option>
                <option value="OCAOCANA2">OCAOCANA2</option>
                <option value="OCAOCANA3">OCAOCANA3</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >CODIGO DEL TRANSFORMADOR
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Debe empezar por 1T, 2T, 3T, 4T o 5T (Tienen que ser 7
                    caracteres).
                  </span>
                </span></label
              >
              <input
                type="text"
                id="cod_trasnformador"
                name="cod_trasnformador"
                class="form-input"
                placeholder="1T00001"
              />
            </div>

            <div class="form-group">
              <label class="form-label required">CANTIDAD</label>
              <input
                type="text"
                id="cantidad"
                name="cantidad"
                class="form-input"
                placeholder="1"
                value="1"
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >RPP
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Se utilizaron recursos propios (0) o recursos del estado
                    (1).
                  </span>
                </span>
              </label>
              <select id="rpp" name="rpp" class="form-select" required>
                <option value="0">0</option>
                <option value="1">1</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">NUMERO DE CONDUCTORES</label>
              <input
                type="text"
                id="numero_conductores"
                name="numero_conductores"
                class="form-input"
                placeholder="0"
                value="0"
              />
            </div>
          </div>
        </div>

        <!-- Sección 2: Información de Estructuras -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="estructuras"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-building mr-2"></i>
            Información de Estructuras
          </h2>

          <!-- Estructura Nueva -->
          <div
            class="bg-emerald-50/50 rounded-lg border border-emerald-200 p-6 mb-6"
          >
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="form-group">
                <label class="form-label required"
                  >APOYO
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Tipo de apoyo: Poste (estructura simple), Estructura
                      (soporte complejo), Torrecilla (estructura alta de
                      soporte).
                    </span>
                  </span>
                </label>
                <select
                  id="apoyo_nueva"
                  name="apoyo_nueva"
                  class="form-select focus:ring-emerald-100 focus:border-emerald-500"
                  required
                >
                  <option value="">Seleccionar</option>
                  <option value="Poste">POSTE</option>
                  <option value="Estructura">ESTRUCTURA</option>
                  <option value="Torrecilla">TORRECILLA</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label required"
                  >MATERIAL
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Material del apoyo: Concreto (hormigón), PRFV (polímero
                      reforzado con fibra de vidrio), Metálico (acero), Madera
                      (postes tradicionales).
                    </span>
                  </span>
                </label>
                <select
                  id="material_nueva"
                  name="material_nueva"
                  class="form-select focus:ring-emerald-100 focus:border-emerald-500"
                  required
                >
                  <option value="">Seleccionar</option>
                  <option value="concreto">CONCRETO</option>
                  <option value="fibra de vidrio">PRFV</option>
                  <option value="metálico">METALICO</option>
                  <option value="madera">MADERA</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label required"
                  >ALTURA (M)
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Altura total del apoyo en metros. Varía según el tipo de
                      estructura.
                    </span>
                  </span>
                </label>
                <select
                  id="altura_nueva"
                  name="altura_nueva"
                  class="form-select focus:ring-emerald-100 focus:border-emerald-500"
                  required
                >
                  <option value="">Seleccionar</option>
                  <option value="8">8</option>
                  <option value="10">10</option>
                  <option value="12">12</option>
                  <option value="14">14</option>
                  <option value="16">16</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label required"
                  >POBLACIÓN
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Tipo de zona donde se instala: Urbana (dentro de la
                      ciudad), Rural (fuera del perímetro urbano, zonas
                      rurales).
                    </span>
                  </span>
                </label>
                <select
                  id="poblacion_nueva"
                  name="poblacion_nueva"
                  class="form-select focus:ring-emerald-100 focus:border-emerald-500"
                  required
                >
                  <option value="">Seleccionar</option>
                  <option value="urbana">URBANA</option>
                  <option value="rural">RURAL</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label required"
                  >DISPOSICIÓN
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Disposición del conductor: Retención (fijación firme del
                      conductor), Suspensión (conductor colgante con libertad de
                      movimiento).
                    </span>
                  </span>
                </label>
                <select
                  id="disposicion_nueva"
                  name="disposicion_nueva"
                  class="form-select focus:ring-emerald-100 focus:border-emerald-500"
                  required
                >
                  <option value="">Seleccionar</option>
                  <option value="retención">RETENCION</option>
                  <option value="suspensión">SUSPENSION</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label required"
                  >KGF
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Resistencia nominal del apoyo en kilogramos-fuerza (kgf).
                      Indica la capacidad de carga máxima que puede soportar.
                    </span>
                  </span>
                </label>
                <select
                  id="kgf_nueva"
                  name="kgf_nueva"
                  class="form-select focus:ring-emerald-100 focus:border-emerald-500"
                  required
                >
                  <option value="">Seleccionar</option>
                  <option value="510">510</option>
                  <option value="750">750</option>
                  <option value="1000">1000</option>
                  <option value="1050">1050</option>
                  <option value="1350">1350</option>
                  <option value="1500">1500</option>
                  <option value="2000">2000</option>
                  <option value="3000">3000</option>
                  <option value="4000">4000</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label required"
                  >TIPO RED
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Tipo de red eléctrica: Común (conductores desnudos
                      separados), Trenzada (conductores aislados y trenzados
                      juntos).
                    </span>
                  </span>
                </label>
                <select
                  id="tipo_red_nueva"
                  name="tipo_red_nueva"
                  class="form-select focus:ring-emerald-100 focus:border-emerald-500"
                  required
                >
                  <option value="">Seleccionar</option>
                  <option value="común">COMUN</option>
                  <option value="trenzada">TRENZADA</option>
                </select>
              </div>
            </div>

            <!-- UC y Descripción -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-6">
              <div class="form-group md:col-span-1">
                <label class="form-label required"
                  >UC
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Unidad Constructiva. Código que se genera automáticamente
                      según las características de la estructura nueva.
                    </span>
                  </span>
                </label>
                <div class="relative">
                  <select
                    id="uc_codigo"
                    class="form-select bg-gray-50 focus:ring-emerald-100 focus:border-emerald-500"
                    required
                    disabled
                  >
                    <option value="">Autocompletado</option>
                  </select>
                  <div
                    id="uc_indicator"
                    class="absolute right-8 top-1/2 transform -translate-y-1/2 hidden"
                  >
                    <i class="fas fa-check-circle text-green-500"></i>
                  </div>
                </div>
              </div>
              <div class="form-group md:col-span-3">
                <label class="form-label required"
                  >DESCRIPCIÓN
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Descripción detallada de la Unidad Constructiva. Se
                      autocompletará según el código UC generado.
                    </span>
                  </span>
                </label>
                <input
                  type="text"
                  id="descripcion_uc"
                  class="form-input bg-gray-50 focus:ring-emerald-100 focus:border-emerald-500"
                  placeholder="Se autocompletará según la estructura nueva"
                  readonly
                />
              </div>
            </div>
          </div>

          <!-- Fotografías Estructura Nueva -->
          <div class="mt-6">
            <label class="form-label required"
              >Fotografías
              <span class="tooltip">
                <i class="fas fa-question-circle help-icon"></i>
                <span class="tooltip-content">
                  Fotografías de la estructura nueva instalada. Se requiere al
                  menos 1 foto. Formatos: JPG, PNG. Tamaño máximo por foto: 5MB.
                </span>
              </span>
            </label>
            <div
              class="file-drop-zone border-emerald-300 hover:border-emerald-500 hover:bg-emerald-50/50"
            >
              <input
                type="file"
                id="fotos_nueva"
                name="fotos_nueva"
                class="hidden"
                accept="image/*"
                multiple
                required
              />
              <div class="text-center">
                <i class="fas fa-camera text-2xl text-emerald-400 mb-2"></i>
                <p class="text-sm text-gray-600">
                  Arrastra las fotos aquí o haz clic para seleccionar
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  Se requiere al menos 1 foto (JPG, PNG, máx. 5MB)
                </p>
              </div>
            </div>
            <div
              id="preview_nueva"
              class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 mt-4"
            ></div>
          </div>

          <!-- Botón Agregar Iteración -->
          <div class="mt-6 flex justify-end">
            <button
              id="addIteration"
              class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg transition-all duration-200 flex items-center gap-2 font-medium shadow-sm hover:shadow-md active:transform active:scale-95"
            >
              <i class="fas fa-plus-circle"></i>
              Agregar Iteración
            </button>
          </div>
        </div>

        <!-- Resto del formulario -->

        <!-- Mover la tabla de iteraciones aquí -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="estructuras"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-table mr-2"></i>
            Registro de Iteraciones
          </h2>

          <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
              <thead>
                <tr>
                  <th
                    colspan="4"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
                  >
                    Estructura Retirada
                  </th>
                  <th
                    colspan="6"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
                  >
                    Estructura Nueva
                  </th>
                  <th
                    rowspan="2"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Acciones
                  </th>
                </tr>
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
                  >
                    Código
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
                  >
                    Material
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
                  >
                    Altura
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
                  >
                    Fotos
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
                  >
                    Código
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
                  >
                    Material
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
                  >
                    Altura
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
                  >
                    Apoyo
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
                  >
                    UC
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
                  >
                    Fotos
                  </th>
                </tr>
              </thead>
              <tbody
                id="iterationTableBody"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Las filas se agregarán dinámicamente aquí -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- ========== SECCIONES FUTURAS ========== -->

        <!-- Sección: Información del Proyecto - Conductor N1 -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="conductor_n1"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-project-diagram mr-2"></i>
            Información del Proyecto
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="form-group">
              <label class="form-label required"
                >NOMBRE DEL PROYECTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Selecciona el proyecto específico para este conductor N1.
                    Esta información es independiente de otros pasos.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n1_nombre_proyecto"
                name="conductor_n1_nombre_proyecto"
                class="form-select"
                required
              >
                <option value="">Seleccionar proyecto</option>
                <option value="Automatización de redes distribución CENS">
                  Automatización de redes distribución CENS
                </option>
                <option value="Compra de bien futuro">
                  Compra de bien futuro
                </option>
                <option value="Electrificación Rural CENS">
                  Electrificación Rural CENS
                </option>
                <option value="Expansión redes de distribución CENS">
                  Expansión redes de distribución CENS
                </option>
                <option value="Gestión y control pérdidas de energía - CENS">
                  Gestión y control pérdidas de energía - CENS
                </option>
                <option value="Mantenimiento redes de distribución">
                  Mantenimiento redes de distribución
                </option>
                <option value="Mantenimiento redes de distribución - MIT">
                  Mantenimiento redes de distribución - MIT
                </option>
                <option
                  value="Normalización subestación Sevilla 115/34.5 kV e interconexión a 115 kV"
                >
                  Normalización subestación Sevilla 115/34.5 kV e interconexión
                  a 115 kV
                </option>
                <option value="Nueva línea INSC77 - Guaduas 34.5 kV">
                  Nueva línea INSC77 - Guaduas 34.5 kV
                </option>
                <option value="Nuevo Alimentador Gabarra">
                  Nuevo Alimentador Gabarra
                </option>
                <option value="Reconfiguración Planta Zulia 13.8kV">
                  Reconfiguración Planta Zulia 13.8kV
                </option>
                <option value="Reposición redes de distribución CENS">
                  Reposición redes de distribución CENS
                </option>
                <option value="Reposición transformadores distribución CENS">
                  Reposición transformadores distribución CENS
                </option>
                <option value="Repotenciación de líneas CENS 115 kV">
                  Repotenciación de líneas CENS 115 kV
                </option>
                <option value="Reposición subestaciones y líneas CENS">
                  Reposición subestaciones y líneas CENS
                </option>
                <option
                  value="Expansión y normalización de subestaciones media tensión."
                >
                  Expansión y normalización de subestaciones media tensión.
                </option>
                <option value="Nueva subestación La Playa 34.5/13.8 kV">
                  Nueva subestación La Playa 34.5/13.8 kV
                </option>
                <option value="Gestión de Activos CENS">
                  Gestión de Activos CENS
                </option>
                <option value="Activos de Uso propiedad de Terceros">
                  Activos de Uso propiedad de Terceros
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label"
                >BANCO DEL PROYECTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Código del banco asociado al proyecto. Se autocompletará
                    automáticamente cuando selecciones un proyecto.
                  </span>
                </span>
              </label>
              <input
                type="text"
                id="conductor_n1_banco_proyecto"
                name="conductor_n1_banco_proyecto"
                class="form-input bg-gray-50"
                placeholder="Se autocompletará según el proyecto"
                readonly
              />
            </div>
            <div class="form-group">
              <label class="form-label required"
                >CONTRATO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Contrato específico del proyecto. Determina qué municipios
                    estarán disponibles según la regional asignada.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n1_contrato"
                name="conductor_n1_contrato"
                class="form-select"
                required
              >
                <option value="">Seleccionar contrato</option>
                <option value="CONT-2025-001">CONT-2025-001</option>
                <option value="CONT-2025-002">CONT-2025-002</option>
                <option value="CONT-2025-003">CONT-2025-003</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Sección: Documentos y Archivos - Conductor N1 -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="conductor_n1"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-file-alt mr-2"></i>
            Documentos y Archivos
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- AutoCAD -->
            <div class="space-y-4">
              <label class="form-label required"
                >Archivo AutoCAD
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Archivo de diseño técnico en formato AutoCAD (.dwg, .dxf,
                    .dws). Debe contener el plano de la estructura. Tamaño
                    máximo: 50MB.
                  </span>
                </span>
              </label>
              <div
                class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50"
              >
                <input
                  type="file"
                  id="conductor_n1_archivo_cad"
                  name="conductor_n1_archivo_cad"
                  class="hidden"
                  accept=".dwg,.dxf,.dws"
                  required
                />
                <div class="text-center">
                  <i
                    class="fas fa-drafting-compass text-2xl text-blue-400 mb-2"
                  ></i>
                  <p class="text-sm text-gray-600">Cargar archivo AutoCAD</p>
                  <p class="text-xs text-gray-500 mt-1">
                    .dwg, .dxf, .dws (máx. 50MB)
                  </p>
                </div>
              </div>
              <!-- Preview AutoCAD -->
              <div id="conductor_n1_cad_preview" class="hidden">
                <div
                  class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                  <div class="flex-grow">
                    <p
                      class="text-sm font-medium text-gray-900"
                      id="conductor_n1_cad_filename"
                    >
                      archivo.dwg
                    </p>
                    <p class="text-xs text-gray-500" id="conductor_n1_cad_filesize">
                      2.5 MB
                    </p>
                  </div>
                  <button
                    type="button"
                    class="text-gray-400 hover:text-red-500 transition-colors"
                    id="conductor_n1_cad_remove"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- KMZ -->
            <div class="space-y-4">
              <label class="form-label required"
                >Archivo KMZ
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Archivo de geolocalización en formato KMZ de Google Earth.
                    Contiene la ubicación exacta del proyecto. Tamaño máximo:
                    50MB.
                  </span>
                </span>
              </label>
              <div
                class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50"
              >
                <input
                  type="file"
                  id="conductor_n1_archivo_kmz"
                  name="conductor_n1_archivo_kmz"
                  class="hidden"
                  accept=".kmz"
                  required
                />
                <div class="text-center">
                  <i
                    class="fas fa-map-marked-alt text-2xl text-blue-400 mb-2"
                  ></i>
                  <p class="text-sm text-gray-600">Cargar archivo KMZ</p>
                  <p class="text-xs text-gray-500 mt-1">.kmz (máx. 50MB)</p>
                </div>
              </div>
              <!-- Preview KMZ -->
              <div id="conductor_n1_kmz_preview" class="hidden">
                <div
                  class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                  <div class="flex-grow">
                    <p
                      class="text-sm font-medium text-gray-900"
                      id="conductor_n1_kmz_filename"
                    >
                      archivo.kmz
                    </p>
                    <p class="text-xs text-gray-500" id="conductor_n1_kmz_filesize">
                      1.2 MB
                    </p>
                  </div>
                  <button
                    type="button"
                    class="text-gray-400 hover:text-red-500 transition-colors"
                    id="conductor_n1_kmz_remove"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección: Información Técnica - Conductor N1 -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="conductor_n1"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-cog mr-2"></i>
            Información Técnica
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="form-group">
              <label class="form-label required"
                >FECHA DE INSTALACION
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Fecha prevista de instalación del conductor N1
                    (DD/MM/AAAA).
                  </span>
                </span>
              </label>
              <input
                type="date"
                id="conductor_n1_fecha"
                name="conductor_n1_fecha"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >NIVEL DE TENSIÓN
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Nivel de tensión eléctrica: 1-Baja Tensión (hasta 1kV),
                    2-Media Tensión (1-35kV), 3-Alta Tensión (mayor a 35kV).
                  </span>
                </span>
              </label>
              <select
                id="conductor_n1_nivel_tension"
                name="conductor_n1_nivel_tension"
                class="form-select"
                required
              >
                <option value="">Seleccionar</option>
                <option value="1">1 - Baja Tensión</option>
                <option value="2">2 - Media Tensión</option>
                <option value="3">3 - Alta Tensión</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >TIPO DE INVERSION
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Tipo de inversión: I y III requieren estructura retirada,
                    II y IV son instalaciones nuevas sin retirar estructura
                    existente.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n1_t_inv"
                name="conductor_n1_t_inv"
                class="form-select"
                required
              >
                <option value="">Seleccionar</option>
                <option value="I">I</option>
                <option value="II">II</option>
                <option value="III">III</option>
                <option value="IV">IV</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >MUNICIPIO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Municipio donde se instalará el conductor N1. Los
                    municipios disponibles dependen de la regional
                    seleccionada.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n1_municipio"
                name="conductor_n1_municipio"
                class="form-select"
                required
              >
                <option value="">Seleccionar municipio</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >DEPARTAMENTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Departamento donde se encuentra el municipio seleccionado.
                    Se autocompletará según el municipio.
                  </span>
                </span>
              </label>
              <input
                type="text"
                id="conductor_n1_departamento"
                name="conductor_n1_departamento"
                class="form-input bg-gray-50"
                placeholder="Se autocompletará según el municipio"
                readonly
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >REGIONAL
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Regional responsable del proyecto. Define qué municipios
                    estarán disponibles para selección.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n1_regional"
                name="conductor_n1_regional"
                class="form-select"
                required
              >
                <option value="">Seleccionar regional</option>
                <option value="Norte">Norte</option>
                <option value="Centro">Centro</option>
                <option value="Sur">Sur</option>
                <option value="Oriente">Oriente</option>
                <option value="Occidente">Occidente</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Sección: Detalles del Conductor N1 -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="conductor_n1"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-yellow-600"
          >
            <i class="fas fa-bolt mr-2"></i>
            Detalles del Conductor N1
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="form-group">
              <label class="form-label required">CALIBRE DEL CONDUCTOR</label>
              <select
                id="conductor_n1_calibre_conductor"
                name="conductor_n1_calibre_conductor"
                class="form-select"
                required
              >
                <option value="">Seleccionar calibre</option>
                <option value="2 AWG">2 AWG</option>
                <option value="1/0 AWG">1/0 AWG</option>
                <option value="2/0 AWG">2/0 AWG</option>
                <option value="4/0 AWG">4/0 AWG</option>
                <option value="266.8 MCM">266.8 MCM</option>
                <option value="336.4 MCM">336.4 MCM</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">MATERIAL DEL CONDUCTOR</label>
              <select
                id="conductor_n1_material_conductor"
                name="conductor_n1_material_conductor"
                class="form-select"
                required
              >
                <option value="">Seleccionar material</option>
                <option value="Aluminio">Aluminio</option>
                <option value="Cobre">Cobre</option>
                <option value="ACSR">ACSR (Aluminio con alma de acero)</option>
                <option value="AAAC">AAAC (Aleación de aluminio)</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">TIPO DE AISLAMIENTO</label>
              <select
                id="conductor_n1_tipo_aislamiento"
                name="conductor_n1_tipo_aislamiento"
                class="form-select"
                required
              >
                <option value="">Seleccionar tipo</option>
                <option value="Desnudo">Desnudo</option>
                <option value="XLPE">XLPE</option>
                <option value="PVC">PVC</option>
                <option value="EPR">EPR</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >LONGITUD DEL CONDUCTOR (m)</label
              >
              <input
                type="number"
                id="conductor_n1_longitud_conductor"
                name="conductor_n1_longitud_conductor"
                class="form-input"
                placeholder="100"
                min="1"
                step="0.1"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">TENSIÓN NOMINAL (kV)</label>
              <select
                id="conductor_n1_tension_nominal"
                name="conductor_n1_tension_nominal"
                class="form-select"
                required
              >
                <option value="">Seleccionar tensión</option>
                <option value="13.8">13.8 kV</option>
                <option value="34.5">34.5 kV</option>
                <option value="115">115 kV</option>
                <option value="230">230 kV</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">CORRIENTE NOMINAL (A)</label>
              <input
                type="number"
                id="conductor_n1_corriente_nominal"
                name="conductor_n1_corriente_nominal"
                class="form-input"
                placeholder="150"
                min="1"
                step="0.1"
                required
              />
            </div>
          </div>

          <!-- Fotos del Conductor -->
          <div class="mt-6">
            <label class="form-label required">Fotografías del Conductor</label>
            <div
              class="file-drop-zone border-yellow-300 hover:border-yellow-500 hover:bg-yellow-50/50"
            >
              <input
                type="file"
                id="conductor_n1_fotos_conductor"
                name="conductor_n1_fotos_conductor"
                class="hidden"
                accept="image/*"
                multiple
                required
              />
              <div class="text-center">
                <i class="fas fa-camera text-2xl text-yellow-400 mb-2"></i>
                <p class="text-sm text-gray-600">
                  Arrastra las fotos aquí o haz clic para seleccionar
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  Se requiere al menos 1 foto (JPG, PNG, máx. 5MB)
                </p>
              </div>
            </div>
            <div
              id="conductor_n1_preview_conductor"
              class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 mt-4"
            ></div>
          </div>
        </div>

        <!------------>

        <!-- Sección: Información del Proyecto - Conductor N2-N3 -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="conductor_n2_n3"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-project-diagram mr-2"></i>
            Información del Proyecto
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="form-group">
              <label class="form-label required"
                >NOMBRE DEL PROYECTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Selecciona el proyecto específico para este conductor
                    N2-N3. Esta información es independiente de otros pasos.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n2_n3_nombre_proyecto"
                name="conductor_n2_n3_nombre_proyecto"
                class="form-select"
                required
              >
                <option value="">Seleccionar proyecto</option>
                <option
                  value="Normalización subestación Sevilla 115/34.5 kV e interconexión a 115 kV"
                >
                  Normalización subestación Sevilla 115/34.5 kV e
                  interconexión a 115 kV
                </option>
                <option value="Nueva línea INSC77 - Guaduas 34.5 kV">
                  Nueva línea INSC77 - Guaduas 34.5 kV
                </option>
                <option value="Nuevo Alimentador Gabarra">
                  Nuevo Alimentador Gabarra
                </option>
                <option value="Reconfiguración Planta Zulia 13.8kV">
                  Reconfiguración Planta Zulia 13.8kV
                </option>
                <option value="Reposición redes de distribución CENS">
                  Reposición redes de distribución CENS
                </option>
                <option value="Reposición transformadores distribución CENS">
                  Reposición transformadores distribución CENS
                </option>
                <option value="Repotenciación de líneas CENS 115 kV">
                  Repotenciación de líneas CENS 115 kV
                </option>
                <option value="Reposición subestaciones y líneas CENS">
                  Reposición subestaciones y líneas CENS
                </option>
                <option
                  value="Expansión y normalización de subestaciones media tensión."
                >
                  Expansión y normalización de subestaciones media tensión.
                </option>
                <option value="Nueva subestación La Playa 34.5/13.8 kV">
                  Nueva subestación La Playa 34.5/13.8 kV
                </option>
                <option value="Gestión de Activos CENS">
                  Gestión de Activos CENS
                </option>
                <option value="Activos de Uso propiedad de Terceros">
                  Activos de Uso propiedad de Terceros
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label"
                >BANCO DEL PROYECTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Código del banco asociado al proyecto. Se autocompletará
                    automáticamente cuando selecciones un proyecto.
                  </span>
                </span>
              </label>
              <input
                type="text"
                id="conductor_n2_n3_banco_proyecto"
                name="conductor_n2_n3_banco_proyecto"
                class="form-input bg-gray-50"
                placeholder="Se autocompletará según el proyecto"
                readonly
              />
            </div>
            <div class="form-group">
              <label class="form-label required"
                >CONTRATO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Contrato específico del proyecto. Determina qué municipios
                    estarán disponibles según la regional asignada.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n2_n3_contrato"
                name="conductor_n2_n3_contrato"
                class="form-select"
                required
              >
                <option value="">Seleccionar contrato</option>
                <option value="CONT-2025-001">CONT-2025-001</option>
                <option value="CONT-2025-002">CONT-2025-002</option>
                <option value="CONT-2025-003">CONT-2025-003</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Sección: Documentos y Archivos - Conductor N2-N3 -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="conductor_n2_n3"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-file-alt mr-2"></i>
            Documentos y Archivos
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- AutoCAD -->
            <div class="space-y-4">
              <label class="form-label required"
                >Archivo AutoCAD
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Archivo de diseño técnico en formato AutoCAD (.dwg, .dxf,
                    .dws). Debe contener el plano del conductor N2-N3. Tamaño
                    máximo: 50MB.
                  </span>
                </span>
              </label>
              <div
                class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50"
              >
                <input
                  type="file"
                  id="conductor_n2_n3_archivo_cad"
                  name="conductor_n2_n3_archivo_cad"
                  class="hidden"
                  accept=".dwg,.dxf,.dws"
                  required
                />
                <div class="text-center">
                  <i
                    class="fas fa-drafting-compass text-2xl text-blue-400 mb-2"
                  ></i>
                  <p class="text-sm text-gray-600">Cargar archivo AutoCAD</p>
                  <p class="text-xs text-gray-500 mt-1">
                    .dwg, .dxf, .dws (máx. 50MB)
                  </p>
                </div>
              </div>
              <!-- Preview AutoCAD -->
              <div id="conductor_n2_n3_cad_preview" class="hidden">
                <div
                  class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                  <div class="flex-grow">
                    <p
                      class="text-sm font-medium text-gray-900"
                      id="conductor_n2_n3_cad_filename"
                    >
                      archivo.dwg
                    </p>
                    <p
                      class="text-xs text-gray-500"
                      id="conductor_n2_n3_cad_filesize"
                    >
                      2.5 MB
                    </p>
                  </div>
                  <button
                    type="button"
                    onclick="removeFile('conductor_n2_n3_archivo_cad')"
                    class="text-red-500 hover:text-red-700"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- KMZ -->
            <div class="space-y-4">
              <label class="form-label required"
                >Archivo KMZ
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Archivo de geolocalización en formato KMZ de Google Earth.
                    Debe contener las coordenadas exactas del conductor N2-N3.
                    Tamaño máximo: 10MB.
                  </span>
                </span>
              </label>
              <div
                class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50"
              >
                <input
                  type="file"
                  id="conductor_n2_n3_archivo_kmz"
                  name="conductor_n2_n3_archivo_kmz"
                  class="hidden"
                  accept=".kmz,.kml"
                  required
                />
                <div class="text-center">
                  <i class="fas fa-map-marked-alt text-2xl text-blue-400 mb-2"></i>
                  <p class="text-sm text-gray-600">Cargar archivo KMZ</p>
                  <p class="text-xs text-gray-500 mt-1">
                    .kmz, .kml (máx. 10MB)
                  </p>
                </div>
              </div>
              <!-- Preview KMZ -->
              <div id="conductor_n2_n3_kmz_preview" class="hidden">
                <div
                  class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                  <div class="flex-grow">
                    <p
                      class="text-sm font-medium text-gray-900"
                      id="conductor_n2_n3_kmz_filename"
                    >
                      ubicacion.kmz
                    </p>
                    <p
                      class="text-xs text-gray-500"
                      id="conductor_n2_n3_kmz_filesize"
                    >
                      0.8 MB
                    </p>
                  </div>
                  <button
                    type="button"
                    onclick="removeFile('conductor_n2_n3_archivo_kmz')"
                    class="text-red-500 hover:text-red-700"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección: Información Técnica - Conductor N2-N3 -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="conductor_n2_n3"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-cog mr-2"></i>
            Información Técnica
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="form-group">
              <label class="form-label required"
                >FECHA DE INSTALACION
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Fecha prevista de instalación del conductor N2-N3
                    (DD/MM/AAAA).
                  </span>
                </span>
              </label>
              <input
                type="date"
                id="conductor_n2_n3_fecha"
                name="conductor_n2_n3_fecha"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >NIVEL DE TENSIÓN
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Nivel de tensión eléctrica: 1-Baja Tensión (hasta 1kV),
                    2-Media Tensión (1-35kV), 3-Alta Tensión (mayor a 35kV).
                  </span>
                </span>
              </label>
              <select
                id="conductor_n2_n3_nivel_tension"
                name="conductor_n2_n3_nivel_tension"
                class="form-select"
                required
              >
                <option value="">Seleccionar</option>
                <option value="1">1 - Baja Tensión</option>
                <option value="2">2 - Media Tensión</option>
                <option value="3">3 - Alta Tensión</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >TIPO DE INVERSION
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Tipo de inversión: I y III requieren estructura retirada,
                    II y IV son instalaciones nuevas sin retirar estructura
                    existente.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n2_n3_t_inv"
                name="conductor_n2_n3_t_inv"
                class="form-select"
                required
              >
                <option value="">Seleccionar</option>
                <option value="I">I</option>
                <option value="II">II</option>
                <option value="III">III</option>
                <option value="IV">IV</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >MUNICIPIO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Municipio donde se instalará el conductor N2-N3. Los
                    municipios disponibles dependen de la regional
                    seleccionada.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n2_n3_municipio"
                name="conductor_n2_n3_municipio"
                class="form-select"
                required
              >
                <option value="">Seleccionar municipio</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >DEPARTAMENTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Departamento donde se encuentra el municipio seleccionado.
                    Se autocompletará según el municipio.
                  </span>
                </span>
              </label>
              <input
                type="text"
                id="conductor_n2_n3_departamento"
                name="conductor_n2_n3_departamento"
                class="form-input bg-gray-50"
                placeholder="Se autocompletará según el municipio"
                readonly
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >REGIONAL
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Regional responsable del proyecto. Define qué municipios
                    estarán disponibles para selección.
                  </span>
                </span>
              </label>
              <select
                id="conductor_n2_n3_regional"
                name="conductor_n2_n3_regional"
                class="form-select"
                required
              >
                <option value="">Seleccionar regional</option>
                <option value="Norte">Norte</option>
                <option value="Centro">Centro</option>
                <option value="Sur">Sur</option>
                <option value="Oriente">Oriente</option>
                <option value="Occidente">Occidente</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Sección: Detalles del Conductor N2-N3 -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="conductor_n2_n3"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-orange-600"
          >
            <i class="fas fa-bolt mr-2"></i>
            Detalles del Conductor N2-N3
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="form-group">
              <label class="form-label required"
                >CALIBRE DEL CONDUCTOR N2</label
              >
              <select
                id="conductor_n2_n3_calibre_n2"
                name="conductor_n2_n3_calibre_n2"
                class="form-select"
                required
              >
                <option value="">Seleccionar calibre</option>
                <option value="2/0 AWG">2/0 AWG</option>
                <option value="1/0 AWG">1/0 AWG</option>
                <option value="2 AWG">2 AWG</option>
                <option value="4 AWG">4 AWG</option>
                <option value="6 AWG">6 AWG</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >MATERIAL DEL CONDUCTOR N2</label
              >
              <select
                id="conductor_n2_n3_material_n2"
                name="conductor_n2_n3_material_n2"
                class="form-select"
                required
              >
                <option value="">Seleccionar material</option>
                <option value="aluminio">Aluminio</option>
                <option value="cobre">Cobre</option>
                <option value="acsr">ACSR</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">TIPO DE AISLAMIENTO N2</label>
              <select
                id="conductor_n2_n3_aislamiento_n2"
                name="conductor_n2_n3_aislamiento_n2"
                class="form-select"
                required
              >
                <option value="">Seleccionar aislamiento</option>
                <option value="xlpe">XLPE</option>
                <option value="pvc">PVC</option>
                <option value="epr">EPR</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >CALIBRE DEL CONDUCTOR N3</label
              >
              <select
                id="conductor_n2_n3_calibre_n3"
                name="conductor_n2_n3_calibre_n3"
                class="form-select"
                required
              >
                <option value="">Seleccionar calibre</option>
                <option value="2/0 AWG">2/0 AWG</option>
                <option value="1/0 AWG">1/0 AWG</option>
                <option value="2 AWG">2 AWG</option>
                <option value="4 AWG">4 AWG</option>
                <option value="6 AWG">6 AWG</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >MATERIAL DEL CONDUCTOR N3</label
              >
              <select
                id="conductor_n2_n3_material_n3"
                name="conductor_n2_n3_material_n3"
                class="form-select"
                required
              >
                <option value="">Seleccionar material</option>
                <option value="aluminio">Aluminio</option>
                <option value="cobre">Cobre</option>
                <option value="acsr">ACSR</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">TIPO DE AISLAMIENTO N3</label>
              <select
                id="conductor_n2_n3_aislamiento_n3"
                name="conductor_n2_n3_aislamiento_n3"
                class="form-select"
                required
              >
                <option value="">Seleccionar aislamiento</option>
                <option value="xlpe">XLPE</option>
                <option value="pvc">PVC</option>
                <option value="epr">EPR</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >LONGITUD TOTAL N2-N3 (m)</label
              >
              <input
                type="number"
                id="conductor_n2_n3_longitud_n2_n3"
                name="conductor_n2_n3_longitud_n2_n3"
                class="form-input"
                placeholder="100"
                min="1"
                step="0.1"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label">OBSERVACIONES N2-N3</label>
              <textarea
                id="conductor_n2_n3_observaciones_n2_n3"
                name="conductor_n2_n3_observaciones_n2_n3"
                class="form-input"
                rows="3"
                placeholder="Observaciones adicionales sobre conductores N2-N3"
              ></textarea>
            </div>

            <div class="form-group">
              <label class="form-label required">ESTADO DE INSTALACIÓN</label>
              <select
                id="conductor_n2_n3_estado_n2_n3"
                name="conductor_n2_n3_estado_n2_n3"
                class="form-select"
                required
              >
                <option value="">Seleccionar estado</option>
                <option value="nuevo">Nuevo</option>
                <option value="existente">Existente</option>
                <option value="reparado">Reparado</option>
              </select>
            </div>
          </div>

          <!-- Fotos del Conductor N2-N3 -->
          <div class="mt-6">
            <label class="form-label required"
              >Fotografías del Conductor N2-N3</label
            >
            <div
              class="file-drop-zone border-orange-300 hover:border-orange-500 hover:bg-orange-50/50"
            >
              <input
                type="file"
                id="conductor_n2_n3_fotos_conductor_n2_n3"
                name="conductor_n2_n3_fotos_conductor_n2_n3"
                class="hidden"
                accept="image/*"
                multiple
                required
              />
              <div class="text-center">
                <i class="fas fa-camera text-2xl text-orange-400 mb-2"></i>
                <p class="text-sm text-gray-600">
                  Cargar fotografías del conductor N2-N3
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  JPG, PNG, GIF (máx. 10MB cada una)
                </p>
              </div>
            </div>
            <div
              id="conductor_n2_n3_preview_conductor_n2_n3"
              class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 mt-4"
            ></div>
          </div>
        </div>

        <!-- Sección: Información del Proyecto - Equipos -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="equipos"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-project-diagram mr-2"></i>
            Información del Proyecto
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="form-group">
              <label class="form-label required"
                >NOMBRE DEL PROYECTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Selecciona el proyecto específico para estos equipos. Esta
                    información es independiente de otros pasos.
                  </span>
                </span>
              </label>
              <select
                id="equipos_nombre_proyecto"
                name="equipos_nombre_proyecto"
                class="form-select"
                required
              >
                <option value="">Seleccionar proyecto</option>
                <option
                  value="Normalización subestación Sevilla 115/34.5 kV e interconexión a 115 kV"
                >
                  Normalización subestación Sevilla 115/34.5 kV e
                  interconexión a 115 kV
                </option>
                <option value="Nueva línea INSC77 - Guaduas 34.5 kV">
                  Nueva línea INSC77 - Guaduas 34.5 kV
                </option>
                <option value="Nuevo Alimentador Gabarra">
                  Nuevo Alimentador Gabarra
                </option>
                <option value="Reconfiguración Planta Zulia 13.8kV">
                  Reconfiguración Planta Zulia 13.8kV
                </option>
                <option value="Reposición redes de distribución CENS">
                  Reposición redes de distribución CENS
                </option>
                <option value="Reposición transformadores distribución CENS">
                  Reposición transformadores distribución CENS
                </option>
                <option value="Repotenciación de líneas CENS 115 kV">
                  Repotenciación de líneas CENS 115 kV
                </option>
                <option value="Reposición subestaciones y líneas CENS">
                  Reposición subestaciones y líneas CENS
                </option>
                <option
                  value="Expansión y normalización de subestaciones media tensión."
                >
                  Expansión y normalización de subestaciones media tensión.
                </option>
                <option value="Nueva subestación La Playa 34.5/13.8 kV">
                  Nueva subestación La Playa 34.5/13.8 kV
                </option>
                <option value="Gestión de Activos CENS">
                  Gestión de Activos CENS
                </option>
                <option value="Activos de Uso propiedad de Terceros">
                  Activos de Uso propiedad de Terceros
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label"
                >BANCO DEL PROYECTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Código del banco asociado al proyecto. Se autocompletará
                    automáticamente cuando selecciones un proyecto.
                  </span>
                </span>
              </label>
              <input
                type="text"
                id="equipos_banco_proyecto"
                name="equipos_banco_proyecto"
                class="form-input bg-gray-50"
                placeholder="Se autocompletará según el proyecto"
                readonly
              />
            </div>
            <div class="form-group">
              <label class="form-label required"
                >CONTRATO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Contrato específico del proyecto. Determina qué municipios
                    estarán disponibles según la regional asignada.
                  </span>
                </span>
              </label>
              <select
                id="equipos_contrato"
                name="equipos_contrato"
                class="form-select"
                required
              >
                <option value="">Seleccionar contrato</option>
                <option value="CONT-2025-001">CONT-2025-001</option>
                <option value="CONT-2025-002">CONT-2025-002</option>
                <option value="CONT-2025-003">CONT-2025-003</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Sección: Documentos y Archivos - Equipos -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="equipos"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-file-alt mr-2"></i>
            Documentos y Archivos
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- AutoCAD -->
            <div class="space-y-4">
              <label class="form-label required"
                >Archivo AutoCAD
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Archivo de diseño técnico en formato AutoCAD (.dwg, .dxf,
                    .dws). Debe contener el plano de los equipos. Tamaño
                    máximo: 50MB.
                  </span>
                </span>
              </label>
              <div
                class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50"
              >
                <input
                  type="file"
                  id="equipos_archivo_cad"
                  name="equipos_archivo_cad"
                  class="hidden"
                  accept=".dwg,.dxf,.dws"
                  required
                />
                <div class="text-center">
                  <i
                    class="fas fa-drafting-compass text-2xl text-blue-400 mb-2"
                  ></i>
                  <p class="text-sm text-gray-600">Cargar archivo AutoCAD</p>
                  <p class="text-xs text-gray-500 mt-1">
                    .dwg, .dxf, .dws (máx. 50MB)
                  </p>
                </div>
              </div>
              <!-- Preview AutoCAD -->
              <div id="equipos_cad_preview" class="hidden">
                <div
                  class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                  <div class="flex-grow">
                    <p
                      class="text-sm font-medium text-gray-900"
                      id="equipos_cad_filename"
                    >
                      archivo.dwg
                    </p>
                    <p
                      class="text-xs text-gray-500"
                      id="equipos_cad_filesize"
                    >
                      2.5 MB
                    </p>
                  </div>
                  <button
                    type="button"
                    onclick="removeFile('equipos_archivo_cad')"
                    class="text-red-500 hover:text-red-700"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- KMZ -->
            <div class="space-y-4">
              <label class="form-label required"
                >Archivo KMZ
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Archivo de geolocalización en formato KMZ de Google Earth.
                    Debe contener las coordenadas exactas de los equipos.
                    Tamaño máximo: 10MB.
                  </span>
                </span>
              </label>
              <div
                class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50"
              >
                <input
                  type="file"
                  id="equipos_archivo_kmz"
                  name="equipos_archivo_kmz"
                  class="hidden"
                  accept=".kmz,.kml"
                  required
                />
                <div class="text-center">
                  <i class="fas fa-map-marked-alt text-2xl text-blue-400 mb-2"></i>
                  <p class="text-sm text-gray-600">Cargar archivo KMZ</p>
                  <p class="text-xs text-gray-500 mt-1">
                    .kmz, .kml (máx. 10MB)
                  </p>
                </div>
              </div>
              <!-- Preview KMZ -->
              <div id="equipos_kmz_preview" class="hidden">
                <div
                  class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                >
                  <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                  <div class="flex-grow">
                    <p
                      class="text-sm font-medium text-gray-900"
                      id="equipos_kmz_filename"
                    >
                      ubicacion.kmz
                    </p>
                    <p
                      class="text-xs text-gray-500"
                      id="equipos_kmz_filesize"
                    >
                      0.8 MB
                    </p>
                  </div>
                  <button
                    type="button"
                    onclick="removeFile('equipos_archivo_kmz')"
                    class="text-red-500 hover:text-red-700"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección: Información Técnica - Equipos -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="equipos"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-blue-600"
          >
            <i class="fas fa-cog mr-2"></i>
            Información Técnica
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="form-group">
              <label class="form-label required"
                >FECHA DE INSTALACION
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Fecha prevista de instalación de los equipos (DD/MM/AAAA).
                  </span>
                </span>
              </label>
              <input
                type="date"
                id="equipos_fecha"
                name="equipos_fecha"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >NIVEL DE TENSIÓN
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Nivel de tensión eléctrica: 1-Baja Tensión (hasta 1kV),
                    2-Media Tensión (1-35kV), 3-Alta Tensión (mayor a 35kV).
                  </span>
                </span>
              </label>
              <select
                id="equipos_nivel_tension"
                name="equipos_nivel_tension"
                class="form-select"
                required
              >
                <option value="">Seleccionar</option>
                <option value="1">1 - Baja Tensión</option>
                <option value="2">2 - Media Tensión</option>
                <option value="3">3 - Alta Tensión</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >TIPO DE INVERSION
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Tipo de inversión: I y III requieren estructura retirada,
                    II y IV son instalaciones nuevas sin retirar estructura
                    existente.
                  </span>
                </span>
              </label>
              <select
                id="equipos_t_inv"
                name="equipos_t_inv"
                class="form-select"
                required
              >
                <option value="">Seleccionar</option>
                <option value="I">I</option>
                <option value="II">II</option>
                <option value="III">III</option>
                <option value="IV">IV</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >MUNICIPIO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Municipio donde se instalarán los equipos. Los municipios
                    disponibles dependen de la regional seleccionada.
                  </span>
                </span>
              </label>
              <select
                id="equipos_municipio"
                name="equipos_municipio"
                class="form-select"
                required
              >
                <option value="">Seleccionar municipio</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >DEPARTAMENTO
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Departamento donde se encuentra el municipio seleccionado.
                    Se autocompletará según el municipio.
                  </span>
                </span>
              </label>
              <input
                type="text"
                id="equipos_departamento"
                name="equipos_departamento"
                class="form-input bg-gray-50"
                placeholder="Se autocompletará según el municipio"
                readonly
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >REGIONAL
                <span class="tooltip">
                  <i class="fas fa-question-circle help-icon"></i>
                  <span class="tooltip-content">
                    Regional responsable del proyecto. Define qué municipios
                    estarán disponibles para selección.
                  </span>
                </span>
              </label>
              <select
                id="equipos_regional"
                name="equipos_regional"
                class="form-select"
                required
              >
                <option value="">Seleccionar regional</option>
                <option value="Norte">Norte</option>
                <option value="Centro">Centro</option>
                <option value="Sur">Sur</option>
                <option value="Oriente">Oriente</option>
                <option value="Occidente">Occidente</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Sección: Detalles de los Equipos -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="equipos"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-green-600"
          >
            <i class="fas fa-shield-alt mr-2"></i>
            Detalles de los Equipos
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="form-group">
              <label class="form-label required">TIPO DE EQUIPO</label>
              <select
                id="equipos_tipo_equipo"
                name="equipos_tipo_equipo"
                class="form-select"
                required
              >
                <option value="">Seleccionar equipo</option>
                <option value="Fusible">Fusible</option>
                <option value="Seccionador">Seccionador</option>
                <option value="Pararrayos">Pararrayos</option>
                <option value="Reconectador">Reconectador</option>
                <option value="Regulador">Regulador de Tensión</option>
                <option value="Condensador">Banco de Condensadores</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">MARCA DEL EQUIPO</label>
              <input
                type="text"
                id="equipos_marca_equipo"
                name="equipos_marca_equipo"
                class="form-input"
                placeholder="ABB, Schneider, Siemens, etc."
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">MODELO</label>
              <input
                type="text"
                id="equipos_modelo_equipo"
                name="equipos_modelo_equipo"
                class="form-input"
                placeholder="Modelo del equipo"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">CORRIENTE NOMINAL (A)</label>
              <input
                type="number"
                id="equipos_corriente_equipo"
                name="equipos_corriente_equipo"
                class="form-input"
                placeholder="100"
                min="1"
                step="0.1"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >TENSIÓN DE OPERACIÓN (kV)</label
              >
              <select
                id="equipos_tension_equipo"
                name="equipos_tension_equipo"
                class="form-select"
                required
              >
                <option value="">Seleccionar tensión</option>
                <option value="13.8">13.8 kV</option>
                <option value="34.5">34.5 kV</option>
                <option value="115">115 kV</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">FECHA DE INSTALACIÓN</label>
              <input
                type="date"
                id="equipos_fecha_instalacion_equipo"
                name="equipos_fecha_instalacion_equipo"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label">NÚMERO DE SERIE</label>
              <input
                type="text"
                id="equipos_numero_serie"
                name="equipos_numero_serie"
                class="form-input"
                placeholder="Número de serie del equipo"
              />
            </div>

            <div class="form-group">
              <label class="form-label required">ESTADO DEL EQUIPO</label>
              <select
                id="equipos_estado_equipo"
                name="equipos_estado_equipo"
                class="form-select"
                required
              >
                <option value="">Seleccionar estado</option>
                <option value="Nuevo">Nuevo</option>
                <option value="Usado - Bueno">Usado - Bueno</option>
                <option value="Usado - Regular">Usado - Regular</option>
                <option value="Requiere Mantenimiento">
                  Requiere Mantenimiento
                </option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">OBSERVACIONES</label>
              <textarea
                id="equipos_observaciones_equipo"
                name="equipos_observaciones_equipo"
                class="form-input"
                rows="3"
                placeholder="Observaciones adicionales sobre el equipo"
              ></textarea>
            </div>
          </div>

          <!-- Fotos del Equipo -->
          <div class="mt-6">
            <label class="form-label required">Fotografías del Equipo</label>
            <div
              class="file-drop-zone border-green-300 hover:border-green-500 hover:bg-green-50/50"
            >
              <input
                type="file"
                id="equipos_fotos_equipo"
                name="equipos_fotos_equipo"
                class="hidden"
                accept="image/*"
                multiple
                required
              />
              <div class="text-center">
                <i class="fas fa-camera text-2xl text-green-400 mb-2"></i>
                <p class="text-sm text-gray-600">
                  Arrastra las fotos aquí o haz clic para seleccionar
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  Se requiere al menos 1 foto (JPG, PNG, máx. 5MB)
                </p>
              </div>
            </div>
            <div
              id="equipos_preview_equipo"
              class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 mt-4"
            ></div>
          </div>
        </div>
              <select
                id="tipo_equipo"
                name="tipo_equipo"
                class="form-select"
                required
              >
                <option value="">Seleccionar equipo</option>
                <option value="Fusible">Fusible</option>
                <option value="Seccionador">Seccionador</option>
                <option value="Pararrayos">Pararrayos</option>
                <option value="Reconectador">Reconectador</option>
                <option value="Regulador">Regulador de Tensión</option>
                <option value="Condensador">Banco de Condensadores</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">MARCA DEL EQUIPO</label>
              <input
                type="text"
                id="marca_equipo"
                name="marca_equipo"
                class="form-input"
                placeholder="ABB, Schneider, Siemens, etc."
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">MODELO</label>
              <input
                type="text"
                id="modelo_equipo"
                name="modelo_equipo"
                class="form-input"
                placeholder="Modelo del equipo"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">CORRIENTE NOMINAL (A)</label>
              <input
                type="number"
                id="corriente_equipo"
                name="corriente_equipo"
                class="form-input"
                placeholder="100"
                min="1"
                step="0.1"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required"
                >TENSIÓN DE OPERACIÓN (kV)</label
              >
              <select
                id="tension_equipo"
                name="tension_equipo"
                class="form-select"
                required
              >
                <option value="">Seleccionar tensión</option>
                <option value="13.8">13.8 kV</option>
                <option value="34.5">34.5 kV</option>
                <option value="115">115 kV</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">FECHA DE INSTALACIÓN</label>
              <input
                type="date"
                id="fecha_instalacion_equipo"
                name="fecha_instalacion_equipo"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label">NÚMERO DE SERIE</label>
              <input
                type="text"
                id="numero_serie"
                name="numero_serie"
                class="form-input"
                placeholder="Número de serie del equipo"
              />
            </div>

            <div class="form-group">
              <label class="form-label required">ESTADO DEL EQUIPO</label>
              <select
                id="estado_equipo"
                name="estado_equipo"
                class="form-select"
                required
              >
                <option value="">Seleccionar estado</option>
                <option value="Nuevo">Nuevo</option>
                <option value="Usado - Bueno">Usado - Bueno</option>
                <option value="Usado - Regular">Usado - Regular</option>
                <option value="Requiere Mantenimiento">
                  Requiere Mantenimiento
                </option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">OBSERVACIONES</label>
              <textarea
                id="observaciones_equipo"
                name="observaciones_equipo"
                class="form-input"
                rows="3"
                placeholder="Observaciones adicionales sobre el equipo"
              ></textarea>
            </div>
          </div>

          <!-- Fotos del Equipo -->
          <div class="mt-6">
            <label class="form-label required">Fotografías del Equipo</label>
            <div
              class="file-drop-zone border-green-300 hover:border-green-500 hover:bg-green-50/50"
            >
              <input
                type="file"
                id="fotos_equipo"
                name="fotos_equipo"
                class="hidden"
                accept="image/*"
                multiple
                required
              />
              <div class="text-center">
                <i class="fas fa-camera text-2xl text-green-400 mb-2"></i>
                <p class="text-sm text-gray-600">
                  Arrastra las fotos aquí o haz clic para seleccionar
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  Se requiere al menos 1 foto (JPG, PNG, máx. 5MB)
                </p>
              </div>
            </div>
            <div
              id="preview_equipo"
              class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 mt-4"
            ></div>
          </div>
        </div>

        <!-- Sección: TRANSFORMADOR DISTRIBUCIÓN -->
        <div
          class="bg-white rounded-lg shadow-sm p-8 mb-8"
          data-form-section="transformador"
          style="display: none"
        >
          <h2
            class="text-xl font-semibold mb-6 flex items-center text-purple-600"
          >
            <i class="fas fa-microchip mr-2"></i>
            TRANSFORMADOR DE DISTRIBUCIÓN
          </h2>

          <!-- Información del Proyecto -->
          <div class="mb-8">
            <h3
              class="text-lg font-semibold mb-4 flex items-center text-blue-600"
            >
              <i class="fas fa-project-diagram mr-2"></i>
              Información del Proyecto
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="form-group">
                <label class="form-label required"
                  >NOMBRE DEL PROYECTO
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Selecciona el proyecto específico para este transformador.
                      Esta información es independiente de otros pasos.
                    </span>
                  </span>
                </label>
                <select
                  id="transformador_nombre_proyecto"
                  name="transformador_nombre_proyecto"
                  class="form-select"
                  required
                >
                  <option value="">Seleccionar proyecto</option>
                  <option
                    value="Normalización subestación Sevilla 115/34.5 kV e interconexión a 115 kV"
                  >
                    Normalización subestación Sevilla 115/34.5 kV e
                    interconexión a 115 kV
                  </option>
                  <option value="Nueva línea INSC77 - Guaduas 34.5 kV">
                    Nueva línea INSC77 - Guaduas 34.5 kV
                  </option>
                  <option value="Nuevo Alimentador Gabarra">
                    Nuevo Alimentador Gabarra
                  </option>
                  <option value="Reconfiguración Planta Zulia 13.8kV">
                    Reconfiguración Planta Zulia 13.8kV
                  </option>
                  <option value="Reposición redes de distribución CENS">
                    Reposición redes de distribución CENS
                  </option>
                  <option value="Reposición transformadores distribución CENS">
                    Reposición transformadores distribución CENS
                  </option>
                  <option value="Repotenciación de líneas CENS 115 kV">
                    Repotenciación de líneas CENS 115 kV
                  </option>
                  <option value="Reposición subestaciones y líneas CENS">
                    Reposición subestaciones y líneas CENS
                  </option>
                  <option
                    value="Expansión y normalización de subestaciones media tensión."
                  >
                    Expansión y normalización de subestaciones media tensión.
                  </option>
                  <option value="Nueva subestación La Playa 34.5/13.8 kV">
                    Nueva subestación La Playa 34.5/13.8 kV
                  </option>
                  <option value="Gestión de Activos CENS">
                    Gestión de Activos CENS
                  </option>
                  <option value="Activos de Uso propiedad de Terceros">
                    Activos de Uso propiedad de Terceros
                  </option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label"
                  >BANCO DEL PROYECTO
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Código del banco asociado al proyecto. Se autocompletará
                      automáticamente cuando selecciones un proyecto.
                    </span>
                  </span>
                </label>
                <input
                  type="text"
                  id="transformador_banco_proyecto"
                  name="transformador_banco_proyecto"
                  class="form-input bg-gray-50"
                  placeholder="Se autocompletará según el proyecto"
                  readonly
                />
              </div>
              <div class="form-group">
                <label class="form-label required"
                  >CONTRATO
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Contrato específico del proyecto. Determina qué municipios
                      estarán disponibles según la regional asignada.
                    </span>
                  </span>
                </label>
                <select
                  id="transformador_contrato"
                  name="transformador_contrato"
                  class="form-select"
                  required
                >
                  <option value="">Seleccionar contrato</option>
                  <option value="CONT-2025-001">CONT-2025-001</option>
                  <option value="CONT-2025-002">CONT-2025-002</option>
                  <option value="CONT-2025-003">CONT-2025-003</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Documentos y Archivos -->
          <div class="mb-8">
            <h3
              class="text-lg font-semibold mb-4 flex items-center text-blue-600"
            >
              <i class="fas fa-file-alt mr-2"></i>
              Documentos y Archivos
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <!-- AutoCAD -->
              <div class="space-y-4">
                <label class="form-label required"
                  >Archivo AutoCAD
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Archivo de diseño técnico en formato AutoCAD (.dwg, .dxf,
                      .dws). Debe contener el plano del transformador. Tamaño
                      máximo: 50MB.
                    </span>
                  </span>
                </label>
                <div
                  class="file-drop-zone border-blue-300 hover:border-blue-500 hover:bg-blue-50/50"
                >
                  <input
                    type="file"
                    id="transformador_archivo_cad"
                    name="transformador_archivo_cad"
                    class="hidden"
                    accept=".dwg,.dxf,.dws"
                    required
                  />
                  <div class="text-center">
                    <i
                      class="fas fa-drafting-compass text-2xl text-blue-400 mb-2"
                    ></i>
                    <p class="text-sm text-gray-600">Cargar archivo AutoCAD</p>
                    <p class="text-xs text-gray-500 mt-1">
                      .dwg, .dxf, .dws (máx. 50MB)
                    </p>
                  </div>
                </div>
                <!-- Preview AutoCAD -->
                <div id="transformador_cad_preview" class="hidden">
                  <div
                    class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                  >
                    <i class="fas fa-file-alt text-gray-400 text-xl mr-3"></i>
                    <div class="flex-grow">
                      <p
                        class="text-sm font-medium text-gray-900"
                        id="transformador_cad_filename"
                      >
                        archivo.dwg
                      </p>
                      <p
                        class="text-xs text-gray-500"
                        id="transformador_cad_filesize"
                      >
                        2.5 MB
                      </p>
                    </div>
                    <button
                      type="button"
                      onclick="removeFile('transformador_archivo_cad')"
                      class="text-red-500 hover:text-red-700"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- KMZ -->
              <div class="space-y-4">
                <label class="form-label required"
                  >Archivo KMZ
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Archivo de geolocalización en formato KMZ de Google Earth.
                      Debe contener las coordenadas exactas del transformador.
                      Tamaño máximo: 10MB.
                    </span>
                  </span>
                </label>
                <div
                  class="file-drop-zone border-green-300 hover:border-green-500 hover:bg-green-50/50"
                >
                  <input
                    type="file"
                    id="transformador_archivo_kmz"
                    name="transformador_archivo_kmz"
                    class="hidden"
                    accept=".kmz,.kml"
                    required
                  />
                  <div class="text-center">
                    <i class="fas fa-globe text-2xl text-green-400 mb-2"></i>
                    <p class="text-sm text-gray-600">Cargar archivo KMZ</p>
                    <p class="text-xs text-gray-500 mt-1">
                      .kmz, .kml (máx. 10MB)
                    </p>
                  </div>
                </div>
                <!-- Preview KMZ -->
                <div id="transformador_kmz_preview" class="hidden">
                  <div
                    class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200"
                  >
                    <i class="fas fa-globe text-gray-400 text-xl mr-3"></i>
                    <div class="flex-grow">
                      <p
                        class="text-sm font-medium text-gray-900"
                        id="transformador_kmz_filename"
                      >
                        ubicacion.kmz
                      </p>
                      <p
                        class="text-xs text-gray-500"
                        id="transformador_kmz_filesize"
                      >
                        0.8 MB
                      </p>
                    </div>
                    <button
                      type="button"
                      onclick="removeFile('transformador_archivo_kmz')"
                      class="text-red-500 hover:text-red-700"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Información Técnica -->
          <div class="mb-8">
            <h3
              class="text-lg font-semibold mb-4 flex items-center text-blue-600"
            >
              <i class="fas fa-cog mr-2"></i>
              Información Técnica
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="form-group">
                <label class="form-label required"
                  >FECHA DE INSTALACION
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Fecha prevista de instalación del transformador
                      (DD/MM/AAAA).
                    </span>
                  </span>
                </label>
                <input
                  type="date"
                  id="transformador_fecha"
                  name="transformador_fecha"
                  class="form-input"
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label required"
                  >NIVEL DE TENSIÓN
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Nivel de tensión eléctrica: 1-Baja Tensión (hasta 1kV),
                      2-Media Tensión (1-35kV), 3-Alta Tensión (mayor a 35kV).
                    </span>
                  </span>
                </label>
                <select
                  id="transformador_nivel_tension"
                  name="transformador_nivel_tension"
                  class="form-select"
                  required
                >
                  <option value="">Seleccionar</option>
                  <option value="1">1 - Baja Tensión</option>
                  <option value="2">2 - Media Tensión</option>
                  <option value="3">3 - Alta Tensión</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label required"
                  >TIPO DE INVERSION
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Tipo de inversión: I y III requieren estructura retirada,
                      II y IV son instalaciones nuevas sin retirar estructura
                      existente.
                    </span>
                  </span>
                </label>
                <select
                  id="transformador_t_inv"
                  name="transformador_t_inv"
                  class="form-select"
                  required
                >
                  <option value="">Seleccionar</option>
                  <option value="I">I</option>
                  <option value="II">II</option>
                  <option value="III">III</option>
                  <option value="IV">IV</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label required"
                  >MUNICIPIO
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Municipio donde se instalará el transformador. Los
                      municipios disponibles dependen de la regional
                      seleccionada.
                    </span>
                  </span>
                </label>
                <select
                  id="transformador_municipio"
                  name="transformador_municipio"
                  class="form-select"
                  required
                >
                  <option value="">Seleccionar municipio</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label required"
                  >DEPARTAMENTO
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Departamento donde se encuentra el municipio seleccionado.
                      Se autocompletará según el municipio.
                    </span>
                  </span>
                </label>
                <input
                  type="text"
                  id="transformador_departamento"
                  name="transformador_departamento"
                  class="form-input bg-gray-50"
                  placeholder="Se autocompletará según el municipio"
                  readonly
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label required"
                  >REGIONAL
                  <span class="tooltip">
                    <i class="fas fa-question-circle help-icon"></i>
                    <span class="tooltip-content">
                      Regional responsable del proyecto. Define qué municipios
                      estarán disponibles para selección.
                    </span>
                  </span>
                </label>
                <select
                  id="transformador_regional"
                  name="transformador_regional"
                  class="form-select"
                  required
                >
                  <option value="">Seleccionar regional</option>
                  <option value="Norte">Norte</option>
                  <option value="Centro">Centro</option>
                  <option value="Sur">Sur</option>
                  <option value="Oriente">Oriente</option>
                  <option value="Occidente">Occidente</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Información del Transformador -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="form-group">
              <label class="form-label required">POTENCIA NOMINAL (kVA)</label>
              <select
                id="potencia_transformador"
                name="potencia_transformador"
                class="form-select"
                required
              >
                <option value="">Seleccionar potencia</option>
                <option value="5">5 kVA</option>
                <option value="10">10 kVA</option>
                <option value="15">15 kVA</option>
                <option value="25">25 kVA</option>
                <option value="37.5">37.5 kVA</option>
                <option value="50">50 kVA</option>
                <option value="75">75 kVA</option>
                <option value="100">100 kVA</option>
                <option value="150">150 kVA</option>
                <option value="225">225 kVA</option>
                <option value="300">300 kVA</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">TENSIÓN PRIMARIA (kV)</label>
              <select
                id="tension_primaria"
                name="tension_primaria"
                class="form-select"
                required
              >
                <option value="">Seleccionar tensión</option>
                <option value="13.8">13.8 kV</option>
                <option value="34.5">34.5 kV</option>
                <option value="115">115 kV</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">TENSIÓN SECUNDARIA (V)</label>
              <select
                id="tension_secundaria"
                name="tension_secundaria"
                class="form-select"
                required
              >
                <option value="">Seleccionar tensión</option>
                <option value="120/240">120/240 V</option>
                <option value="208/120">208/120 V</option>
                <option value="480/277">480/277 V</option>
                <option value="480">480 V</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">TIPO DE CONEXIÓN</label>
              <select
                id="tipo_conexion"
                name="tipo_conexion"
                class="form-select"
                required
              >
                <option value="">Seleccionar conexión</option>
                <option value="Monofásico">Monofásico</option>
                <option value="Trifásico Delta-Estrella">
                  Trifásico Delta-Estrella
                </option>
                <option value="Trifásico Estrella-Estrella">
                  Trifásico Estrella-Estrella
                </option>
                <option value="Trifásico Delta-Delta">
                  Trifásico Delta-Delta
                </option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">MARCA</label>
              <input
                type="text"
                id="marca_transformador"
                name="marca_transformador"
                class="form-input"
                placeholder="ABB, Schneider, General Electric, etc."
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">MODELO</label>
              <input
                type="text"
                id="modelo_transformador"
                name="modelo_transformador"
                class="form-input"
                placeholder="Modelo del transformador"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">NÚMERO DE SERIE</label>
              <input
                type="text"
                id="serie_transformador"
                name="serie_transformador"
                class="form-input"
                placeholder="Número de serie"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">AÑO DE FABRICACIÓN</label>
              <input
                type="number"
                id="año_fabricacion"
                name="año_fabricacion"
                class="form-input"
                placeholder="2024"
                min="1980"
                max="2025"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">TIPO DE REFRIGERACIÓN</label>
              <select
                id="refrigeracion"
                name="refrigeracion"
                class="form-select"
                required
              >
                <option value="">Seleccionar tipo</option>
                <option value="ONAN">
                  ONAN (Aceite Natural, Aire Natural)
                </option>
                <option value="ONAF">
                  ONAF (Aceite Natural, Aire Forzado)
                </option>
                <option value="Seco">Transformador Seco</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label required">IMPEDANCIA (%)</label>
              <input
                type="number"
                id="impedancia"
                name="impedancia"
                class="form-input"
                placeholder="5.5"
                min="1"
                max="20"
                step="0.1"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label required">GRUPO DE CONEXIÓN</label>
              <select
                id="grupo_conexion"
                name="grupo_conexion"
                class="form-select"
                required
              >
                <option value="">Seleccionar grupo</option>
                <option value="Dyn1">Dyn1</option>
                <option value="Dyn5">Dyn5</option>
                <option value="Dyn11">Dyn11</option>
                <option value="Yy0">Yy0</option>
                <option value="Dd0">Dd0</option>
              </select>
            </div>

            <div class="form-group md:col-span-3">
              <label class="form-label">OBSERVACIONES</label>
              <textarea
                id="observaciones_transformador"
                name="observaciones_transformador"
                class="form-input"
                rows="3"
                placeholder="Observaciones adicionales sobre el transformador"
              ></textarea>
            </div>
          </div>

          <!-- Fotos del Transformador -->
          <div class="mt-6">
            <label class="form-label required"
              >Fotografías del Transformador</label
            >
            <div
              class="file-drop-zone border-purple-300 hover:border-purple-500 hover:bg-purple-50/50"
            >
              <input
                type="file"
                id="fotos_transformador"
                name="fotos_transformador"
                class="hidden"
                accept="image/*"
                multiple
                required
              />
              <div class="text-center">
                <i class="fas fa-camera text-2xl text-purple-400 mb-2"></i>
                <p class="text-sm text-gray-600">
                  Arrastra las fotos aquí o haz clic para seleccionar
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  Se requiere al menos 1 foto (JPG, PNG, máx. 5MB)
                </p>
              </div>
            </div>
            <div
              id="preview_transformador"
              class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 mt-4"
            ></div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="flex justify-center items-center gap-4 mt-8">
          <!-- Botón Ver Formularios -->
          <a
            href="{% url 'forms:lista' %}"
            class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors flex items-center gap-2"
          >
            <i class="fas fa-list"></i>
            Ver Formularios
          </a>

          <!-- Botón Enviar Formulario -->
          <button
            type="submit"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
          >
            <i class="fas fa-paper-plane"></i>
            Enviar Formulario
          </button>
        </div>
      </form>
    </main>

    <!-- Incluir el archivo de mapping de UCs -->
    <script src="{% static 'js/uc-mapping.js' %}"></script>
    
    <!-- Módulos separados del formulario -->
    <script src="{% static 'forms/js/data-mappings.js' %}"></script>
    <script src="{% static 'forms/js/form-navigation.js' %}"></script>
    <script src="{% static 'forms/js/autocompletion.js' %}"></script>
    <script src="{% static 'forms/js/form-initialization.js' %}"></script>

      // Función principal de navegación - sin validaciones secuenciales
      function navigateToStep(step) {
        console.log(`Navegando directamente a: ${step}`);

        if (!steps.includes(step)) {
          console.error("Paso inválido:", step);
          return;
        }

        // Actualizar paso actual
        currentStep = step;

        // Actualizar interfaz
        updateNavbarState();
        showStepContent(step);

        console.log(`Navegación completada a: ${step}`);
      }

      // Función para validar coordenadas
      function validateCoordinate(input, type) {
        const value = parseFloat(input.value);
        const errorElementId = input.id + "_error";
        const errorElement = document.getElementById(errorElementId);

        let min, max, fieldName;

        if (type === "x" || type === "x_final") {
          min = 800000;
          max = 1300000;
          fieldName = type === "x" ? "Longitud" : "Longitud Final";
        } else if (type === "y" || type === "y_final") {
          min = 1000000;
          max = 1600000;
          fieldName = type === "y" ? "Latitud" : "Latitud Final";
        }

        if (input.value && (isNaN(value) || value < min || value > max)) {
          if (errorElement) {
            errorElement.textContent = `${fieldName} debe estar entre ${min.toLocaleString()} y ${max.toLocaleString()}`;
            errorElement.style.display = "block";
          }
          input.classList.add("border-red-500");
          return false;
        } else {
          if (errorElement) {
            errorElement.style.display = "none";
          }
          input.classList.remove("border-red-500");
          return true;
        }
      }

      // Función para actualizar el estado visual del navbar
      function updateNavbarState() {
        // Actualizar círculos
        document.querySelectorAll(".nav-item").forEach((item) => {
          const step = item.getAttribute("data-step");
          const icon = item.querySelector("i");

          // Limpiar clases existentes
          item.className =
            "nav-item w-16 h-16 rounded-full flex items-center justify-center mb-3 cursor-pointer shadow-lg transition-all duration-300 hover:scale-105";

          if (step === currentStep) {
            // Paso activo
            item.classList.add("active");
            item.classList.add("bg-blue-600");
            icon.className = getStepIcon(step, "active");
          } else {
            // Paso inactivo
            item.classList.add("bg-gray-300");
            icon.className = getStepIcon(step, "inactive");

            // Agregar efectos hover específicos
            if (step === "conductor") {
              item.classList.add("hover:bg-blue-400");
            } else if (step === "equipos") {
              item.classList.add("hover:bg-green-400");
            } else if (step === "transformador") {
              item.classList.add("hover:bg-purple-400");
            } else if (step === "estructuras") {
              item.classList.add("hover:bg-blue-400");
            }
          }
        });

        // Actualizar etiquetas
        document.querySelectorAll(".nav-step").forEach((step) => {
          step.classList.remove("active");
        });

        const activeStepElement = document.querySelector(
          `[data-step="${currentStep}"]`
        );
        if (activeStepElement && activeStepElement.nextElementSibling) {
          activeStepElement.nextElementSibling.classList.add("active");
        }
      }

      // Función para obtener iconos según el estado
      function getStepIcon(step, state) {
        const icons = {
          estructuras: "fas fa-building",
          conductor_n1: "fas fa-bolt",
          conductor_n2_n3: "fas fa-bolt",
          equipos: "fas fa-shield-alt",
          transformador: "fas fa-microchip",
        };

        const baseIcon = icons[step];
        const colorClass = state === "active" ? "text-white" : "text-gray-600";

        return `${baseIcon} ${colorClass} text-lg`;
      }

      // Función para mostrar/ocultar contenido del paso
      function showStepContent(step) {
        // Ocultar todas las secciones
        const allSections = document.querySelectorAll("[data-form-section]");
        allSections.forEach((section) => {
          section.style.display = "none";
        });

        // Mostrar las secciones correspondientes al paso actual
        const targetSections = document.querySelectorAll(
          `[data-form-section="${step}"]`
        );
        targetSections.forEach((section) => {
          section.style.display = "block";
        });

        // Actualizar labels y campos según el paso actual
        updateFieldsForStep(step);

        console.log(
          `Mostrando contenido para: ${step}, secciones: ${targetSections.length}`
        );
      }

      // Nueva función para actualizar campos según el paso
      function updateFieldsForStep(step) {
        const longitudLabel = document.getElementById("longitud_label");
        const latitudLabel = document.getElementById("latitud_label");
        const longitudFinalGroup = document.getElementById(
          "longitud_final_group"
        );
        const latitudFinalGroup = document.getElementById(
          "latitud_final_group"
        );
        const cantidadField = document.getElementById("cantidad");
        const numeroConductoresField =
          document.getElementById("numero_conductores");

        if (!longitudLabel || !latitudLabel) {
          console.warn("Labels de coordenadas no encontrados, esperando...");
          setTimeout(() => updateFieldsForStep(step), 100);
          return;
        }

        if (step === "estructuras") {
          // En estructuras: labels normales, sin campos finales, campos bloqueados
          longitudLabel.innerHTML = `LONGITUD
            <span class="tooltip">
              <i class="fas fa-question-circle help-icon"></i>
              <span class="tooltip-content">
                Coordenada X (Longitud) de la ubicación exacta de la
                estructura en el sistema de coordenadas MAGNA-SIRGAS. Rango
                válido: 800,000 - 1,300,000.
              </span>
            </span>`;

          latitudLabel.innerHTML = `LATITUD
            <span class="tooltip">
              <i class="fas fa-question-circle help-icon"></i>
              <span class="tooltip-content">
                Coordenada Y (Latitud) de la ubicación exacta de la
                estructura en el sistema de coordenadas MAGNA-SIRGAS. Rango
                válido: 1,000,000 - 1,600,000.
              </span>
            </span>`;

          // Ocultar campos finales
          if (longitudFinalGroup) longitudFinalGroup.style.display = "none";
          if (latitudFinalGroup) latitudFinalGroup.style.display = "none";

          // Bloquear campos cantidad y número de conductores
          if (cantidadField) {
            cantidadField.readOnly = true;
            cantidadField.classList.add("bg-gray-100", "cursor-not-allowed");
          }
          if (numeroConductoresField) {
            numeroConductoresField.readOnly = true;
            numeroConductoresField.classList.add(
              "bg-gray-100",
              "cursor-not-allowed"
            );
          }
        } else {
          // En conductor, equipos, transformador: labels iniciales, mostrar campos finales, campos desbloqueados
          longitudLabel.innerHTML = `LONGITUD INICIAL
            <span class="tooltip">
              <i class="fas fa-question-circle help-icon"></i>
              <span class="tooltip-content">
                Coordenada X (Longitud Inicial) de la ubicación de inicio en el sistema de coordenadas MAGNA-SIRGAS. Rango
                válido: 800,000 - 1,300,000.
              </span>
            </span>`;

          latitudLabel.innerHTML = `LATITUD INICIAL
            <span class="tooltip">
              <i class="fas fa-question-circle help-icon"></i>
              <span class="tooltip-content">
                Coordenada Y (Latitud Inicial) de la ubicación de inicio en el sistema de coordenadas MAGNA-SIRGAS. Rango
                válido: 1,000,000 - 1,600,000.
              </span>
            </span>`;

          // Mostrar campos finales
          if (longitudFinalGroup) longitudFinalGroup.style.display = "block";
          if (latitudFinalGroup) latitudFinalGroup.style.display = "block";

          // Desbloquear campos cantidad y número de conductores
          if (cantidadField) {
            cantidadField.readOnly = false;
            cantidadField.classList.remove("bg-gray-100", "cursor-not-allowed");
          }
          if (numeroConductoresField) {
            numeroConductoresField.readOnly = false;
            numeroConductoresField.classList.remove(
              "bg-gray-100",
              "cursor-not-allowed"
            );
          }
        }

        console.log(`Campos actualizados para el paso: ${step}`);
      }

      // Exponer funciones globalmente
      window.navigateToStep = navigateToStep;
      window.validateCoordinate = validateCoordinate;

      // ========== FUNCIÓN DE SINCRONIZACIÓN DE CAMPOS ==========

      function setupFieldSynchronization() {
        // Configurar sincronización para los campos principales
        const mainFields = [
          "nombre",
          "banco_proyecto",
          "contrato",
          "fecha",
          "nivel_tension",
          "t_inv",
          "municipio",
          "departamento",
          "regional",
        ];

        mainFields.forEach((fieldId) => {
          const mainField = document.getElementById(fieldId);
          if (mainField) {
            // Función para sincronizar valores
            const syncField = () => {
              updateReadonlyFieldsInAllSections(fieldId, mainField);
            };

            // Agregar listeners
            mainField.addEventListener("change", syncField);
            mainField.addEventListener("input", syncField);

            // Sincronizar inmediatamente
            syncField();
          }
        });

        console.log("Sincronización de campos configurada correctamente");
      }

      function updateReadonlyFieldsInAllSections(fieldId, sourceField) {
        // Obtener el valor a mostrar
        let displayValue = sourceField.value;
        if (
          sourceField.tagName === "SELECT" &&
          sourceField.selectedOptions[0]
        ) {
          displayValue = sourceField.selectedOptions[0].text;
        }

        // Buscar todos los campos de solo lectura en otras secciones que correspondan a este campo
        const allSections = [
          "conductor_n1",
          "conductor_n2_n3",
          "equipos",
          "transformador",
        ];

        allSections.forEach((section) => {
          const sectionElement = document.querySelector(
            `[data-form-section="${section}"]`
          );
          if (sectionElement) {
            // Buscar campos readonly en esta sección
            const readonlyFields =
              sectionElement.querySelectorAll("input[readonly]");
            readonlyFields.forEach((field) => {
              const label = field.closest(".form-group").querySelector("label");
              if (label) {
                const labelText = label.textContent.toLowerCase();
                const fieldName = fieldId.toLowerCase().replace("_", " ");

                // Mapear campos específicos
                if (
                  (fieldId === "nombre" &&
                    labelText.includes("nombre del proyecto")) ||
                  (fieldId === "banco_proyecto" &&
                    labelText.includes("banco del proyecto")) ||
                  (fieldId === "contrato" && labelText.includes("contrato")) ||
                  (fieldId === "fecha" &&
                    labelText.includes("fecha de instalacion")) ||
                  (fieldId === "nivel_tension" &&
                    labelText.includes("nivel de tensión")) ||
                  (fieldId === "t_inv" &&
                    labelText.includes("tipo de inversion")) ||
                  (fieldId === "municipio" &&
                    labelText.includes("municipio")) ||
                  (fieldId === "departamento" &&
                    labelText.includes("departamento")) ||
                  (fieldId === "regional" && labelText.includes("regional"))
                ) {
                  field.value = displayValue;
                }
              }
            });
          }
        });
      }

      // ========== FIN FUNCIONES CRÍTICAS ==========

      document.addEventListener("DOMContentLoaded", function () {
        // Verificar que el mapping UC esté disponible
        if (
          typeof UC_MAPPING === "undefined" ||
          typeof getUCFromStructure === "undefined"
        ) {
          console.error("Error: uc-mapping.js no se cargó correctamente");
          alert(
            "Error al cargar el sistema de códigos UC. Por favor recarga la página."
          );
          return;
        }

        const hoy = new Date().toISOString().split("T")[0];
        document.getElementById("fecha").setAttribute("max", hoy);

        // Mapeo de proyectos a bancos
        const PROYECTO_BANCO_MAPPING = {
          "Automatización de redes distribución CENS": "NEG0719TYD",
          "Compra de bien futuro": "NEG9996TYD",
          "Electrificación Rural CENS": "NEG0721TYD",
          "Expansión redes de distribución CENS": "NEG0720TYD",
          "Gestión y control pérdidas de energía - CENS": "PEI0144TYD",
          "Mantenimiento redes de distribución": "NEG1175TYD",
          "Mantenimiento redes de distribución - MIT": "NEG1175MIT",
          "Normalización subestación Sevilla 115/34.5 kV e interconexión a 115 kV": "PEI0342TYD",
          "Nueva línea INSC77 - Guaduas 34.5 kV": "PEI1293DIS",
          "Nuevo Alimentador Gabarra": "PEI1197TYD",
          "Reconfiguración Planta Zulia 13.8kV": "PEI1198TYD",
          "Reposición redes de distribución CENS": "NEG0717TYD",
          "Reposición transformadores distribución CENS": "NEG0718TYD",
          "Repotenciación de líneas CENS 115 kV": "PEI0553TYD",
          "Reposición subestaciones y líneas CENS": "NEG0716TYD",
          "Expansión y normalización de subestaciones media tensión.": "NEG1176TYD",
          "Nueva subestación La Playa 34.5/13.8 kV": "PEI0569TYDCE",
          "Gestión de Activos CENS": "SGACENSTYD",
          "Activos de Uso propiedad de Terceros": "NEG0720TYD"
        };

        console.log(
          "Mapeo Proyecto-Banco cargado correctamente:",
          Object.keys(PROYECTO_BANCO_MAPPING).length,
          "proyectos disponibles"
        );

        // Función para validar coordenadas
        function validateCoordinate(input, type) {
          const value = parseFloat(input.value);
          const errorElementId = input.id + "_error";
          const errorElement = document.getElementById(errorElementId);

          let min, max, fieldName;

          if (type === "x" || type === "x_final") {
            min = 800000;
            max = 1300000;
            fieldName = type === "x" ? "Longitud" : "Longitud Final";
          } else if (type === "y" || type === "y_final") {
            min = 1000000;
            max = 1600000;
            fieldName = type === "y" ? "Latitud" : "Latitud Final";
          }

          if (input.value && (isNaN(value) || value < min || value > max)) {
            if (errorElement) {
              errorElement.textContent = `${fieldName} debe estar entre ${min.toLocaleString()} y ${max.toLocaleString()}`;
              errorElement.style.display = "block";
            }
            input.classList.add("border-red-500");
            return false;
          } else {
            if (errorElement) {
              errorElement.style.display = "none";
            }
            input.classList.remove("border-red-500");
            return true;
          }
        }

        // Función para actualizar el estado visual del navbar
        function updateNavbarState() {
          // Actualizar círculos
          document.querySelectorAll(".nav-item").forEach((item) => {
            const step = item.getAttribute("data-step");
            const icon = item.querySelector("i");

            // Limpiar clases existentes
            item.className =
              "nav-item w-16 h-16 rounded-full flex items-center justify-center mb-3 cursor-pointer shadow-lg transition-all duration-300 hover:scale-105";

            if (step === currentStep) {
              // Paso activo
              item.classList.add("active");
              item.classList.add("bg-blue-600");
              icon.className = getStepIcon(step, "active");
            } else {
              // Paso inactivo
              item.classList.add("bg-gray-300");
              icon.className = getStepIcon(step, "inactive");

              // Agregar efectos hover específicos
              if (step === "conductor") {
                item.classList.add("hover:bg-blue-400");
              } else if (step === "equipos") {
                item.classList.add("hover:bg-green-400");
              } else if (step === "transformador") {
                item.classList.add("hover:bg-purple-400");
              } else if (step === "estructuras") {
                item.classList.add("hover:bg-blue-400");
              }
            }
          });

          // Actualizar etiquetas
          document.querySelectorAll(".nav-step").forEach((step) => {
            step.classList.remove("active");
          });

          const activeStepElement = document.querySelector(
            `[data-step="${currentStep}"]`
          );
          if (activeStepElement && activeStepElement.nextElementSibling) {
            activeStepElement.nextElementSibling.classList.add("active");
          }
        }

        // Función para obtener iconos según el estado
        function getStepIcon(step, state) {
          const icons = {
            estructuras: "fas fa-building",
            conductor_n1: "fas fa-bolt",
            conductor_n2_n3: "fas fa-bolt",
            equipos: "fas fa-shield-alt",
            transformador: "fas fa-microchip",
          };

          const baseIcon = icons[step];
          const colorClass =
            state === "active" ? "text-white" : "text-gray-600";

          return `${baseIcon} ${colorClass} text-lg`;
        }

        // Función para mostrar/ocultar contenido del paso
        function showStepContent(step) {
          // Ocultar todas las secciones
          const allSections = document.querySelectorAll("[data-form-section]");
          allSections.forEach((section) => {
            section.style.display = "none";
          });

          // Mostrar las secciones correspondientes al paso actual
          const targetSections = document.querySelectorAll(
            `[data-form-section="${step}"]`
          );
          targetSections.forEach((section) => {
            section.style.display = "block";
          });

          // Actualizar labels y campos según el paso actual
          updateFieldsForStep(step);

          console.log(
            `Mostrando contenido para: ${step}, secciones: ${targetSections.length}`
          );
        }

        // Nueva función para actualizar campos según el paso
        function updateFieldsForStep(step) {
          const longitudLabel = document.getElementById("longitud_label");
          const latitudLabel = document.getElementById("latitud_label");
          const longitudFinalGroup = document.getElementById(
            "longitud_final_group"
          );
          const latitudFinalGroup = document.getElementById(
            "latitud_final_group"
          );
          const cantidadField = document.getElementById("cantidad");
          const numeroConductoresField =
            document.getElementById("numero_conductores");

          if (!longitudLabel || !latitudLabel) {
            console.warn("Labels de coordenadas no encontrados, esperando...");
            setTimeout(() => updateFieldsForStep(step), 100);
            return;
          }

          if (step === "estructuras") {
            // En estructuras: labels normales, sin campos finales, campos bloqueados
            longitudLabel.innerHTML = `LONGITUD
            <span class="tooltip">
              <i class="fas fa-question-circle help-icon"></i>
              <span class="tooltip-content">
                Coordenada X (Longitud) de la ubicación exacta de la
                estructura en el sistema de coordenadas MAGNA-SIRGAS. Rango
                válido: 800,000 - 1,300,000.
              </span>
            </span>`;

            latitudLabel.innerHTML = `LATITUD
            <span class="tooltip">
              <i class="fas fa-question-circle help-icon"></i>
              <span class="tooltip-content">
                Coordenada Y (Latitud) de la ubicación exacta de la
                estructura en el sistema de coordenadas MAGNA-SIRGAS. Rango
                válido: 1,000,000 - 1,600,000.
              </span>
            </span>`;

            // Ocultar campos finales
            if (longitudFinalGroup) longitudFinalGroup.style.display = "none";
            if (latitudFinalGroup) latitudFinalGroup.style.display = "none";

            // Bloquear campos cantidad y número de conductores
            if (cantidadField) {
              cantidadField.readOnly = true;
              cantidadField.classList.add("bg-gray-100", "cursor-not-allowed");
            }
            if (numeroConductoresField) {
              numeroConductoresField.readOnly = true;
              numeroConductoresField.classList.add(
                "bg-gray-100",
                "cursor-not-allowed"
              );
            }
          } else {
            // En conductor, equipos, transformador: labels iniciales, mostrar campos finales, campos desbloqueados
            longitudLabel.innerHTML = `LONGITUD INICIAL
            <span class="tooltip">
              <i class="fas fa-question-circle help-icon"></i>
              <span class="tooltip-content">
                Coordenada X (Longitud Inicial) de la ubicación de inicio en el sistema de coordenadas MAGNA-SIRGAS. Rango
                válido: 800,000 - 1,300,000.
              </span>
            </span>`;

            latitudLabel.innerHTML = `LATITUD INICIAL
            <span class="tooltip">
              <i class="fas fa-question-circle help-icon"></i>
              <span class="tooltip-content">
                Coordenada Y (Latitud Inicial) de la ubicación de inicio en el sistema de coordenadas MAGNA-SIRGAS. Rango
                válido: 1,000,000 - 1,600,000.
              </span>
            </span>`;

            // Mostrar campos finales
            if (longitudFinalGroup) longitudFinalGroup.style.display = "block";
            if (latitudFinalGroup) latitudFinalGroup.style.display = "block";

            // Desbloquear campos cantidad y número de conductores
            if (cantidadField) {
              cantidadField.readOnly = false;
              cantidadField.classList.remove(
                "bg-gray-100",
                "cursor-not-allowed"
              );
            }
            if (numeroConductoresField) {
              numeroConductoresField.readOnly = false;
              numeroConductoresField.classList.remove(
                "bg-gray-100",
                "cursor-not-allowed"
              );
            }
          }

          console.log(`Campos actualizados para el paso: ${step}`);
        }

        // Exponer funciones globalmente
        window.navigateToStep = navigateToStep;
        window.validateCoordinate = validateCoordinate;

        // ========== MAPEO DE PROYECTOS COMPLETOS ==========

        const PROYECTO_COMPLETO_MAPPING = {
          "Expansión de redes de distribución": {
            banco: "NEG0720TYD",
            contratos: [
              {
                codigo: "CW321301",
                contratista: "INGESSA",
                regional: "CÚCUTA Y PAMPLONA"
              },
              {
                codigo: "CW324382",
                contratista: "ENECON",
                regional: "OCAÑA Y AGUACHICA"
              }
            ],
          },
          "Reposición de redes de distribución": {
            banco: "NEG0717TYD",
            contratos: [
              {
                codigo: "CW321301",
                contratista: "INGESSA",
                regional: "CÚCUTA Y PAMPLONA"
              },
              {
                codigo: "CW324382",
                contratista: "ENECON",
                regional: "OCAÑA Y AGUACHICA"
              }
            ],
          },
          "Gestión y control pérdidas de energía - CENS": {
            banco: "PEI0144TYD",
            contratos: [
              {
                codigo: "Por definir",
                contratista: "Por definir",
                regional: "Por definir"
              }
            ],
          },
          "Reconfiguración Planta Zulia 13.8kV": {
            banco: "PEI1198TYD",
            contratos: [
              {
                codigo: "Por definir",
                contratista: "Por definir",
                regional: "Por definir"
              }
            ],
          },
          "Automatización de redes distribución CENS": {
            banco: "NEG0719TYD",
            contratos: [
              {
                codigo: "Por definir",
                contratista: "Por definir",
                regional: "Por definir"
              }
            ],
          },
          "Electrificación Rural CENS": {
            banco: "NEG0721TYD",
            contratos: [
              {
                codigo: "Por definir",
                contratista: "Por definir",
                regional: "Por definir"
              }
            ],
          },
          "Mantenimiento redes de distribución": {
            banco: "NEG1175TYD",
            contratos: [
              {
                codigo: "Por definir",
                contratista: "Por definir",
                regional: "Por definir"
              }
            ],
          }
        };

        console.log(
          "Mapeo Proyecto-Banco cargado correctamente:",
          Object.keys(PROYECTO_BANCO_MAPPING).length,
          "proyectos disponibles"
        );

        console.log(
          "Mapeo Proyecto-Completo cargado correctamente:",
          Object.keys(PROYECTO_COMPLETO_MAPPING).length,
          "proyectos con contratos disponibles"
        );

        // Mapeo de municipios a departamentos y regionales
        const MUNICIPIO_MAPPING = {
          MORALES: { departamento: "BOLIVAR", regional: "AGUACHICA" },
          AGUACHICA: { departamento: "CESAR", regional: "AGUACHICA" },
          GAMARRA: { departamento: "CESAR", regional: "AGUACHICA" },
          GONZALEZ: { departamento: "CESAR", regional: "OCAÑA" },
          "LA GLORIA": { departamento: "CESAR", regional: "AGUACHICA" },
          PAILITAS: { departamento: "CESAR", regional: "AGUACHICA" },
          PELAYA: { departamento: "CESAR", regional: "AGUACHICA" },
          "RIO DE ORO": { departamento: "CESAR", regional: "OCAÑA" },
          "SAN ALBERTO": { departamento: "CESAR", regional: "OCAÑA" },
          "SAN MARTIN": { departamento: "CESAR", regional: "OCAÑA" },
          ÁBREGO: { departamento: "NORTE DE SANTANDER", regional: "OCAÑA" },
          ARBOLEDAS: { departamento: "NORTE DE SANTANDER", regional: "CUCUTA" },
          BOCHALEMA: {
            departamento: "NORTE DE SANTANDER",
            regional: "PAMPLONA",
          },
          BUCARASICA: { departamento: "NORTE DE SANTANDER", regional: "TIBÚ" },
          CÁCHIRA: {
            departamento: "NORTE DE SANTANDER",
            regional: "AGUACHICA",
          },
          CÁCOTA: { departamento: "NORTE DE SANTANDER", regional: "PAMPLONA" },
          CHINÁCOTA: {
            departamento: "NORTE DE SANTANDER",
            regional: "PAMPLONA",
          },
          CHITAGÁ: { departamento: "NORTE DE SANTANDER", regional: "PAMPLONA" },
          CONVENCIÓN: { departamento: "NORTE DE SANTANDER", regional: "OCAÑA" },
          CÚCUTA: { departamento: "NORTE DE SANTANDER", regional: "CUCUTA" },
          CUCUTILLA: { departamento: "NORTE DE SANTANDER", regional: "CUCUTA" },
          DURANIA: { departamento: "NORTE DE SANTANDER", regional: "PAMPLONA" },
          "EL CARMEN": {
            departamento: "NORTE DE SANTANDER",
            regional: "OCAÑA",
          },
          "EL TARRA": { departamento: "NORTE DE SANTANDER", regional: "OCAÑA" },
          "EL ZULIA": {
            departamento: "NORTE DE SANTANDER",
            regional: "CUCUTA",
          },
          GRAMALOTE: { departamento: "NORTE DE SANTANDER", regional: "CUCUTA" },
          HACARÍ: { departamento: "NORTE DE SANTANDER", regional: "OCAÑA" },
          HERRÁN: { departamento: "NORTE DE SANTANDER", regional: "PAMPLONA" },
          "LA ESPERANZA": {
            departamento: "NORTE DE SANTANDER",
            regional: "AGUACHICA",
          },
          "LA PLAYA": { departamento: "NORTE DE SANTANDER", regional: "OCAÑA" },
          LABATECA: {
            departamento: "NORTE DE SANTANDER",
            regional: "PAMPLONA",
          },
          "LOS PATIOS": {
            departamento: "NORTE DE SANTANDER",
            regional: "CUCUTA",
          },
          LOURDES: { departamento: "NORTE DE SANTANDER", regional: "CUCUTA" },
          MUTISCUA: {
            departamento: "NORTE DE SANTANDER",
            regional: "PAMPLONA",
          },
          OCAÑA: { departamento: "NORTE DE SANTANDER", regional: "OCAÑA" },
          PAMPLONA: {
            departamento: "NORTE DE SANTANDER",
            regional: "PAMPLONA",
          },
          PAMPLONITA: {
            departamento: "NORTE DE SANTANDER",
            regional: "PAMPLONA",
          },
          "PUERTO SANTANDER": {
            departamento: "NORTE DE SANTANDER",
            regional: "CUCUTA",
          },
          RAGONVALIA: {
            departamento: "NORTE DE SANTANDER",
            regional: "PAMPLONA",
          },
          SALAZAR: { departamento: "NORTE DE SANTANDER", regional: "CUCUTA" },
          "SAN CALIXTO": {
            departamento: "NORTE DE SANTANDER",
            regional: "OCAÑA",
          },
          "SAN CAYETANO": {
            departamento: "NORTE DE SANTANDER",
            regional: "CUCUTA",
          },
          SANTIAGO: { departamento: "NORTE DE SANTANDER", regional: "CUCUTA" },
          SARDINATA: { departamento: "NORTE DE SANTANDER", regional: "TIBÚ" },
          SILOS: { departamento: "NORTE DE SANTANDER", regional: "PAMPLONA" },
          TEORAMA: { departamento: "NORTE DE SANTANDER", regional: "OCAÑA" },
          TIBÚ: { departamento: "NORTE DE SANTANDER", regional: "TIBÚ" },
          TOLEDO: { departamento: "NORTE DE SANTANDER", regional: "PAMPLONA" },
          "VILLA DEL ROSARIO": {
            departamento: "NORTE DE SANTANDER",
            regional: "CUCUTA",
          },
          "VILLA CARO": {
            departamento: "NORTE DE SANTANDER",
            regional: "CUCUTA",
          },
          CONCEPCION: { departamento: "SANTANDER", regional: "PAMPLONA" },
        };

        // Mapeo de municipios a circuitos
        const MUNICIPIO_CIRCUITO_MAPPING = {
          ÁBREGO: [
            "ABRC1",
            "ABRC2",
            "ABRC3",
            "AGUC4",
            "AGUC7",
            "CACHIRA",
            "CONSAL_CARMEN",
            "ELSC68",
            "GRAC3",
            "LOS_ALPES",
            "OCAGONZALES",
            "OCAILA5",
            "OCALA_PLAYA",
            "OCAOCANA2",
            "OCAOCANA3",
            "TARC1",
          ],
          CONVENCIÓN: [
            "ABRC1",
            "CONS65",
            "CONS75",
            "CONS95",
            "CONSAL_CARMEN",
            "CONSAL_CONVE",
            "CONSAL_SANPABLO",
            "CONSAL_TEORA",
            "OCAIC25",
            "SPAC2",
          ],
          "LA PLAYA": ["ABRC1", "CONSAL_TEORA", "OCALA_PLAYA", "OCAOCANA3"],
          OCAÑA: [
            "ABRC1",
            "ABRC2",
            "ABRC3",
            "AGUC4",
            "AGUC8",
            "CONSAL_CARMEN",
            "CONSAL_CONVE",
            "CONSAL_TEORA",
            "ELSC69",
            "ESCC63",
            "OCAGONZALES",
            "OCAIA15",
            "OCAIC25",
            "OCAILA5",
            "OCALA_PLAYA",
            "OCAOCANA1",
            "OCAOCANA2",
            "OCAOCANA3",
            "SEVC11",
            "TOLLABATECA",
          ],
          HACARÍ: ["ABRC2", "CONSAL_TEORA", "OCALA_PLAYA", "TARC1"],
          "LA ESPERANZA": [
            "ABRC2",
            "AGUC2",
            "AGUC8",
            "LOS_ALPES",
            "SANALBERTO",
          ],
          "SAN ALBERTO": ["ABRC2", "ABRC3", "LOS_ALPES"],
          "SAN MARTÍN": ["ABRC3", "OCALA_PLAYA"],
          "LOS PATIOS": [
            "ABRC3",
            "ATAC86",
            "ATAC87",
            "BELC21",
            "BELC24",
            "BELC27",
            "BELC29",
            "BELC30",
            "BELC31",
            "BELC35",
            "CAMC3",
            "CORC1",
            "ELSC68",
            "ELSC69",
            "ESCC63",
            "INSC92",
            "INSC93",
            "INSC94",
            "OCAOCANA2",
            "P_IL30",
            "PALCHINACOTA",
            "PALDONJUANA",
            "PALRAGONVALIA",
            "PAMC4",
            "PATC1",
            "PATC2",
            "PATC3",
            "PATIOS",
            "PLZ283B1",
            "SALC4",
            "SANC43",
            "SANC45",
            "SANC49",
            "SANC53",
            "SANC54",
            "SANC58",
            "SANC59",
            "SANOL25",
            "SEVC7",
            "SEVC16",
            "TARC1",
            "TIBTIBU2",
            "TOLPALERMO",
            "TOLTOLEDO",
          ],
          AGUACHICA: [
            "AGUC2",
            "AGUC3",
            "AGUC4",
            "AGUC5",
            "AGUC7",
            "AGUC8",
            "AGUIG5",
            "AGUIG6",
            "AYAC1",
            "AYAC2",
            "BELC21",
            "BELC23",
            "BELC29",
            "BUIA25",
            "BUIA45",
            "BUTC1",
            "BUTC2",
            "CONSAL_CARMEN",
            "ELSC68",
            "GAMC1",
            "GAMC2",
            "GAMC3",
            "MONTESITOS",
            "OCAGONZALES",
            "OCAIA15",
            "OCAOCANA2",
            "PATC1",
            "PELC2",
            "SANC46",
            "SANC55",
            "TARC2",
            "ZULC3",
          ],
          CÚCUTA: [
            "AGUC2",
            "AGUC4",
            "ATAC86",
            "ATAC87",
            "ATAC88",
            "BELC21",
            "BELC22",
            "BELC23",
            "BELC24",
            "BELC27",
            "BELC28",
            "BELC29",
            "BELC30",
            "BELC31",
            "BELC33",
            "BELC35",
            "BELC36",
            "BELC38",
            "CAMC2",
            "CLIL20",
            "CONSAL_CARMEN",
            "CONSAL_TEORA",
            "CORC1",
            "CULC1",
            "CULC2",
            "ELSC68",
            "ELSC69",
            "ESCC61",
            "ESCC62",
            "ESCC63",
            "GAMC3",
            "GRAC2",
            "GRAC3",
            "IL70",
            "INSC76",
            "INSC77",
            "INSC91",
            "INSC92",
            "INSC93",
            "INSC94",
            "INSIL60",
            "OCAGONZALES",
            "OCAOCANA3",
            "P_IL30",
            "PALCHINACOTA",
            "PALDONJUANA",
            "PALRAGONVALIA",
            "PAMC2",
            "PAMC3",
            "PAMC4",
            "PATC1",
            "PATC2",
            "PATC3",
            "PLZ263B1",
            "PLZ283B1",
            "PLZS10",
            "PLZS20",
            "SALC4",
            "SAMSAMORE",
            "SANC43",
            "SANC45",
            "SANC46",
            "SANC48",
            "SANC49",
            "SANC51",
            "SANC52",
            "SANC53",
            "SANC54",
            "SANC55",
            "SANC56",
            "SANC57",
            "SANC58",
            "SANC59",
            "SANIL15",
            "SANOL15",
            "SANOL25",
            "SANOL35",
            "SANOL45",
            "SANOL55",
            "SARC2",
            "SEVC11",
            "SEVC16",
            "SEVC17",
            "SEVC21",
            "SEVC22",
            "SEVC3",
            "SEVC4",
            "SEVC5",
            "SEVC6",
            "SEVC7",
            "SEVS10",
            "SEVS20",
            "SRQC3",
            "TARC1",
            "TOLLABATECA",
          ],
          GAMARRA: [
            "AGUC2",
            "AGUC3",
            "AGUC4",
            "AGUC5",
            "BUIA25",
            "BUTC1",
            "GAMC1",
            "GAMC2",
            "GAMC3",
          ],
          MORALES: ["AGUC2", "AGUC5", "AGUC7", "GAMC1", "GAMC3"],
          PELAYA: ["AGUC5", "AYAA31", "LAMATA", "PELC1", "PELC2"],
          "RÍO DE ORO": [
            "AGUC5",
            "BUTC2",
            "MONTESITOS",
            "OCAGONZALES",
            "OCAIA15",
            "OCALA_PLAYA",
            "OCAOCANA1",
            "OCAOCANA2",
            "OCAOCANA3",
          ],
          "EL CARMEN": [
            "AGUC4",
            "AYAC1",
            "CONS75",
            "CONSAL_CARMEN",
            "CONSAL_CONVE",
            "CONSAL_TEORA",
            "ESCC63",
            "PAMC3",
            "SPAC2",
            "TARC1",
          ],
          "VILLA DEL ROSARIO": [
            "AGUC4",
            "ATAC86",
            "ATAC87",
            "BELC21",
            "BELC22",
            "BELC23",
            "BELC28",
            "BELC29",
            "BELC30",
            "BELC31",
            "CAMC3",
            "CULC1",
            "ELSC68",
            "ELSC69",
            "ESCC61",
            "ESCC62",
            "ESCC63",
            "INSC91",
            "INSC92",
            "INSC93",
            "INSC94",
            "PATC1",
            "PATC2",
            "PATC3",
            "PLZ283B1",
            "SALC1",
            "SANC43",
            "SANC45",
            "SANC46",
            "SANC49",
            "SANC53",
            "SANC54",
            "SANC55",
            "SANC57",
            "SANC58",
            "SANC59",
            "SANIL15",
            "SANOL25",
            "SANOL35",
            "SANOL45",
            "SEVC3",
            "SEVC4",
            "SEVC5",
            "SEVC7",
            "SEVC11",
            "SEVC16",
            "SPAC2",
            "TARC2",
          ],
          CHINÁCOTA: [
            "ATAC86",
            "ELSC68",
            "P_IL30",
            "PALBOCHALEMA",
            "PALCHINACOTA",
            "PALDONJUANA",
            "PALRAGONVALIA",
            "PATC2",
            "PLZ283B1",
            "SALC4",
            "TOLPALERMO",
            "TOLTOLEDO",
          ],
          "EL ZULIA": [
            "ATAC86",
            "BELC24",
            "BELC30",
            "BELC33",
            "BELC36",
            "CAMC3",
            "CLIL20",
            "CORC1",
            "CORC2",
            "CORC3",
            "CULC1",
            "CULC2",
            "ELSC69",
            "GRAC2",
            "IL70",
            "INSC91",
            "INSC92",
            "INSC93",
            "PLZ263B1",
            "PLZ283B1",
            "PAMC4",
            "PATC1",
            "SALC4",
            "SARC2",
            "SEVC4",
            "SEVC5",
            "SEVC6",
            "SEVC16",
            "SRQC1",
            "TIBTIBU2",
            "ZULC1",
            "ZULC2",
            "ZULC3",
          ],
          "SAN CAYETANO": [
            "ATAC86",
            "BELC23",
            "BELC29",
            "BELC30",
            "BELC36",
            "CORC1",
            "CORC2",
            "CORC3",
            "CULC1",
            "CULC2",
            "ELSC68",
            "GRAC1",
            "INSIL60",
            "PALDONJUANA",
            "PATC2",
            "SEVC5",
            "SEVC16",
          ],
          TOLEDO: [
            "ATAC86",
            "PALBOCHALEMA",
            "PAMC2",
            "PAMC4",
            "SAMSAMORE",
            "SEVC16",
            "TOLLABATECA",
            "TOLPALERMO",
            "TOLTOLEDO",
          ],
          HERRÁN: [
            "ATAC88",
            "PALCHINACOTA",
            "PALRAGONVALIA",
            "PATC2",
            "SEVC5",
            "SEVC16",
          ],
          "LA GLORIA": [
            "AYAA31",
            "AYAC1",
            "AYAC2",
            "BUIA25",
            "CONS75",
            "CONSAL_CARMEN",
            "GAMC1",
            "PELC2",
          ],
          PAILITAS: ["PELC2"],
          ARBOLEDAS: ["BELC30", "CORC1", "PLZ263B1", "SALC1", "SALC4", "SEVC4"],
          SARDINATA: [
            "BELC28",
            "BELC31",
            "BELC36",
            "CAMC2",
            "CAMC3",
            "CLIL20",
            "CORC1",
            "CULC1",
            "CULC2",
            "ESCC63",
            "GRAC2",
            "IL70",
            "INSC94",
            "ORUC1",
            "SALC2",
            "SALC3",
            "SANC46",
            "SANC53",
            "SARC1",
            "SARC2",
            "SEVC7",
            "SRQC1",
            "SRQC2",
            "SRQC3",
            "TIBG11",
          ],
          GRAMALOTE: [
            "BELC36",
            "CORC2",
            "CULC1",
            "GRAC1",
            "GRAC2",
            "GRAC3",
            "SALC2",
            "SALC3",
            "SALC4",
            "SEVC6",
          ],
          LOURDES: ["BELC36", "GRAC2", "GRAC3", "PLZ283B1", "PATC2", "SEVC16"],
          SALAZAR: [
            "BELC36",
            "CACHIRA",
            "GRAC1",
            "GRAC3",
            "SALC1",
            "SALC2",
            "SALC3",
            "SALC4",
            "SEVC16",
          ],
          SANTIAGO: ["BELC36", "GRAC1", "SALC3", "SEVC16"],
          BUCARASICA: ["GRAC2", "GRAC3", "SARC1", "SARC2"],
          CÁCHIRA: [
            "CACHIRA",
            "LA_MIEL",
            "LOS_ALPES",
            "LOS_MANGOS",
            "SALC1",
            "SAN_ANTONIO",
            "SANALBERTO",
          ],
          "VILLA CARO": [
            "CACHIRA",
            "ELSC68",
            "GRAC2",
            "GRAC3",
            "SALC2",
            "SEVC5",
            "SRQC2",
          ],
          TIBÚ: [
            "CAMC1",
            "CAMC2",
            "CAMC3",
            "CONS95",
            "CONSAL_CARMEN",
            "ELSC68",
            "GABGABARRA",
            "ORUC1",
            "ORUC2",
            "PALBOCHALEMA",
            "PLZ263B1",
            "PLZ283B1",
            "PLZS20",
            "SALC2",
            "SARC2",
            "TARC1",
            "TIBCAMP2",
            "TIBG11",
            "TIBL422",
            "TIBO11",
            "TIBPOZOS",
            "TIBTIBU1",
            "TIBTIBU2",
            "TIBTIBU3",
            "ZULC3",
          ],
          "EL TARRA": [
            "CONS65",
            "CONS95",
            "CONSAL_CARMEN",
            "CONSAL_CONVE",
            "CONSAL_TEORA",
            "OCALA_PLAYA",
            "OCAOCANA1",
            "OCAOCANA2",
            "ORUC1",
            "ORUC2",
            "PAMC4",
            "SPAC2",
            "TARC1",
            "TARC2",
            "TIBO11",
          ],
          TEORAMA: [
            "CONS65",
            "CONS95",
            "CONSAL_CARMEN",
            "CONSAL_CONVE",
            "CONSAL_SANPABLO",
            "CONSAL_TEORA",
            "OCAGONZALES",
            "OCAIC25",
            "SPAC2",
            "TARC1",
            "TARC2",
          ],
          CHITAGÁ: [
            "CONSAL_CONVE",
            "PALRAGONVALIA",
            "PAMC2",
            "SEVC16",
            "TOLLABATECA",
            "TOLTOLEDO",
          ],
          GONZÁLEZ: [
            "CONSAL_CARMEN",
            "CONSAL_CONVE",
            "OCAGONZALES",
            "OCAOCANA3",
          ],
          "SAN CALIXTO": [
            "CONSAL_TEORA",
            "OCAGONZALES",
            "OCALA_PLAYA",
            "SPAC2",
            "TARC1",
            "TARC2",
          ],
          BOCHALEMA: [
            "CORC1",
            "P_IL30",
            "PALBOCHALEMA",
            "PALCHINACOTA",
            "PALDONJUANA",
            "PAMC4",
            "PATC2",
            "SALC1",
            "SEVC16",
            "TOLPALERMO",
          ],
          DURANIA: [
            "CORC1",
            "CORC2",
            "PALBOCHALEMA",
            "PALDONJUANA",
            "PAMC4",
            "PLZ283B1",
            "SALC1",
            "SALC4",
            "SANC54",
            "SANC57",
            "SEVC16",
          ],
          "PUERTO SANTANDER": [
            "CULC2",
            "GRAC3",
            "INSC92",
            "PLZ263B1",
            "PLZ283B1",
            "SRQC2",
          ],
          RAGONVALIA: ["ELSC68", "PALRAGONVALIA", "PATC2", "SEVC16"],
          CUCUTILLA: ["GRAC2", "PAMC2", "SALC1", "SALC4"],
          PAMPLONITA: [
            "GRAC2",
            "PALBOCHALEMA",
            "PALCHINACOTA",
            "PALDONJUANA",
            "PAMC2",
            "PAMC3",
            "PAMC4",
            "SALC1",
            "SANC54",
            "SEVC16",
            "TOLPALERMO",
            "TOLTOLEDO",
          ],
          PAMPLONA: [
            "GRAC3",
            "PALCHINACOTA",
            "PALDONJUANA",
            "PALRAGONVALIA",
            "PAMC2",
            "PAMC3",
            "PAMC4",
            "SAMSAMORE",
            "SEVC4",
            "SEVC16",
            "TOLLABATECA",
            "TOLPALERMO",
            "TOLTOLEDO",
          ],
          CÁCOTA: [
            "PALCHINACOTA",
            "PAMC2",
            "PAMC4",
            "TOLLABATECA",
            "TOLPALERMO",
          ],
          MUTISCUA: ["PAMC2", "PAMC3", "PAMC4", "SEVC16", "TOLLABATECA"],
          SILOS: [
            "PALRAGONVALIA",
            "PAMC2",
            "PAMC4",
            "SAMSAMORE",
            "SEVC16",
            "TOLLABATECA",
          ],
          LABATECA: ["SAMSAMORE", "TOLLABATECA", "TOLPALERMO", "TOLTOLEDO"],
        };

        console.log(
          "Mapeo Municipio-Circuito cargado correctamente:",
          Object.keys(MUNICIPIO_CIRCUITO_MAPPING).length,
          "municipios con circuitos disponibles"
        );

        // Variables globales
        const ucSelect = document.getElementById("uc_codigo");
        const descripcionUc = document.getElementById("descripcion_uc");

        // Llenar el select de UC con el mapping completo (pero mantenlo disabled)
        for (const [codigo, descripcion] of Object.entries(UC_MAPPING)) {
          const option = document.createElement("option");
          option.value = codigo;
          option.textContent = codigo;
          ucSelect.appendChild(option);
        }

        // Auto-completar UC basado en selecciones de estructura nueva
        function autoCompleteUC() {
          const material = document.getElementById("material_nueva").value;
          const altura = document.getElementById("altura_nueva").value;
          const poblacion = document.getElementById("poblacion_nueva").value;
          const disposicion =
            document.getElementById("disposicion_nueva").value;
          const tipoRed = document.getElementById("tipo_red_nueva").value;

          console.log("AutoComplete UC - Valores obtenidos:", {
            material,
            altura,
            poblacion,
            disposicion,
            tipoRed,
          });

          // Autocompletar cuando se llenen algunos campos clave
          if (material && altura && poblacion && disposicion && tipoRed) {
            console.log("Todos los campos están llenos, buscando UC...");
            const suggestedUC = getUCFromStructure(
              material,
              altura,
              poblacion,
              disposicion,
              tipoRed
            );
            console.log("UC sugerido:", suggestedUC);

            if (suggestedUC) {
              // Autocompletar en la sección de estructura nueva
              ucSelect.disabled = false;
              ucSelect.value = suggestedUC;
              descripcionUc.value = UC_MAPPING[suggestedUC];
              ucSelect.disabled = true;

              // Agregar clase visual para indicar que está autocompletado
              ucSelect.classList.add("bg-green-50", "border-green-300");
              descripcionUc.classList.add("bg-green-50", "border-green-300");

              // Mostrar indicador visual
              document
                .getElementById("uc_indicator")
                .classList.remove("hidden");

              console.log(
                "UC autocompletado exitosamente:",
                suggestedUC,
                "->",
                UC_MAPPING[suggestedUC]
              );
            } else {
              console.log("No se encontró UC para la combinación:", {
                material,
                altura,
                poblacion,
                disposicion,
                tipoRed,
              });
            }
          } else {
            // Si no todos los campos están llenos, limpiar UC
            console.log("Faltan campos por llenar, limpiando UC...");
            ucSelect.value = "";
            descripcionUc.value = "";
            ucSelect.classList.remove("bg-green-50", "border-green-300");
            descripcionUc.classList.remove("bg-green-50", "border-green-300");

            // Ocultar indicadores visuales
            document.getElementById("uc_indicator").classList.add("hidden");
          }
        }

        // Función para actualizar contratos según proyecto seleccionado
        function actualizarMunicipiosPorContrato() {
          const contratoSeleccionado =
            document.getElementById("contrato").value;
          const municipioSelect = document.getElementById("municipio");
          const nombreProyecto = document.getElementById("nombre").value;

          console.log(
            "ActualizarMunicipiosPorContrato - Contrato seleccionado:",
            contratoSeleccionado
          );

          // Limpiar opciones existentes (excepto la primera)
          municipioSelect.innerHTML =
            '<option value="">Seleccionar municipio</option>';

          if (contratoSeleccionado && contratoSeleccionado !== "Por definir") {
            // Buscar la regional del contrato seleccionado
            let regionalDelContrato = null;

            if (nombreProyecto && PROYECTO_COMPLETO_MAPPING[nombreProyecto]) {
              const contratos =
                PROYECTO_COMPLETO_MAPPING[nombreProyecto].contratos;
              const contratoData = contratos.find(
                (c) => c.codigo === contratoSeleccionado
              );
              if (contratoData && contratoData.regional !== "Por definir") {
                regionalDelContrato = contratoData.regional;
              }
            }

            console.log("Regional del contrato:", regionalDelContrato);

            if (regionalDelContrato) {
              // Filtrar municipios por la regional del contrato
              const municipiosFiltrados = Object.keys(MUNICIPIO_MAPPING).filter(
                (municipio) => {
                  const datosM = MUNICIPIO_MAPPING[municipio];
                  // Comparar regional, considerando variaciones como "CÚCUTA Y PAMPLONA" = "CUCUTA" + "PAMPLONA"
                  if (regionalDelContrato === "CÚCUTA Y PAMPLONA") {
                    return (
                      datosM.regional === "CUCUTA" ||
                      datosM.regional === "PAMPLONA"
                    );
                  } else if (regionalDelContrato === "OCAÑA Y AGUACHICA") {
                    return (
                      datosM.regional === "OCAÑA" ||
                      datosM.regional === "AGUACHICA"
                    );
                  } else {
                    return datosM.regional === regionalDelContrato;
                  }
                }
              );

              if (municipiosFiltrados.length > 0) {
                // Agregar municipios filtrados al select
                municipiosFiltrados.forEach((municipio) => {
                  const option = document.createElement("option");
                  option.value = municipio;
                  option.textContent = municipio;
                  municipioSelect.appendChild(option);
                });

                // Agregar indicador visual
                municipioSelect.classList.add("bg-blue-50", "border-blue-300");

                console.log(
                  `Municipios filtrados para la regional ${regionalDelContrato}:`,
                  municipiosFiltrados.length,
                  "opciones disponibles"
                );
              } else {
                // No hay municipios para esta regional
                const option = document.createElement("option");
                option.value = "";
                option.textContent = `No hay municipios disponibles para la regional ${regionalDelContrato}`;
                option.disabled = true;
                municipioSelect.appendChild(option);

                municipioSelect.classList.add("bg-red-50", "border-red-300");
                console.log(
                  `No se encontraron municipios para la regional ${regionalDelContrato}`
                );
              }
            } else {
              // Si no hay regional específica, mostrar todos los municipios
              Object.keys(MUNICIPIO_MAPPING).forEach((municipio) => {
                const option = document.createElement("option");
                option.value = municipio;
                option.textContent = municipio;
                municipioSelect.appendChild(option);
              });

              // Remover indicador visual
              municipioSelect.classList.remove(
                "bg-blue-50",
                "border-blue-300",
                "bg-red-50",
                "border-red-300"
              );

              console.log(
                "Mostrando todos los municipios (sin filtro de regional)"
              );
            }
          } else {
            // Si el contrato es "Por definir" o no hay contrato, mostrar todos los municipios
            Object.keys(MUNICIPIO_MAPPING).forEach((municipio) => {
              const option = document.createElement("option");
              option.value = municipio;
              option.textContent = municipio;
              municipioSelect.appendChild(option);
            });

            // Remover indicador visual
            municipioSelect.classList.remove(
              "bg-blue-50",
              "border-blue-300",
              "bg-red-50",
              "border-red-300"
            );

            console.log(
              "Mostrando todos los municipios (contrato 'Por definir' o no seleccionado)"
            );
          }

          // Limpiar selects dependientes
          document.getElementById("alimentador").innerHTML =
            '<option value="">Seleccionar alimentador</option>';
          document
            .getElementById("alimentador")
            .classList.remove("bg-yellow-50", "border-yellow-300");
        }

        function actualizarContratos() {
          const nombreProyecto = document.getElementById("nombre").value;
          const contratoSelect = document.getElementById("contrato");

          console.log(
            "ActualizarContratos - Proyecto seleccionado:",
            nombreProyecto
          );

          // Limpiar opciones existentes (excepto la primera)
          contratoSelect.innerHTML =
            '<option value="">Seleccionar contrato</option>';

          if (nombreProyecto && PROYECTO_COMPLETO_MAPPING[nombreProyecto]) {
            const contratos =
              PROYECTO_COMPLETO_MAPPING[nombreProyecto].contratos;

            // Agregar opciones de contratos
            contratos.forEach((contrato) => {
              const option = document.createElement("option");
              option.value = contrato.codigo;
              option.textContent = contrato.codigo;
              option.dataset.contratista = contrato.contratista;
              option.dataset.regional = contrato.regional;
              contratoSelect.appendChild(option);
            });

            // Agregar indicador visual
            contratoSelect.classList.add("bg-green-50", "border-green-300");

            console.log(
              `Contratos actualizados para ${nombreProyecto}:`,
              contratos.length,
              "opciones disponibles"
            );
          } else {
            // Usar contratos genéricos si no hay mapeo específico
            const contratosGenericos = ["Por definir"];

            contratosGenericos.forEach((contrato) => {
              const option = document.createElement("option");
              option.value = contrato;
              option.textContent = contrato;
              contratoSelect.appendChild(option);
            });

            // Remover indicador visual
            contratoSelect.classList.remove("bg-green-50", "border-green-300");

            if (nombreProyecto) {
              console.log(
                "No se encontraron contratos específicos para proyecto:",
                nombreProyecto,
                "- usando contratos genéricos"
              );
            }
          }

          // Limpiar selects dependientes
          document.getElementById("municipio").innerHTML =
            '<option value="">Seleccionar municipio</option>';
          document
            .getElementById("municipio")
            .classList.remove("bg-blue-50", "border-blue-300");
          document.getElementById("alimentador").innerHTML =
            '<option value="">Seleccionar alimentador</option>';
          document
            .getElementById("alimentador")
            .classList.remove("bg-yellow-50", "border-yellow-300");

          // Actualizar municipios según el contrato por defecto (si hay uno)
          setTimeout(() => {
            if (contratoSelect.value) {
              actualizarMunicipiosPorContrato();
            }
          }, 100);
        }

        // Función para autocompletar banco del proyecto
        function autoCompleteBanco() {
          const nombreProyecto = document.getElementById("nombre").value;
          const bancoProyecto = document.getElementById("banco_proyecto");

          console.log(
            "AutoCompleteBanco - Proyecto seleccionado:",
            nombreProyecto
          );

          // Verificar primero el mapeo completo
          if (nombreProyecto && PROYECTO_COMPLETO_MAPPING[nombreProyecto]) {
            const proyectoData = PROYECTO_COMPLETO_MAPPING[nombreProyecto];
            bancoProyecto.value = proyectoData.banco;
            bancoProyecto.classList.add("bg-green-50", "border-green-300");
            console.log(
              "Banco autocompletado (mapeo completo):",
              nombreProyecto,
              "->",
              proyectoData.banco
            );
          }
          // Fallback al mapeo simple
          else if (nombreProyecto && PROYECTO_BANCO_MAPPING[nombreProyecto]) {
            bancoProyecto.value = PROYECTO_BANCO_MAPPING[nombreProyecto];
            bancoProyecto.classList.add("bg-green-50", "border-green-300");
            console.log(
              "Banco autocompletado (mapeo simple):",
              nombreProyecto,
              "->",
              PROYECTO_BANCO_MAPPING[nombreProyecto]
            );
          } else {
            bancoProyecto.value = "";
            bancoProyecto.classList.remove("bg-green-50", "border-green-300");
            console.log("No se encontró mapeo para proyecto:", nombreProyecto);
          }

          // Actualizar contratos después del banco
          actualizarContratos();
        }

        // Función para actualizar circuitos según municipio seleccionado
        function actualizarCircuitos() {
          const municipioSeleccionado =
            document.getElementById("municipio").value;
          const alimentadorSelect = document.getElementById("alimentador");

          console.log(
            "ActualizarCircuitos - Municipio seleccionado:",
            municipioSeleccionado
          );

          // Limpiar opciones existentes (excepto la primera)
          alimentadorSelect.innerHTML = '<option value="">Seleccionar</option>';

          if (
            municipioSeleccionado &&
            MUNICIPIO_CIRCUITO_MAPPING[municipioSeleccionado]
          ) {
            const circuitos = MUNICIPIO_CIRCUITO_MAPPING[municipioSeleccionado];

            // Agregar opciones de circuitos ordenadas
            circuitos.sort().forEach((circuito) => {
              const option = document.createElement("option");
              option.value = circuito;
              option.textContent = circuito;
              alimentadorSelect.appendChild(option);
            });

            // Agregar indicador visual
            alimentadorSelect.classList.add("bg-green-50", "border-green-300");

            console.log(
              `Circuitos actualizados para ${municipioSeleccionado}:`,
              circuitos.length,
              "opciones disponibles"
            );
          } else {
            // Remover indicador visual si no hay circuitos
            alimentadorSelect.classList.remove(
              "bg-green-50",
              "border-green-300"
            );

            if (municipioSeleccionado) {
              console.log(
                "No se encontraron circuitos para municipio:",
                municipioSeleccionado
              );

              // Agregar mensaje informativo
              const option = document.createElement("option");
              option.value = "";
              option.textContent = "No hay circuitos disponibles";
              option.disabled = true;
              alimentadorSelect.appendChild(option);
            }
          }
        }

        // Función para autocompletar departamento y regional basado en municipio
        function autoCompleteMunicipio() {
          const municipioSeleccionado =
            document.getElementById("municipio").value;
          const departamentoInput = document.getElementById("departamento");
          const regionalInput = document.getElementById("regional");

          console.log(
            "AutoCompleteMunicipio - Municipio seleccionado:",
            municipioSeleccionado
          );

          if (
            municipioSeleccionado &&
            MUNICIPIO_MAPPING[municipioSeleccionado]
          ) {
            const datos = MUNICIPIO_MAPPING[municipioSeleccionado];

            // Autocompletar departamento
            departamentoInput.value = datos.departamento;
            departamentoInput.classList.add("bg-green-50", "border-green-300");

            // Autocompletar regional
            regionalInput.value = datos.regional;
            regionalInput.classList.add("bg-green-50", "border-green-300");

            console.log(
              "Departamento y regional autocompletados:",
              municipioSeleccionado,
              "->",
              datos.departamento,
              "->",
              datos.regional
            );
          } else {
            // Limpiar campos si no hay mapeo
            departamentoInput.value = "";
            departamentoInput.classList.remove(
              "bg-green-50",
              "border-green-300"
            );
            regionalInput.value = "";
            regionalInput.classList.remove("bg-green-50", "border-green-300");

            if (municipioSeleccionado) {
              console.log(
                "No se encontró mapeo para municipio:",
                municipioSeleccionado
              );
              console.log(
                "Municipios disponibles:",
                Object.keys(MUNICIPIO_MAPPING)
              );
            }
          }

          // Actualizar circuitos después del municipio
          actualizarCircuitos();
        }

        // Función para manejar el campo de estructura retirada según tipo de inversión
        function handleTipoInversion() {
          const tipoInversion = document.getElementById("t_inv").value;
          const estructuraRetirada = document.getElementById(
            "estructura_retirada_campo"
          );
          const longitud = document.getElementById("numero_x");
          const latitud = document.getElementById("numero_y");
          const cantidadField = document.getElementById("cantidad");
          const numeroConductoresField =
            document.getElementById("numero_conductores");

          // Habilitar si es tipo I (1) o III (3)
          if (tipoInversion === "I" || tipoInversion === "III") {
            estructuraRetirada.disabled = false;
            longitud.disabled = true;
            latitud.disabled = true;
            estructuraRetirada.classList.remove(
              "bg-gray-100",
              "cursor-not-allowed"
            );
            estructuraRetirada.classList.add("bg-white");
            console.log(
              "Estructura retirada habilitada para tipo de inversión:",
              tipoInversion
            );
          } else {
            // Deshabilitar si es tipo II (2) o IV (4) o vacío
            estructuraRetirada.disabled = true;
            longitud.disabled = false;
            latitud.disabled = false;
            estructuraRetirada.value = ""; // Limpiar el valor
            estructuraRetirada.classList.remove("bg-white");
            estructuraRetirada.classList.add(
              "bg-gray-100",
              "cursor-not-allowed"
            );
            console.log(
              "Estructura retirada deshabilitada para tipo de inversión:",
              tipoInversion
            );
          }

          // Gestionar campos cantidad y número de conductores según el paso actual
          // Solo en estructuras están bloqueados por defecto
          if (currentStep === "estructuras") {
            cantidadField.readOnly = true;
            cantidadField.classList.add("bg-gray-100", "cursor-not-allowed");
            numeroConductoresField.readOnly = true;
            numeroConductoresField.classList.add(
              "bg-gray-100",
              "cursor-not-allowed"
            );
          } else {
            // En otros pasos, están desbloqueados
            cantidadField.readOnly = false;
            cantidadField.classList.remove("bg-gray-100", "cursor-not-allowed");
            numeroConductoresField.readOnly = false;
            numeroConductoresField.classList.remove(
              "bg-gray-100",
              "cursor-not-allowed"
            );
          }
        }

        // Función para formatear el campo de estructura retirada
        function formatEstructuraRetirada() {
          const estructuraRetirada = document.getElementById(
            "estructura_retirada_campo"
          );

          estructuraRetirada.addEventListener("input", function (e) {
            let valor = e.target.value;

            // Remover el prefijo "Z - " si existe para procesarlo
            let numeros = valor.replace(/^Z /, "");

            // Mantener solo números
            numeros = numeros.replace(/[^0-9]/g, "");

            // Formatear con "Z - " seguido de los números
            if (numeros.length > 0) {
              e.target.value = "Z" + numeros;
            } else {
              e.target.value = "";
            }

            console.log("Estructura retirada formateada:", e.target.value);
          });

          // Formatear automáticamente cuando se enfoca el campo
          estructuraRetirada.addEventListener("focus", function (e) {
            if (e.target.value === "") {
              e.target.value = "Z";
            }
          });

          // Validar que no esté vacío cuando se desenface si hay contenido
          estructuraRetirada.addEventListener("blur", function (e) {
            if (e.target.value === "Z") {
              e.target.value = "";
            }
          });

          // Prevenir que se borre el prefijo "Z - " con backspace
          estructuraRetirada.addEventListener("keydown", function (e) {
            const valor = e.target.value;
            const cursorPos = e.target.selectionStart;

            // Si intenta borrar dentro del prefijo "Z - ", prevenir
            if (
              e.key === "Backspace" &&
              cursorPos <= 4 &&
              valor.startsWith("Z")
            ) {
              e.preventDefault();
            }
          });

          console.log("Formateo de estructura retirada configurado");
        }

        // Agregar listeners de manera segura
        const nombreSelect = document.getElementById("nombre");
        const tipoInvSelect = document.getElementById("t_inv");
        const municipioSelect = document.getElementById("municipio");
        const alimentadorSelect = document.getElementById("alimentador");
        const contratoSelect = document.getElementById("contrato");

        if (nombreSelect) {
          nombreSelect.addEventListener("change", function () {
            console.log("Evento change en nombre del proyecto:", this.value);
            autoCompleteBanco();
            actualizarContratos();
          });
          console.log("Listener agregado para nombre del proyecto");
        } else {
          console.error("No se encontró el elemento con ID 'nombre'");
        }

        if (tipoInvSelect) {
          tipoInvSelect.addEventListener("change", function () {
            console.log("Evento change en tipo de inversión:", this.value);
            handleTipoInversion();
          });
          console.log("Listener agregado para tipo de inversión");
        } else {
          console.error("No se encontró el elemento con ID 't_inv'");
        }

        if (municipioSelect) {
          municipioSelect.addEventListener("change", function () {
            console.log("Evento change en municipio:", this.value);
            autoCompleteMunicipio();
          });
          console.log("Listener agregado para municipio");
        } else {
          console.error("No se encontró el elemento con ID 'municipio'");
        }

        if (alimentadorSelect) {
          alimentadorSelect.addEventListener("change", function () {
            console.log("Evento change en alimentador:", this.value);
            // Agregar indicador visual cuando se seleccione manualmente
            if (this.value) {
              this.classList.add("bg-blue-50", "border-blue-300");
            } else {
              this.classList.remove("bg-blue-50", "border-blue-300");
            }
          });
          console.log("Listener agregado para alimentador");
        } else {
          console.error("No se encontró el elemento con ID 'alimentador'");
        }

        if (contratoSelect) {
          contratoSelect.addEventListener("change", function () {
            console.log("Evento change en contrato:", this.value);
            // Obtener datos del contrato seleccionado
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.dataset.contratista) {
              console.log("Contrato seleccionado:", {
                codigo: this.value,
                contratista: selectedOption.dataset.contratista,
                regional: selectedOption.dataset.regional,
              });
            }

            // Agregar indicador visual cuando se seleccione
            if (this.value) {
              this.classList.add("bg-blue-50", "border-blue-300");
            } else {
              this.classList.remove("bg-blue-50", "border-blue-300");
            }

            // Filtrar municipios según la regional del contrato
            actualizarMunicipiosPorContrato();
          });
          console.log("Listener agregado para contrato");
        } else {
          console.error("No se encontró el elemento con ID 'contrato'");
        }

        // Inicializar el estado del campo estructura retirada
        handleTipoInversion();

        // Configurar el formateo automático del campo estructura retirada
        formatEstructuraRetirada();

        // Configurar sincronización de campos entre secciones
        setupFieldSynchronization();

        // Agregar listeners para autocompletar UC
        [
          "material_nueva",
          "altura_nueva",
          "poblacion_nueva",
          "disposicion_nueva",
          "tipo_red_nueva",
        ].forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("change", function () {
              console.log(`Campo ${id} cambió a:`, this.value);
              autoCompleteUC();
            });
            console.log(`Listener agregado a ${id}`);
          } else {
            console.error(`No se encontró el elemento con ID: ${id}`);
          }
        });

        // Setup file upload for estructura nueva
        setupFileDropZone("fotos_nueva", "preview_nueva", true);

        // Setup file uploads for conductores
        setupFileDropZone("fotos_conductor", "preview_conductor", true);
        setupFileDropZone(
          "fotos_conductor_n2_n3",
          "preview_conductor_n2_n3",
          true
        );

        // Setup file uploads for documentos
        setupFileDropZone("archivo_cad", "cad_preview", false);
        setupFileDropZone("archivo_kmz", "kmz_preview", false);

        // Función para configurar zonas de drag & drop
        function setupFileDropZone(inputId, previewId, isImage) {
          const input = document.getElementById(inputId);
          const preview = document.getElementById(previewId);
          const dropZone = input.closest(".file-drop-zone");

          if (!dropZone) return;

          dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("border-blue-500", "bg-blue-50/50");
          });

          dropZone.addEventListener("dragleave", () => {
            dropZone.classList.remove("border-blue-500", "bg-blue-50/50");
          });

          dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.classList.remove("border-blue-500", "bg-blue-50/50");
            handleFiles(e.dataTransfer.files, isImage, preview, input);
          });

          dropZone.addEventListener("click", () => input.click());
          input.addEventListener("change", () =>
            handleFiles(input.files, isImage, preview, input)
          );
        }

        // Función para manejar archivos cargados
        function handleFiles(files, isImage, preview, input) {
          if (isImage) {
            handleImageFiles(files, preview);
          } else {
            handleDocumentFile(files[0], preview);
          }
        }

        // Función para manejar imágenes
        function handleImageFiles(files, preview) {
          preview.innerHTML = "";
          Array.from(files).forEach((file) => {
            if (
              file.type.startsWith("image/") &&
              file.size <= 5 * 1024 * 1024
            ) {
              const reader = new FileReader();
              reader.onload = (e) => {
                const div = document.createElement("div");
                div.className = "relative group";
                div.innerHTML = `
                                <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg" />
                                <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-xs" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                preview.appendChild(div);
              };
              reader.readAsDataURL(file);
            } else if (file.size > 5 * 1024 * 1024) {
              alert(
                "La imagen " + file.name + " excede el tamaño máximo de 5MB"
              );
            }
          });
        }

        // Función para manejar documentos
        function handleDocumentFile(file, preview) {
          if (!file) return;

          const previewId = preview.id;
          const filename = document.getElementById(
            previewId.replace("preview", "filename")
          );
          const filesize = document.getElementById(
            previewId.replace("preview", "filesize")
          );
          const removeBtn = document.getElementById(
            previewId.replace("preview", "remove")
          );

          if (filename) filename.textContent = file.name;
          if (filesize) filesize.textContent = formatFileSize(file.size);
          if (removeBtn) {
            removeBtn.addEventListener("click", () => {
              preview.classList.add("hidden");
              const input = document.getElementById(
                previewId.replace("_preview", "")
              );
              if (input) input.value = "";
            });
          }

          preview.classList.remove("hidden");
        }

        // Función para formatear tamaño de archivo
        function formatFileSize(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        }

        // Función para agregar iteración a la tabla
        function addIterationToTable(iteration) {
          const tbody = document.getElementById("iterationTableBody");
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-50";

          row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${iteration.estructura_retirada_codigo || "-"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_retirada_material || "-"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_retirada_altura ? iteration.estructura_retirada_altura + "m" : "-"}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            ${iteration.estructura_retirada_fotos && iteration.estructura_retirada_fotos.length > 0 ? iteration.estructura_retirada_fotos.map((foto) => `<img src="${foto}" class="w-12 h-12 object-cover rounded border" />`).join("") : '<span class="text-gray-400 text-xs">Sin fotos</span>'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${iteration.estructura_nueva_codigo || "-"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_nueva_material || "-"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_nueva_altura ? iteration.estructura_nueva_altura + "m" : "-"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${iteration.estructura_nueva_apoyo || "-"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">
                        ${iteration.estructura_nueva_uc || "-"}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            ${iteration.estructura_nueva_fotos && iteration.estructura_nueva_fotos.length > 0 ? iteration.estructura_nueva_fotos.map((foto) => `<img src="${foto}" class="w-12 h-12 object-cover rounded border" />`).join("") : '<span class="text-gray-400 text-xs">Sin fotos</span>'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="removeIteration('${iteration.id}')" class="text-red-600 hover:text-red-900 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;

          tbody.appendChild(row);
        }

        // Event Listener para el botón de agregar iteración
        document
          .getElementById("addIteration")
          .addEventListener("click", function () {
            // Recopilar datos de estructura nueva
            const estructuraNueva = {
              apoyo: document.getElementById("apoyo_nueva").value,
              material: document.getElementById("material_nueva").value,
              altura: document.getElementById("altura_nueva").value,
              poblacion: document.getElementById("poblacion_nueva").value,
              disposicion: document.getElementById("disposicion_nueva").value,
              kgf: document.getElementById("kgf_nueva").value,
              tipo_red: document.getElementById("tipo_red_nueva").value,
              uc: document.getElementById("uc_codigo").value,
              fotos: Array.from(document.getElementById("fotos_nueva").files),
            };

            // Recopilar datos de estructura retirada
            const estructuraRetirada = {
              codigo: document.getElementById("estructura_retirada_campo")
                .value,
              // Datos adicionales que podrían estar en otros campos (para futuras expansiones)
              material: "", // Se puede agregar campo si es necesario
              altura: "", // Se puede agregar campo si es necesario
            };

            // Validar que se tengan los datos mínimos requeridos
            if (!estructuraNueva.uc) {
              alert(
                "Por favor complete todos los campos de estructura nueva para generar el código UC automáticamente"
              );
              return;
            }

            if (estructuraNueva.fotos.length === 0) {
              alert(
                "Por favor agregue al menos una foto de la estructura nueva"
              );
              return;
            }

            // Crear objeto de iteración con todos los datos
            const iteration = {
              id: Date.now().toString(),
              // Datos de estructura nueva
              estructura_nueva_codigo: "AUTO-" + Date.now(), // Generar código automático
              estructura_nueva_apoyo: estructuraNueva.apoyo,
              estructura_nueva_material: estructuraNueva.material,
              estructura_nueva_altura: estructuraNueva.altura,
              estructura_nueva_poblacion: estructuraNueva.poblacion,
              estructura_nueva_disposicion: estructuraNueva.disposicion,
              estructura_nueva_kgf: estructuraNueva.kgf,
              estructura_nueva_tipo_red: estructuraNueva.tipo_red,
              estructura_nueva_uc: estructuraNueva.uc,
              estructura_nueva_fotos: [],
              // Datos de estructura retirada
              estructura_retirada_codigo: estructuraRetirada.codigo,
              estructura_retirada_material: estructuraRetirada.material,
              estructura_retirada_altura: estructuraRetirada.altura,
              estructura_retirada_fotos: [],
            };

            // Procesar fotos de estructura nueva
            Array.from(estructuraNueva.fotos).forEach((file, index) => {
              const reader = new FileReader();
              reader.onload = function (e) {
                iteration.estructura_nueva_fotos.push(e.target.result);

                // Si es la última foto, agregar a tabla
                if (index === estructuraNueva.fotos.length - 1) {
                  addIterationToTable(iteration);

                  // Limpiar formulario
                  clearForm();
                }
              };
              reader.readAsDataURL(file);
            });
          });

        // Función para limpiar el formulario después de agregar iteración
        function clearForm() {
          // Limpiar estructura nueva
          document.getElementById("apoyo_nueva").value = "";
          document.getElementById("material_nueva").value = "";
          document.getElementById("altura_nueva").value = "";
          document.getElementById("poblacion_nueva").value = "";
          document.getElementById("disposicion_nueva").value = "";
          document.getElementById("kgf_nueva").value = "";
          document.getElementById("tipo_red_nueva").value = "";
          document.getElementById("fotos_nueva").value = "";
          document.getElementById("preview_nueva").innerHTML = "";

          // Limpiar estructura retirada
          document.getElementById("estructura_retirada_campo").value = "";

          // Limpiar UC y restaurar estado deshabilitado
          document.getElementById("uc_codigo").value = "";
          document.getElementById("descripcion_uc").value = "";
          document
            .getElementById("uc_codigo")
            .classList.remove("bg-green-50", "border-green-300");
          document
            .getElementById("descripcion_uc")
            .classList.remove("bg-green-50", "border-green-300");
          document.getElementById("uc_codigo").disabled = true;

          // Ocultar indicador visual
          document.getElementById("uc_indicator").classList.add("hidden");
        }

        // Función global para remover iteración
        window.removeIteration = function (iterationId) {
          if (confirm("¿Está seguro de eliminar esta iteración?")) {
            // Remover de la tabla
            const row = document
              .querySelector(`[onclick*="${iterationId}"]`)
              .closest("tr");
            if (row) row.remove();
          }
        };

        // Event listeners para envío
        document
          .getElementById("submitFinal")
          .addEventListener("click", function (e) {
            e.preventDefault();
            if (validateFormData()) {
              // Mostrar loading
              const submitBtn = document.getElementById("submitFinal");
              const originalText = submitBtn.innerHTML;
              submitBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Guardando...';
              submitBtn.disabled = true;

              // Enviar formulario de manera tradicional
              document.getElementById("mainForm").submit();
            }
          });

        // Función para validar coordenadas
        function validateCoordinate(input, type) {
          const value = parseFloat(input.value);
          const errorElementId = input.id + "_error";
          const errorElement = document.getElementById(errorElementId);

          let min, max, fieldName;

          if (type === "x" || type === "x_final") {
            min = 800000;
            max = 1300000;
            fieldName = type === "x" ? "Longitud" : "Longitud Final";
          } else if (type === "y" || type === "y_final") {
            min = 1000000;
            max = 1600000;
            fieldName = type === "y" ? "Latitud" : "Latitud Final";
          }

          if (input.value && (isNaN(value) || value < min || value > max)) {
            if (errorElement) {
              errorElement.textContent = `${fieldName} debe estar entre ${min.toLocaleString()} y ${max.toLocaleString()}`;
              errorElement.style.display = "block";
            }
            input.classList.add("border-red-500");
            return false;
          } else {
            if (errorElement) {
              errorElement.style.display = "none";
            }
            input.classList.remove("border-red-500");
            return true;
          }
        }

        // Función para validar datos del formulario
        function validateFormData() {
          const requiredFields = [
            "fecha",
            "t_inv",
            "municipio",
            "regional",
            "direccion",
            "alimentador",
            "barrio_vereda",
            "nivel_tension",
            "nombre",
            "contrato",
            "uc_codigo",
            "numero_x",
            "numero_y",
            "cod_trasnformador",
            "rpp",
          ];

          for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field || !field.value.trim()) {
              const fieldName = field
                ? field.previousElementSibling.textContent
                : fieldId;
              alert(`Por favor complete el campo: ${fieldName}`);
              if (field) field.focus();
              return false;
            }
          }

          // Validar que hay al menos una foto de estructura nueva
          const fotosNueva = document.getElementById("fotos_nueva").files;
          if (fotosNueva.length === 0) {
            alert("Por favor agregue al menos una foto de la estructura nueva");
            return false;
          }

          // Validar archivos CAD y KMZ
          const archivoCad = document.getElementById("archivo_cad").files[0];
          const archivoKmz = document.getElementById("archivo_kmz").files[0];
          if (!archivoCad) {
            alert("Por favor seleccione un archivo AutoCAD");
            return false;
          }
          if (!archivoKmz) {
            alert("Por favor seleccione un archivo KMZ");
            return false;
          }

          return true;
        }

        // Función para obtener CSRF token
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }

        // ========== NAVEGACIÓN DIRECTA ENTRE FORMULARIOS ==========

        // ========== FUNCIONES DE INICIALIZACIÓN ==========

        // Función para inicializar y probar las funciones
        function initializeFunctions() {
          console.log("=== Inicializando funciones ===");

          // Probar elementos
          const nombreEl = document.getElementById("nombre");
          const bancoEl = document.getElementById("banco_proyecto");
          const contratoEl = document.getElementById("contrato");
          const tipoInvEl = document.getElementById("t_inv");
          const estructuraRetEl = document.getElementById(
            "estructura_retirada_campo"
          );
          const municipioEl = document.getElementById("municipio");
          const departamentoEl = document.getElementById("departamento");
          const regionalEl = document.getElementById("regional");
          const alimentadorEl = document.getElementById("alimentador");

          console.log("Elementos encontrados:");
          console.log("- nombre:", nombreEl ? "✓" : "✗");
          console.log("- banco_proyecto:", bancoEl ? "✓" : "✗");
          console.log("- contrato:", contratoEl ? "✓" : "✗");
          console.log("- t_inv:", tipoInvEl ? "✓" : "✗");
          console.log(
            "- estructura_retirada_campo:",
            estructuraRetEl ? "✓" : "✗"
          );
          console.log("- municipio:", municipioEl ? "✓" : "✗");
          console.log("- departamento:", departamentoEl ? "✓" : "✗");
          console.log("- regional:", regionalEl ? "✓" : "✗");
          console.log("- alimentador:", alimentadorEl ? "✓" : "✗");

          // Probar mapeos
          console.log(
            "Proyectos en mapeo:",
            Object.keys(PROYECTO_BANCO_MAPPING).length
          );
          console.log(
            "Proyectos en mapeo completo:",
            Object.keys(PROYECTO_COMPLETO_MAPPING).length
          );
          console.log(
            "Municipios en mapeo:",
            Object.keys(MUNICIPIO_MAPPING).length
          );
          console.log(
            "Municipios con circuitos:",
            Object.keys(MUNICIPIO_CIRCUITO_MAPPING).length
          );

          // Inicializar estados
          if (typeof handleTipoInversion === "function") {
            handleTipoInversion();
          }

          // Inicializar contratos si ya hay proyecto seleccionado
          if (nombreEl && nombreEl.value) {
            console.log(
              "Proyecto pre-seleccionado detectado, actualizando contratos..."
            );
            actualizarContratos();
          }

          // Inicializar municipios filtrados si ya hay contrato seleccionado
          if (contratoEl && contratoEl.value) {
            console.log(
              "Contrato pre-seleccionado detectado, filtrando municipios..."
            );
            actualizarMunicipiosPorContrato();
          }

          // Inicializar circuitos si ya hay municipio seleccionado
          if (municipioEl && municipioEl.value) {
            console.log(
              "Municipio pre-seleccionado detectado, actualizando circuitos..."
            );
            actualizarCircuitos();
          }

          console.log("=== Inicialización completada ===");

          // Inicializar el navbar de navegación directa
          console.log("Inicializando navbar de navegación directa...");
          updateNavbarState();
          showStepContent(currentStep);

          // Asegurar que los campos estén configurados correctamente para el paso inicial
          updateFieldsForStep(currentStep);

          console.log("Navbar inicializado correctamente");

          // Configurar zonas de drag & drop para las nuevas secciones
          setupFileDropZone("fotos_conductor", "preview_conductor", true);
          setupFileDropZone("fotos_equipo", "preview_equipo", true);
          setupFileDropZone(
            "fotos_transformador",
            "preview_transformador",
            true
          );
        }

        // Llamar a la función de inicialización
        initializeFunctions();
      });
    </script>
  </body>
</html>
