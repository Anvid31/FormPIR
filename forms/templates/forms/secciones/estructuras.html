{% extends 'forms/secciones/base_seccion.html' %}
{% load static %}

{% block section_content %}
  {% include 'forms/form_sections/estructuras_complete.html' %}
  

  
{% endblock %}

{% block section_scripts %}
  <!-- Script de verificaci√≥n temporal -->
  <script>
    console.log('üèóÔ∏è Scripts espec√≠ficos de estructuras cargados');
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üèóÔ∏è Configurando Estructuras...');
      
      // SISTEMA COMPARTIDO DE ITERACIONES
      setTimeout(() => {
        if (typeof SistemaIteracionesCompartidasFinal !== 'undefined') {
          console.log('‚úÖ Sistema Compartido de Iteraciones disponible para Estructuras');
          // El sistema se auto-inicializa
        } else {
          console.error('‚ùå SistemaIteracionesCompartidasFinal no disponible');
        }
      }, 1000);
      
      // Funci√≥n para esperar el SharedFieldsManager
      function esperarSharedFieldsManager(intentos = 0) {
        if (window.sharedFieldsManager) {
          console.log('‚úÖ SharedFieldsManager detectado - configurando autocompletados adicionales');
          configurarAutocompletadosEstructuras();
        } else if (intentos < 20) {
          setTimeout(() => esperarSharedFieldsManager(intentos + 1), 100);
        } else {
          console.log('‚ö†Ô∏è SharedFieldsManager no disponible - configurando autocompletados manualmente');
          configurarAutocompletadosEstructuras();
        }
      }
      
      // Configurar autocompletados espec√≠ficos para Estructuras
      function configurarAutocompletadosEstructuras() {
        console.log('üîß Configurando autocompletados espec√≠ficos para Estructuras...');
        
        // 1. Configurar autocompletado de banco cuando cambie el proyecto
        const nombreField = document.getElementById('shared_nombre');
        if (nombreField) {
          const proyectoHandler = function() {
            const proyectoSeleccionado = this.value;
            console.log('üéØ Proyecto seleccionado en Estructuras:', proyectoSeleccionado);
            
            if (!proyectoSeleccionado) return;
            
            // Sincronizar al campo oculto
            const nombreOculto = document.getElementById('nombre');
            if (nombreOculto) {
              nombreOculto.value = proyectoSeleccionado;
            }
            
            // Ejecutar autocompletado de banco
            setTimeout(() => {
              if (typeof window.autoCompleteBanco === 'function') {
                window.autoCompleteBanco();
                console.log('‚úÖ Banco autocompletado desde Estructuras');
              }
              
              // Despu√©s del banco, actualizar contratos
              setTimeout(() => {
                if (typeof window.actualizarContratos === 'function') {
                  window.actualizarContratos();
                  
                  // Sincronizar contratos del campo oculto al compartido
                  setTimeout(() => {
                    const contratoOculto = document.getElementById('contrato');
                    const contratoCompartido = document.getElementById('shared_contrato');
                    
                    if (contratoOculto && contratoCompartido) {
                      contratoCompartido.innerHTML = contratoOculto.innerHTML;
                      contratoCompartido.disabled = false;
                      contratoCompartido.classList.add("bg-green-50", "border-green-300");
                      console.log('‚úÖ Contratos sincronizados en Estructuras');
                    }
                  }, 200);
                }
              }, 200);
            }, 200);
          };
          
          // Remover listeners previos y agregar nuevo
          nombreField.removeEventListener('change', proyectoHandler);
          nombreField.addEventListener('change', proyectoHandler);
          console.log('‚úÖ Handler de proyecto configurado para Estructuras');
        }
        
        // 2. Configurar filtrado de municipios cuando cambie el contrato - RESTAURADO
        const contratoField = document.getElementById('shared_contrato');
        if (contratoField) {
          const contratoHandler = function() {
            const contratoSeleccionado = this.value;
            console.log('üìÑ Contrato seleccionado en Estructuras:', contratoSeleccionado);
            
            if (!contratoSeleccionado) return;
            
            // Sincronizar al campo oculto para compatibilidad
            const contratoOculto = document.getElementById('contrato');
            if (contratoOculto) {
              contratoOculto.value = contratoSeleccionado;
              console.log('‚úÖ Contrato sincronizado al campo oculto');
            }
            
            // Ejecutar autocompletado de regional
            setTimeout(() => {
              if (typeof window.autoCompleteRegional === 'function') {
                window.autoCompleteRegional();
                console.log('‚úÖ Regional autocompletada desde contrato');
              }
              
              // Ejecutar filtrado de municipios por contrato - CLAVE
              setTimeout(() => {
                filtrarMunicipiosPorContrato(contratoSeleccionado);
              }, 200);
            }, 200);
          };
          
          // Remover listeners previos y agregar nuevo
          contratoField.removeEventListener('change', contratoHandler);
          contratoField.addEventListener('change', contratoHandler);
          console.log('‚úÖ Handler de contrato configurado para Estructuras con filtrado de municipios');
        }
        
        // 3. Configurar autocompletado de departamento cuando cambie municipio
        const municipioField = document.getElementById('shared_municipio');
        if (municipioField) {
          const municipioHandler = function() {
            const municipioSeleccionado = this.value;
            console.log('üèôÔ∏è Municipio seleccionado en Estructuras:', municipioSeleccionado);
            
            // Sincronizar al campo oculto
            const municipioOculto = document.getElementById('municipio');
            if (municipioOculto) {
              municipioOculto.value = municipioSeleccionado;
            }
            
            // Ejecutar autocompletado de departamento
            setTimeout(() => {
              if (typeof window.autoCompleteDepartamento === 'function') {
                window.autoCompleteDepartamento();
                console.log('‚úÖ Departamento autocompletado desde municipio');
              }
              
              // Ejecutar autocompletado de circuitos
              setTimeout(() => {
                if (typeof window.actualizarCircuitos === 'function') {
                  window.actualizarCircuitos();
                  console.log('‚úÖ Circuitos actualizados desde municipio');
                }
              }, 200);
            }, 200);
          };
          
          municipioField.removeEventListener('change', municipioHandler);
          municipioField.addEventListener('change', municipioHandler);
          console.log('‚úÖ Handler de municipio configurado para Estructuras');
        }
      }
      
      // Funci√≥n para filtrar municipios por contrato - RESTAURADA
      function filtrarMunicipiosPorContrato(contratoSeleccionado) {
        console.log('üîç Iniciando filtrado de municipios por contrato:', contratoSeleccionado);
        
        const municipioShared = document.getElementById('shared_municipio');
        const nombreProyecto = document.getElementById('shared_nombre')?.value || 
                              document.getElementById('nombre')?.value;
        
        if (!municipioShared || !nombreProyecto) {
          console.warn('‚ö†Ô∏è Campos necesarios no encontrados para filtrado de municipios');
          return;
        }
        
        // Limpiar opciones existentes
        municipioShared.innerHTML = '<option value="">Seleccionar municipio</option>';
        
        if (!contratoSeleccionado || contratoSeleccionado === 'Por definir') {
          // Mostrar todos los municipios si no hay contrato espec√≠fico
          if (typeof window.MUNICIPIO_MAPPING !== 'undefined') {
            Object.keys(window.MUNICIPIO_MAPPING).sort().forEach(municipio => {
              const option = document.createElement('option');
              option.value = municipio;
              option.textContent = municipio;
              municipioShared.appendChild(option);
            });
            
            municipioShared.disabled = false;
            municipioShared.classList.remove('bg-gray-100', 'cursor-not-allowed');
            municipioShared.classList.add('bg-white');
            console.log('üìã Mostrando todos los municipios (sin filtro)');
          }
          return;
        }
        
        // Buscar la regional del contrato seleccionado
        let regionalDelContrato = null;
        
        if (typeof window.PROYECTO_COMPLETO_MAPPING !== 'undefined' && 
            window.PROYECTO_COMPLETO_MAPPING[nombreProyecto]) {
          
          const contratos = window.PROYECTO_COMPLETO_MAPPING[nombreProyecto].contratos;
          const contratoData = contratos.find(c => c.codigo === contratoSeleccionado);
          
          if (contratoData && contratoData.regional !== 'Por definir') {
            regionalDelContrato = contratoData.regional;
            console.log('üè¢ Regional encontrada para contrato:', regionalDelContrato);
          }
        }
        
        if (!regionalDelContrato || typeof window.MUNICIPIO_MAPPING === 'undefined') {
          console.warn('‚ö†Ô∏è No se puede filtrar municipios - datos no disponibles');
          municipioShared.disabled = true;
          municipioShared.classList.add('bg-gray-100', 'cursor-not-allowed');
          return;
        }
        
        // Filtrar municipios por regional
        const municipiosFiltrados = Object.keys(window.MUNICIPIO_MAPPING).filter(municipio => {
          const datosM = window.MUNICIPIO_MAPPING[municipio];
          
          // Manejar variaciones de nombres de regionales
          if (regionalDelContrato === "C√öCUTA Y PAMPLONA") {
            return datosM.regional === "CUCUTA" || datosM.regional === "PAMPLONA";
          } else if (regionalDelContrato === "OCA√ëA Y AGUACHICA") {
            return datosM.regional === "OCA√ëA" || datosM.regional === "AGUACHICA";
          } else {
            return datosM.regional === regionalDelContrato || 
                   datosM.regional === regionalDelContrato.replace("√ö", "U");
          }
        });
        
        if (municipiosFiltrados.length > 0) {
          // Agregar municipios filtrados al select
          municipiosFiltrados.sort().forEach(municipio => {
            const option = document.createElement('option');
            option.value = municipio;
            option.textContent = municipio;
            municipioShared.appendChild(option);
          });
          
          // Habilitar el campo con indicador visual
          municipioShared.disabled = false;
          municipioShared.classList.remove('bg-gray-100', 'cursor-not-allowed');
          municipioShared.classList.add('bg-blue-50', 'border-blue-300');
          
          console.log(`‚úÖ Municipios filtrados para regional ${regionalDelContrato}:`, 
                     municipiosFiltrados.length, 'municipios disponibles');
          
          // Sincronizar tambi√©n al campo oculto
          const municipioOculto = document.getElementById('municipio');
          if (municipioOculto) {
            municipioOculto.innerHTML = municipioShared.innerHTML;
          }
          
        } else {
          // No hay municipios para esta regional
          const option = document.createElement('option');
          option.value = '';
          option.textContent = `No hay municipios disponibles para la regional ${regionalDelContrato}`;
          option.disabled = true;
          municipioShared.appendChild(option);
          
          municipioShared.disabled = true;
          municipioShared.classList.add('bg-red-50', 'border-red-300');
          
          console.log(`‚ö†Ô∏è No se encontraron municipios para la regional ${regionalDelContrato}`);
        }
      }
      
      // Iniciar configuraciones
      esperarSharedFieldsManager();
      
      console.log('‚úÖ Estructuras configuradas correctamente con filtrado de municipios restaurado');
    });
  </script>
{% endblock %}
