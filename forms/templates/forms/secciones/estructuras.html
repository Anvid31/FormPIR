{% extends 'forms/secciones/base_seccion.html' %}
{% load static %}

{% block section_content %}
  {% include 'forms/form_sections/estructuras_complete.html' %}
  

  
{% endblock %}

{% block section_scripts %}
  <!-- Script de verificación temporal -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // SISTEMA COMPARTIDO DE ITERACIONES
      setTimeout(() => {
        if (typeof SistemaIteracionesCompartidasFinal !== 'undefined') {
          // El sistema se auto-inicializa
        }
      }, 1000);
      
      // Función para esperar el SharedFieldsManager
      function esperarSharedFieldsManager(intentos = 0) {
        if (window.sharedFieldsManager) {
          configurarAutocompletadosEstructuras();
        } else if (intentos < 20) {
          setTimeout(() => esperarSharedFieldsManager(intentos + 1), 100);
        } else {
          configurarAutocompletadosEstructuras();
        }
      }
      
      // Configurar autocompletados específicos para Estructuras
      function configurarAutocompletadosEstructuras() {
        // 1. Configurar autocompletado de banco cuando cambie el proyecto
        const nombreField = document.getElementById('shared_nombre');
        if (nombreField) {
          const proyectoHandler = function() {
            const proyectoSeleccionado = this.value;
            
            if (!proyectoSeleccionado) return;
            
            // Sincronizar al campo oculto
            const nombreOculto = document.getElementById('nombre');
            if (nombreOculto) {
              nombreOculto.value = proyectoSeleccionado;
            }
            
            // Ejecutar autocompletado de banco
            setTimeout(() => {
              if (typeof window.autoCompleteBanco === 'function') {
                window.autoCompleteBanco();
              }
              
              // Después del banco, actualizar contratos
              setTimeout(() => {
                if (typeof window.actualizarContratos === 'function') {
                  window.actualizarContratos();
                  
                  // Sincronizar contratos del campo oculto al compartido
                  setTimeout(() => {
                    const contratoOculto = document.getElementById('contrato');
                    const contratoCompartido = document.getElementById('shared_contrato');
                    
                    if (contratoOculto && contratoCompartido) {
                      contratoCompartido.innerHTML = contratoOculto.innerHTML;
                      contratoCompartido.disabled = false;
                      contratoCompartido.classList.add("bg-green-50", "border-green-300");
                    }
                  }, 200);
                }
              }, 200);
            }, 200);
          };
          
          // Remover listeners previos y agregar nuevo
          nombreField.removeEventListener('change', proyectoHandler);
          nombreField.addEventListener('change', proyectoHandler);
        }
        
        // 2. Configurar filtrado de municipios cuando cambie el contrato - RESTAURADO
        const contratoField = document.getElementById('shared_contrato');
        if (contratoField) {
          const contratoHandler = function() {
            const contratoSeleccionado = this.value;
            
            if (!contratoSeleccionado) return;
            
            // Sincronizar al campo oculto para compatibilidad
            const contratoOculto = document.getElementById('contrato');
            if (contratoOculto) {
              contratoOculto.value = contratoSeleccionado;
            }
            
            // Ejecutar autocompletado de regional
            setTimeout(() => {
              if (typeof window.autoCompleteRegional === 'function') {
                window.autoCompleteRegional();
              }
              
              // Ejecutar filtrado de municipios por contrato - CLAVE
              setTimeout(() => {
                filtrarMunicipiosPorContrato(contratoSeleccionado);
              }, 200);
            }, 200);
          };
          
          // Remover listeners previos y agregar nuevo
          contratoField.removeEventListener('change', contratoHandler);
          contratoField.addEventListener('change', contratoHandler);
        }
        
        // 3. Configurar autocompletado de departamento cuando cambie municipio
        const municipioField = document.getElementById('shared_municipio');
        if (municipioField) {
          const municipioHandler = function() {
            const municipioSeleccionado = this.value;
            
            // Sincronizar al campo oculto
            const municipioOculto = document.getElementById('municipio');
            if (municipioOculto) {
              municipioOculto.value = municipioSeleccionado;
            }
            
            // Ejecutar autocompletado de departamento
            setTimeout(() => {
              if (typeof window.autoCompleteDepartamento === 'function') {
                window.autoCompleteDepartamento();
              }
              
              // Ejecutar autocompletado de circuitos
              setTimeout(() => {
                if (typeof window.actualizarCircuitos === 'function') {
                  window.actualizarCircuitos();
                }
              }, 200);
            }, 200);
          };
          
          municipioField.removeEventListener('change', municipioHandler);
          municipioField.addEventListener('change', municipioHandler);
        }
      }
      
      // Función para filtrar municipios por contrato - RESTAURADA
      function filtrarMunicipiosPorContrato(contratoSeleccionado) {
        const municipioShared = document.getElementById('shared_municipio');
        const nombreProyecto = document.getElementById('shared_nombre')?.value || 
                              document.getElementById('nombre')?.value;
        
        if (!municipioShared || !nombreProyecto) {
          return;
        }
        
        // Limpiar opciones existentes
        municipioShared.innerHTML = '<option value="">Seleccionar municipio</option>';
        
        if (!contratoSeleccionado || contratoSeleccionado === 'Por definir') {
          // Mostrar todos los municipios si no hay contrato específico
          if (typeof window.MUNICIPIO_MAPPING !== 'undefined') {
            Object.keys(window.MUNICIPIO_MAPPING).sort().forEach(municipio => {
              const option = document.createElement('option');
              option.value = municipio;
              option.textContent = municipio;
              municipioShared.appendChild(option);
            });
            
            municipioShared.disabled = false;
            municipioShared.classList.remove('bg-gray-100', 'cursor-not-allowed');
            municipioShared.classList.add('bg-white');
          }
          return;
        }
        
        // Buscar la regional del contrato seleccionado
        let regionalDelContrato = null;
        
        if (typeof window.PROYECTO_COMPLETO_MAPPING !== 'undefined' && 
            window.PROYECTO_COMPLETO_MAPPING[nombreProyecto]) {
          
          const contratos = window.PROYECTO_COMPLETO_MAPPING[nombreProyecto].contratos;
          const contratoData = contratos.find(c => c.codigo === contratoSeleccionado);
          
          if (contratoData && contratoData.regional !== 'Por definir') {
            regionalDelContrato = contratoData.regional;
          }
        }
        
        if (!regionalDelContrato || typeof window.MUNICIPIO_MAPPING === 'undefined') {
          municipioShared.disabled = true;
          municipioShared.classList.add('bg-gray-100', 'cursor-not-allowed');
          return;
        }
        
        // Filtrar municipios por regional
        const municipiosFiltrados = Object.keys(window.MUNICIPIO_MAPPING).filter(municipio => {
          const datosM = window.MUNICIPIO_MAPPING[municipio];
          
          // Manejar variaciones de nombres de regionales
          if (regionalDelContrato === "CÚCUTA Y PAMPLONA") {
            return datosM.regional === "CUCUTA" || datosM.regional === "PAMPLONA";
          } else if (regionalDelContrato === "OCAÑA Y AGUACHICA") {
            return datosM.regional === "OCAÑA" || datosM.regional === "AGUACHICA";
          } else {
            return datosM.regional === regionalDelContrato || 
                   datosM.regional === regionalDelContrato.replace("Ú", "U");
          }
        });
        
        if (municipiosFiltrados.length > 0) {
          // Agregar municipios filtrados al select
          municipiosFiltrados.sort().forEach(municipio => {
            const option = document.createElement('option');
            option.value = municipio;
            option.textContent = municipio;
            municipioShared.appendChild(option);
          });
          
          // Habilitar el campo con indicador visual
          municipioShared.disabled = false;
          municipioShared.classList.remove('bg-gray-100', 'cursor-not-allowed');
          municipioShared.classList.add('bg-blue-50', 'border-blue-300');
          
          // Sincronizar también al campo oculto
          const municipioOculto = document.getElementById('municipio');
          if (municipioOculto) {
            municipioOculto.innerHTML = municipioShared.innerHTML;
          }
          
        } else {
          // No hay municipios para esta regional
          const option = document.createElement('option');
          option.value = '';
          option.textContent = `No hay municipios disponibles para la regional ${regionalDelContrato}`;
          option.disabled = true;
          municipioShared.appendChild(option);
          
          municipioShared.disabled = true;
          municipioShared.classList.add('bg-red-50', 'border-red-300');
        }
      }
      
      // Iniciar configuraciones
      esperarSharedFieldsManager();
    });
  </script>
{% endblock %}
