{% extends 'forms/secciones/base_seccion.html' %}
{% load static %}

{% block section_content %}
  {% include 'forms/form_sections/estructuras_complete.html' %}
  
  <!-- NOTA: La tabla de iteraciones se inyecta automÃ¡ticamente por iteraciones-compartidas.js -->
  
{% endblock %}

{% block section_scripts %}
  <!-- Script de verificaciÃ³n temporal -->
  <script src="{% static 'forms/js/tests/test-valores-predefinidos.js' %}"></script>
  
  <script>
    console.log('ğŸ—ï¸ Scripts especÃ­ficos de estructuras cargados');
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ—ï¸ Configurando autocompletados para Estructuras...');
      
      // FunciÃ³n para esperar el IteracionesManager con reintentos
      function esperarIteracionesManager(intentos = 0) {
        if (window.iteracionesManager && window.iteracionesManager.setSeccionActiva) {
          window.iteracionesManager.setSeccionActiva('estructuras');
          console.log('âœ… Sistema de iteraciones configurado para Estructuras');
        } else if (intentos < 20) { // MÃ¡ximo 2 segundos (20 * 100ms)
          setTimeout(() => esperarIteracionesManager(intentos + 1), 100);
        } else {
          console.log('â„¹ï¸  IteracionesManager no disponible despuÃ©s de 2 segundos - continuando sin Ã©l');
        }
      }
      
      // Configurar autocompletados para campos compartidos
      function configurarAutocompletados() {
        // 1. Configurar autocompletado de banco cuando cambie el proyecto
        const nombreField = document.getElementById('shared_nombre');
        if (nombreField && typeof window.autoCompleteBanco === 'function') {
          nombreField.addEventListener('change', function() {
            // Sincronizar al campo oculto primero
            const nombreOculto = document.getElementById('nombre');
            if (nombreOculto) {
              nombreOculto.value = this.value;
            }
            
            // Ejecutar autocompleta  do de banco
            setTimeout(() => {
              window.autoCompleteBanco();
              
              // DespuÃ©s del banco, actualizar contratos
              setTimeout(() => {
                if (typeof window.actualizarContratos === 'function') {
                  window.actualizarContratos();
                  
                  // Sincronizar contratos del campo oculto al compartido
                  setTimeout(() => {
                    const contratoOculto = document.getElementById('contrato');
                    const contratoCompartido = document.getElementById('shared_contrato');
                    
                    if (contratoOculto && contratoCompartido) {
                      contratoCompartido.innerHTML = contratoOculto.innerHTML;
                      console.log('âœ… Contratos sincronizados al campo compartido');
                    }
                  }, 100);
                }
              }, 100);
            }, 100);
          });
          
          console.log('âœ… Autocompletado de banco configurado para campo compartido');
        }
        
        // 2. Configurar autocompletado de municipios cuando cambie el contrato
        const contratoField = document.getElementById('shared_contrato');
        if (contratoField && typeof window.actualizarMunicipiosPorContrato === 'function') {
          contratoField.addEventListener('change', function() {
            // Sincronizar al campo oculto primero
            const contratoOculto = document.getElementById('contrato');
            if (contratoOculto) {
              contratoOculto.value = this.value;
            }
            
            // Ejecutar autocompletado de municipios
            setTimeout(() => {
              window.actualizarMunicipiosPorContrato();
            }, 100);
          });
          
          console.log('âœ… Autocompletado de municipios configurado para campo compartido');
        }
      }
      
      // Iniciar configuraciones
      esperarIteracionesManager();
      
      // Configurar autocompletados despuÃ©s de un pequeÃ±o delay para asegurar que todo estÃ© cargado
      setTimeout(configurarAutocompletados, 500);
      
      console.log('âœ… Estructuras configuradas correctamente');
    });
  </script>
{% endblock %}
