<!-- Wrapper del formulario completo -->
<div id="form-total">
  <!-- Secci√≥n: Informaci√≥n del Proyecto - Compartida -->
  {% include 'forms/components/shared-project-info.html' %}

  <!-- Secci√≥n: Documentos y Archivos - Compartida -->
  {% include 'forms/components/shared-documents.html' %}

  <!-- Campos ocultos para mantener compatibilidad con el formulario original -->
  <div style="display: none;">
    <input type="text" id="nombre" name="nombre" />
    <input type="text" id="banco_proyecto" name="banco_proyecto" />
    <input type="text" id="contrato" name="contrato" />
    <input type="file" id="archivo_cad" name="archivo_cad" />
    <input type="file" id="archivo_kmz" name="archivo_kmz" />
  </div>

  <!-- Secci√≥n: Informaci√≥n T√©cnica -->
  <div
    class="bg-white rounded-lg shadow-sm p-8 mb-8"
    id="seccion-informacion-tecnica"
  >
    <h2 class="text-xl font-semibold mb-6 flex items-center text-blue-600">
      <i class="fas fa-bolt mr-2"></i>
      Informaci√≥n T√©cnica
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="form-group">
        <label class="form-label required">
          FECHA DE INSTALACION
          <span class="tooltip">
            <i class="fas fa-question-circle help-icon"></i>
            <span class="tooltip-content">
              Fecha en la que se instal√≥. No puede ser posterior a la fecha
              actual.
            </span>
          </span>
        </label>
        <input
          type="date"
          id="fecha"
          name="fecha"
          class="form-input"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label required">
          TIPO DE INVERSION
          <span class="tooltip">
            <i class="fas fa-question-circle help-icon"></i>
            <span class="tooltip-content">
              Tipo de inversi√≥n: I y III requieren estructura retirada, II y IV
              son instalaciones nuevas sin retirar estructura existente.
            </span>
          </span>
        </label>
        <div class="flex items-start gap-4">
          <div class="flex-1">
            <select id="t_inv" name="t_inv" class="form-select" required onchange="handleTipoInversion()">
              <option value="">Seleccionar</option>
              <option value="I">I</option>
              <option value="II">II</option>
              <option value="III">III</option>
              <option value="IV">IV</option>
            </select>
          </div>

          <!-- Checkbox Montaje Integral -->
          <div
            class="flex items-center space-x-2"
            id="montaje_integral_container"
          >
            <input
              type="checkbox"
              id="montaje_integral_checkbox"
              name="montaje_integral"
              class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded"
              onchange="toggleMontajeIntegral()"
            />
            <label
              for="montaje_integral_checkbox"
              class="text-sm text-orange-700 flex items-center gap-1"
            >
              <i class="fas fa-tools text-xs"></i>
              Montaje Integral
            </label>
          </div>
        </div>

        <!-- Texto de ayuda solo para Montaje Integral -->
        <div class="flex gap-4 mt-1">
          <div class="flex-1"></div>
          <div
            class="text-xs text-gray-500 text-center"
            id="montaje_integral_help"
            style="display: none"
          >
            Deshabilita campos UC
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label required">
          MUNICIPIO
          <span class="tooltip">
            <i class="fas fa-question-circle help-icon"></i>
            <span class="tooltip-content">
              Municipio donde se instalar√° la estructura. Los municipios
              disponibles dependen de la regional seleccionada.
            </span>
          </span>
        </label>
        <select id="municipio" name="municipio" class="form-select" required>
          <option value="">Seleccionar municipio</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label required">
          DEPARTAMENTO
          <span class="tooltip">
            <i class="fas fa-question-circle help-icon"></i>
            <span class="tooltip-content">
              Departamento donde se encuentra el municipio seleccionado. Se
              autocompletar√° seg√∫n el municipio.
            </span>
          </span>
        </label>
        <input
          type="text"
          id="departamento"
          name="departamento"
          class="form-input bg-gray-50"
          placeholder="Se autocompletar√° seg√∫n el municipio"
          readonly
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label required">
          REGIONAL
          <span class="tooltip">
            <i class="fas fa-question-circle help-icon"></i>
            <span class="tooltip-content">
              Regional responsable del proyecto. Se autocompletar√° seg√∫n el
              contrato o municipio seleccionado.
            </span>
          </span>
        </label>
        <input
          type="text"
          id="regional"
          name="regional"
          class="form-input bg-gray-100 text-gray-500 cursor-not-allowed"
          placeholder="Se autocompletar√° seg√∫n contrato o municipio"
          readonly
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label required">DIRECCI√ìN</label>
        <input
          type="text"
          id="direccion"
          name="direccion"
          class="form-input"
          placeholder="Direcci√≥n completa"
          required
        />
      </div>

      <div class="form-group">
        <label class="form-label required">
          CIRCUITO
          <span class="tooltip">
            <i class="fas fa-question-circle help-icon"></i>
            <span class="tooltip-content">
              Circuito el√©ctrico (alimentador) al que se conecta la estructura.
              Se actualiza autom√°ticamente seg√∫n el municipio seleccionado.
            </span>
          </span>
        </label>
        <select
          id="alimentador"
          name="alimentador"
          class="form-select"
          required
        >
          <option value="">Seleccionar</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label required" for="estructura_retirada_campo">
          ESTRUCTURA RETIRADA
          <span class="tooltip">
            <i class="fas fa-question-circle help-icon"></i>
            <span class="tooltip-content">
              C√≥digo de la estructura que se retira. Solo se habilita para tipos
              de inversi√≥n I y III. Debe empezar con "Z" seguido de n√∫meros.
            </span>
          </span>
        </label>

        
        <div class="flex items-start gap-4">
          <!-- Campo de entrada -->
          <div class="flex-1">
            <input
              type="text"
              id="estructura_retirada_campo"
              name="estructura_retirada_campo"
              class="form-input bg-white"
              placeholder="Z10000"
            />
          </div>
          
          <!-- Checkbox Desmantelado junto al campo -->
          <div
            class="flex items-center space-x-2"
            id="desmantelado_container"
            style="display: none"
          >
            <input
              type="checkbox"
              id="desmantelado_checkbox"
              name="desmantelado"
              class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
              onchange="toggleDesmantelado()"
            />
            <label
              for="desmantelado_checkbox"
              class="text-sm text-red-700 flex items-center gap-1 whitespace-nowrap"
            >
              <i class="fas fa-exclamation-triangle text-xs"></i>
              Desmantelado
            </label>
          </div>
        </div>
        
        <!-- Texto de ayuda para desmantelado -->
        <div class="mt-1">
          <div
            class="text-xs text-gray-500 text-center"
            id="desmantelado_help"
            style="display: none"
          >
            Solo habilita: Informaci√≥n del proyecto, Documentos/archivos y Estructura retirada
          </div>
        </div>
      </div>

      <!-- Campos de coordenadas -->
      <div class="md:col-span-3">
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
          <div class="form-group">
            <label class="form-label required" id="longitud_label">
              LONGITUD
              <span class="tooltip">
                <i class="fas fa-question-circle help-icon"></i>
                <span class="tooltip-content">
                  Coordenada de Longitud (grados decimales) de la ubicaci√≥n en
                  Colombia. Rango v√°lido: -79.0 a -66.8 (valores negativos hacia
                  el oeste).
                </span>
              </span>
            </label>
            <input
              type="number"
              id="longitud"
              name="longitud"
              class="form-input"
              placeholder="-74.0721"
              step="0.000001"
              required
              oninput="validateCoordinate(this, 'longitud')"
            />
          </div>

          <div class="form-group">
            <label class="form-label required" id="latitud_label">
              LATITUD
              <span class="tooltip">
                <i class="fas fa-question-circle help-icon"></i>
                <span class="tooltip-content">
                  Coordenada de Latitud (grados decimales) de la ubicaci√≥n en
                  Colombia. Rango v√°lido: -4.2 a 15.5 (positivo hacia el norte).
                </span>
              </span>
            </label>
            <input
              type="number"
              id="latitud"
              name="latitud"
              class="form-input"
              placeholder="4.7110"
              step="0.000001"
              required
              oninput="validateCoordinate(this, 'latitud')"
            />
          </div>

          <div
            class="form-group"
            id="longitud_final_group"
            style="display: none"
          >
            <label class="form-label" id="longitud_final_label">
              LONGITUD FINAL
              <span class="tooltip">
                <i class="fas fa-question-circle help-icon"></i>
                <span class="tooltip-content">
                  Coordenada de Longitud Final (grados decimales) de la
                  ubicaci√≥n final en Colombia. Rango v√°lido: -79.0 a -66.8
                  (valores negativos hacia el oeste).
                </span>
              </span>
            </label>
            <input
              type="number"
              id="longitud_final"
              name="longitud_final"
              class="form-input"
              placeholder="-74.0721"
              step="0.000001"
              min="-79.0"
              max="-66.8"
              oninput="validateCoordinate(this, 'longitud')"
            />
          </div>

          <div
            class="form-group"
            id="latitud_final_group"
            style="display: none"
          >
            <label class="form-label" id="latitud_final_label">
              LATITUD FINAL
              <span class="tooltip">
                <i class="fas fa-question-circle help-icon"></i>
                <span class="tooltip-content">
                  Coordenada de Latitud Final (grados decimales) de la ubicaci√≥n
                  final en Colombia. Rango v√°lido: -4.2 a 15.5 (positivo hacia
                  el norte).
                </span>
              </span>
            </label>
            <input
              type="number"
              id="latitud_final"
              name="latitud_final"
              class="form-input"
              placeholder="4.7110"
              step="0.000001"
              min="-4.2"
              max="15.5"
              oninput="validateCoordinate(this, 'latitud')"
            />
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">CANTIDAD TOTAL</label>
        <input
          type="number"
          id="cantidad"
          name="cantidad"
          class="form-input bg-gray-100 text-gray-600 cursor-not-allowed"
          value="1"
          readonly
          disabled
        />
        <small class="text-xs text-gray-500 mt-1">Valor fijo para estructuras</small>
      </div>

      <div class="form-group">
        <label class="form-label">N√öMERO DE CONDUCTORES</label>
        <input
          type="text"
          id="numero_conductores"
          name="numero_conductores"
          class="form-input bg-gray-100 text-gray-600 cursor-not-allowed"
          value="0"
          readonly
          disabled
        />
        <small class="text-xs text-gray-500 mt-1">Valor fijo para estructuras</small>
      </div>
    </div>
  </div>

  <!-- Secci√≥n: Informaci√≥n de Estructuras -->
  <div
    class="bg-white rounded-lg shadow-sm p-8 mb-8"
    id="seccion-informacion-estructuras"
  >
    <h2 class="text-xl font-semibold mb-6 flex items-center text-blue-600">
      <i class="fas fa-building mr-2"></i>
      Informaci√≥n de Estructuras
    </h2>

    <!-- Contenedor de campos de estructuras -->
    <div id="form-uc">
      <!-- Estructura Nueva - Solo Selector UC Jer√°rquico -->
      <div class="bg-emerald-50/50 rounded-lg border border-emerald-200 p-6 mb-6">
        
        <!-- Selector UC Jer√°rquico Integrado -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-emerald-800 mb-4 flex items-center">
            <i class="fas fa-cube mr-2"></i>
            Configuraci√≥n de Unidad Constructiva
          </h3>
          <p class="text-sm text-gray-600 mb-4">
            Utiliza el selector jer√°rquico para configurar autom√°ticamente todos los par√°metros de la estructura seg√∫n el tipo de UC seleccionado.
          </p>
          
          <!-- El selector UC jer√°rquico reemplaza todos los campos individuales -->
          {% include 'forms/components/uc-selector-estructuras.html' %}
        </div>

        <!-- Fotos -->
        <div class="mt-6">
          <label class="form-label required">Fotograf√≠as</label>
          <div class="flex items-center justify-center w-full">
            <label
              for="fotos"
              class="flex flex-col items-center justify-center w-full h-40 border-2 border-yellow-300 border-dashed rounded-lg cursor-pointer bg-green-50 hover:bg-green-100 dark:border-green-600 dark:hover:border-green-500"
            >
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <svg
                  class="w-8 h-8 mb-4 text-green-500"
                  aria-hidden="true"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 20 16"
                >
                  <path
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"
                />
              </svg>
              <p class="mb-2 text-sm text-green-600">
                <span class="font-semibold">Click para subir</span> o arrastra y
                suelta
              </p>
              <p class="text-xs text-green-500">
                JPG, PNG ‚Ä¢ M√∫ltiples archivos ‚Ä¢ M√°ximo 5MB cada uno
              </p>
            </div>
            <input
              id="fotos"
              name="fotos"
              type="file"
              accept="image/*"
              multiple
              class="hidden"
            />
          </label>
        </div>
        <div
          id="preview"
          class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4 mt-4"
        ></div>
      </div>

      <!-- Bot√≥n Agregar Iteraci√≥n -->
      <div class="mt-6 flex justify-end">
        <!-- TABLA LEGACY COMENTADA - Se usa tabla compartida de iteraciones-compartidas.js
        <button
          type="button"
          id="agregarIteracion"
          class="btn-agregar-iteracion px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
        >
          <i class="fas fa-plus"></i>
          Agregar Iteraci√≥n
        </button>
      </div>
    </div>

    <!-- 
    TABLA LEGACY COMENTADA - NO USAR
    Esta tabla est√° comentada porque ahora usamos el sistema unificado de iteraciones-compartidas.js
    
    <div class="bg-white rounded-lg shadow-sm p-8 mb-8">
      <h2 class="text-xl font-semibold mb-6 flex items-center text-blue-600">
        <i class="fas fa-table mr-2"></i>
        Registro de Iteraciones
      </h2>

      <div class="overflow-x-auto rounded-lg border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th
                colspan="4"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
              >
                Estructura Retirada
              </th>
              <th
                colspan="7"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
              >
                Estructura Nueva
              </th>
              <th
                rowspan="2"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50"
              >
                Acciones
              </th>
            </tr>
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
              >
                Material
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
              >
                Altura
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
              >
                Apoyo
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-amber-50"
              >
                UC
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
              >
                Material
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
              >
                Altura
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
              >
                Poblaci√≥n
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
              >
                Disposici√≥n
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
              >
                Apoyo
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
              >
                UC
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-emerald-50"
              >
                Fotos
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-red-50"
              >
                Acciones
              </th>
            </tr>
          </thead>
          <tbody
            id="iterationTableBody"
            class="bg-white divide-y divide-gray-200"
          >
            <!-- Las filas se agregar√°n din√°micamente aqu√≠ -->
          </tbody>
        </table>
      </div>
    </div>
    
    FIN TABLA LEGACY COMENTADA 
    -->
    
    <!-- Fin contenedor form-uc -->
  </div>
</div>
<!-- Fin del wrapper del formulario completo -->

<form id="formEstructuras" method="post" enctype="multipart/form-data">
  <!-- ...todos los campos del formulario... -->
  <input type="hidden" id="iteraciones_json" name="iteraciones_json" />
  <!-- ...bot√≥n de env√≠o... -->
</form>

<script>
// Array para almacenar las iteraciones
let iteraciones = [];

// Funci√≥n para parsear informaci√≥n del UC desde la descripci√≥n
function parseUCFromDescription(ucCode, ucDescription) {
    if (!ucDescription) return {};
    
    const parsed = {
        material: '',
        altura: '',
        poblacion: '',
        apoyo: '',
        codigo: ucCode || ''
    };
    
    const desc = ucDescription.toLowerCase();
    
    // Extraer material - patrones m√°s espec√≠ficos
    if (desc.includes('concreto')) {
        parsed.material = 'concreto';
    } else if (desc.includes('met√°lico') || desc.includes('metalico')) {
        parsed.material = 'met√°lico';
    } else if (desc.includes('madera')) {
        parsed.material = 'madera';
    } else if (desc.includes('fibra de vidrio')) {
        parsed.material = 'fibra de vidrio';
    }
    
    // Extraer altura (buscar patr√≥n "## m")
    const alturaMatch = ucDescription.match(/(\d+)\s*m/);
    if (alturaMatch) {
        parsed.altura = alturaMatch[1];
    }
    
    // Extraer poblaci√≥n - patrones mejorados
    if (desc.includes('urbano')) {
        parsed.poblacion = 'urbano';
    } else if (desc.includes('rural')) {
        parsed.poblacion = 'rural';
    } else if (desc.includes('circuito doble') || desc.includes('protegida')) {
        // Circuitos dobles y l√≠neas protegidas suelen ser urbanos
        parsed.poblacion = 'urbano';
    } else if (desc.includes('l√≠nea a√©rea desnuda') || desc.includes('circuito sencillo')) {
        // L√≠neas a√©reas desnudas y circuitos sencillos suelen ser rurales
        parsed.poblacion = 'rural';
    }
    
    // Extraer apoyo/disposici√≥n (suspensi√≥n/retenci√≥n)
    if (desc.includes('suspensi√≥n')) {
        parsed.apoyo = 'suspensi√≥n';
    } else if (desc.includes('retenci√≥n')) {
        parsed.apoyo = 'retenci√≥n';
    }
    
    console.log(`parseUCFromDescription para ${ucCode}:`, parsed);
    return parsed;
}

// Funci√≥n de debug para inspeccionar el selector UC
function debugUCSelector() {
    console.log('=== DEBUG UC SELECTOR ===');
    
    // Buscar todos los elementos relacionados con UC
    const elementos = {
        'uc_nueva': document.getElementById('uc_nueva'),
        'descripcion_uc': document.getElementById('descripcion_uc'),
        'uc-preview': document.querySelector('.uc-preview'),
        'uc-code-display': document.getElementById('uc-code-display'),
        'uc-desc-display': document.getElementById('uc-desc-display'),
        'uc-selector-container': document.getElementById('uc-selector-container')
    };
    
    // Mostrar valores
    Object.entries(elementos).forEach(([key, elem]) => {
        if (elem) {
            console.log(`${key}:`, {
                value: elem.value || elem.textContent,
                innerHTML: elem.innerHTML?.substring(0, 200) + '...',
                attributes: Array.from(elem.attributes || []).map(a => `${a.name}="${a.value}"`)
            });
        } else {
            console.log(`${key}: NO ENCONTRADO`);
        }
    });
    
    // **NUEVO** - An√°lisis detallado del preview
    const previewContainer = document.querySelector('.uc-preview, #uc-preview');
    if (previewContainer) {
        console.log('=== AN√ÅLISIS DETALLADO DEL PREVIEW ===');
        const textoCompleto = previewContainer.textContent || previewContainer.innerText || '';
        console.log('Texto completo del preview:', textoCompleto);
        
        // Intentar extraer patrones comunes
        const patrones = {
            codigo: textoCompleto.match(/([A-Z]\d+[A-Z]?\d*)/),
            material: textoCompleto.match(/Poste de ([^-]+)/i) || textoCompleto.match(/concreto|madera|met√°lico|fibra de vidrio/i),
            altura: textoCompleto.match(/(\d+)\s*m/i),
            poblacion: textoCompleto.match(/urbano|rural/gi),
            disposicion: textoCompleto.match(/suspensi√≥n|retenci√≥n/gi)
        };
        
        console.log('Patrones encontrados en preview:', patrones);
        
        // Buscar elementos seleccionados dentro del preview
        const elementosSeleccionados = previewContainer.querySelectorAll('.selected, .active, [data-selected], .highlighted');
        if (elementosSeleccionados.length > 0) {
            console.log('Elementos seleccionados en preview:', Array.from(elementosSeleccionados).map(el => ({
                tag: el.tagName,
                texto: el.textContent,
                clases: el.className,
                atributos: Array.from(el.attributes).map(a => `${a.name}="${a.value}"`).join(', ')
            })));
        }
    }
    
    // Buscar campos ocultos relacionados con UC
    const hiddenInputs = document.querySelectorAll('input[type="hidden"][name*="uc"], input[type="hidden"][id*="uc"]');
    console.log('Campos ocultos UC:', Array.from(hiddenInputs).map(input => ({
        id: input.id,
        name: input.name,
        value: input.value
    })));
    
    // Buscar selectores
    const selects = document.querySelectorAll('select[name*="uc"], select[id*="uc"]');
    console.log('Selectores UC:', Array.from(selects).map(select => ({
        id: select.id,
        name: select.name,
        value: select.value,
        selectedText: select.selectedOptions[0]?.textContent
    })));
    
    // Buscar todos los elementos que puedan contener datos UC
    const allInputs = document.querySelectorAll('input, select, textarea');
    const ucRelated = Array.from(allInputs).filter(input => 
        input.id?.toLowerCase().includes('uc') || 
        input.name?.toLowerCase().includes('uc') ||
        input.className?.toLowerCase().includes('uc')
    );
    console.log('Todos los elementos relacionados con UC:', ucRelated.map(elem => ({
        tag: elem.tagName,
        id: elem.id,
        name: elem.name,
        value: elem.value,
        className: elem.className
    })));
    
    // **NUEVO** - Probar la extracci√≥n de datos en tiempo real
    console.log('=== PRUEBA DE EXTRACCI√ìN EN TIEMPO REAL ===');
    const datosExtraidos = obtenerDatosUCDesdeSelector();
    console.log('Datos que se extraer√≠an actualmente:', datosExtraidos);
}

// Funci√≥n alternativa para obtener datos del selector UC
function obtenerDatosUCDesdeSelector() {
    console.log('=== OBTENIENDO DATOS UC ===');
    
    // Esta funci√≥n intenta m√∫ltiples formas de obtener los datos
    const datos = {
        material: '',
        altura: '',
        poblacion: '',
        disposicion: '',
        apoyo: '',
        codigo: ''
    };
    
    // M√©todo 1: Campos ocultos principales
    const ucCodigo = document.getElementById('uc_nueva')?.value || '';
    const ucDescripcion = document.getElementById('descripcion_uc')?.value || '';
    
    console.log('M√©todo 1 - Campos principales:', { ucCodigo, ucDescripcion });
    
    if (ucCodigo) datos.codigo = ucCodigo;
    
    // M√©todo 2: **NUEVO** - Buscar en el preview del selector (MUY IMPORTANTE)
    const previewContainer = document.querySelector('.uc-preview, #uc-preview, .selected-uc-info');
    if (previewContainer) {
        const texto = previewContainer.textContent || previewContainer.innerText || '';
        console.log('M√©todo 2 - Preview encontrado, texto completo:', texto);
        
        // Buscar el c√≥digo UC en el preview (generalmente aparece como c√≥digo)
        const codigoMatch = texto.match(/([A-Z]\d+[A-Z]?\d*)/);
        if (codigoMatch && !datos.codigo) {
            datos.codigo = codigoMatch[1];
            console.log('C√≥digo UC encontrado en preview:', codigoMatch[1]);
        }
        
        // Buscar informaci√≥n espec√≠fica en el texto del preview
        // Patr√≥n: "Poste de X - Y m - Z - W"
        const descripcionMatch = texto.match(/Poste de ([^-]+)\s*-\s*(\d+)\s*m\s*-\s*([^-]+)\s*-\s*([^-\n]+)/);
        if (descripcionMatch) {
            datos.material = descripcionMatch[1].trim();
            datos.altura = descripcionMatch[2];
            datos.poblacion = descripcionMatch[3].trim();
            datos.disposicion = descripcionMatch[4].trim();
            datos.apoyo = descripcionMatch[4].trim(); // apoyo = disposici√≥n
            console.log('Datos parseados desde preview:', { 
                material: datos.material, 
                altura: datos.altura, 
                poblacion: datos.poblacion, 
                disposicion: datos.disposicion 
            });
        }
        
        // M√©todos alternativos de parsing si el formato es diferente
        if (!datos.material) {
            // Buscar "material: X" o similar
            const materialMatch = texto.match(/material[:\s]+([^\n,]+)/i) || 
                                 texto.match(/concreto|madera|met√°lico|fibra de vidrio/i);
            if (materialMatch) {
                datos.material = materialMatch[1] ? materialMatch[1].trim() : materialMatch[0];
                console.log('Material encontrado alternativo:', datos.material);
            }
        }
        
        if (!datos.altura) {
            // Buscar "X m" o "altura: X"
            const alturaMatch = texto.match(/(\d+)\s*m/i) || texto.match(/altura[:\s]+(\d+)/i);
            if (alturaMatch) {
                datos.altura = alturaMatch[1];
                console.log('Altura encontrada alternativa:', datos.altura);
            }
        }
        
        if (!datos.poblacion) {
            // Buscar urbano/rural
            if (texto.toLowerCase().includes('urbano')) {
                datos.poblacion = 'urbano';
            } else if (texto.toLowerCase().includes('rural')) {
                datos.poblacion = 'rural';
            }
            console.log('Poblaci√≥n encontrada alternativa:', datos.poblacion);
        }
        
        if (!datos.disposicion) {
            // Buscar suspensi√≥n/retenci√≥n
            if (texto.toLowerCase().includes('suspensi√≥n')) {
                datos.disposicion = 'suspensi√≥n';
                datos.apoyo = 'suspensi√≥n';
            } else if (texto.toLowerCase().includes('retenci√≥n')) {
                datos.disposicion = 'retenci√≥n';
                datos.apoyo = 'retenci√≥n';
            }
            console.log('Disposici√≥n encontrada alternativa:', datos.disposicion);
        }
    }
    
    // M√©todo 3: Buscar en elementos espec√≠ficos del preview
    const ucCodeDisplay = document.getElementById('uc-code-display');
    const ucDescDisplay = document.getElementById('uc-desc-display');
    
    if (ucCodeDisplay && ucCodeDisplay.textContent && !datos.codigo) {
        datos.codigo = ucCodeDisplay.textContent.trim();
        console.log('M√©todo 3a - C√≥digo desde uc-code-display:', datos.codigo);
    }
    
    if (ucDescDisplay && ucDescDisplay.textContent) {
        const descripcionCompleta = ucDescDisplay.textContent.trim();
        console.log('M√©todo 3b - Descripci√≥n desde uc-desc-display:', descripcionCompleta);
        
        // Parsear la descripci√≥n completa
        const parsed = parseUCFromDescription(datos.codigo, descripcionCompleta);
        Object.keys(parsed).forEach(key => {
            if (parsed[key] && !datos[key]) {
                datos[key] = parsed[key];
            }
        });
    }
    
    // M√©todo 4: Buscar en la estructura jer√°rquica del selector
    const selectorContainer = document.getElementById('uc-selector-container');
    if (selectorContainer) {
        // Buscar elementos seleccionados dentro del contenedor
        const selectedElements = selectorContainer.querySelectorAll('.selected, .active, [data-selected="true"]');
        selectedElements.forEach(elem => {
            const text = elem.textContent || elem.innerText || '';
            const dataValue = elem.getAttribute('data-value') || elem.getAttribute('data-code') || '';
            
            if (dataValue && !datos.codigo) {
                datos.codigo = dataValue;
                console.log('M√©todo 4a - C√≥digo desde elemento seleccionado:', dataValue);
            }
            
            if (text && text.includes('m')) {
                const alturaMatch = text.match(/(\d+)\s*m/);
                if (alturaMatch && !datos.altura) {
                    datos.altura = alturaMatch[1];
                    console.log('M√©todo 4b - Altura desde elemento seleccionado:', datos.altura);
                }
            }
        });
    }
    
    // M√©todo 5: Si tenemos UC_MAPPING y un c√≥digo, usarlo
    if (window.UC_MAPPING && datos.codigo) {
        let mappingData = null;
        
        // Buscar coincidencia exacta
        if (window.UC_MAPPING[datos.codigo]) {
            mappingData = window.UC_MAPPING[datos.codigo];
            console.log('M√©todo 5 - Coincidencia exacta en UC_MAPPING para', datos.codigo, ':', mappingData);
        } else {
            // Buscar c√≥digos similares si no hay coincidencia exacta
            const codePrefix = datos.codigo.substring(0, 3);
            const similarCodes = Object.keys(window.UC_MAPPING).filter(code => 
                code.startsWith(codePrefix)
            );
            
            if (similarCodes.length > 0) {
                mappingData = window.UC_MAPPING[similarCodes[0]];
                console.log(`M√©todo 5 - Usando c√≥digo similar ${similarCodes[0]} para ${datos.codigo}:`, mappingData);
            }
        }
        
        if (mappingData) {
            // Parsear los datos del mapping
            const parsed = parseUCFromDescription(datos.codigo, mappingData);
            Object.keys(parsed).forEach(key => {
                if (parsed[key] && !datos[key]) {
                    datos[key] = parsed[key];
                    console.log(`M√©todo 5 - Completado ${key} desde UC_MAPPING:`, parsed[key]);
                }
            });
            
            // Inferir poblaci√≥n si no se encontr√≥ en el preview
            if (!datos.poblacion) {
                // Buscar patrones espec√≠ficos que indiquen el tipo de poblaci√≥n
                if (mappingData.toLowerCase().includes('l√≠nea a√©rea')) {
                    // Las l√≠neas a√©reas desnudas generalmente son rurales
                    // Las l√≠neas a√©reas con circuito doble pueden ser urbanas
                    if (mappingData.toLowerCase().includes('circuito doble') || 
                        mappingData.toLowerCase().includes('protegida') ||
                        mappingData.toLowerCase().includes('urbano')) {
                        datos.poblacion = 'urbano';
                    } else {
                        datos.poblacion = 'rural';
                    }
                    console.log('M√©todo 5 - Poblaci√≥n inferida:', datos.poblacion);
                }
                
                // Si a√∫n no tenemos poblaci√≥n, usar rural como default para l√≠neas
                if (!datos.poblacion && mappingData.toLowerCase().includes('l√≠nea')) {
                    datos.poblacion = 'rural';
                    console.log('M√©todo 5 - Poblaci√≥n por defecto (l√≠nea):', datos.poblacion);
                }
            }
        }
    }
    
    console.log('Datos finales obtenidos:', datos);
    return datos;
}

// Funci√≥n para capturar los datos de la UC y otros campos - MEJORADA
function capturarDatosUC() {
    console.log('=== CAPTURANDO DATOS UC ===');
    
    // Usar la funci√≥n alternativa para obtener datos
    const datosUC = obtenerDatosUCDesdeSelector();
    
    // Capturar fotos
    const fotosInput = document.getElementById('fotos');
    let fotos = [];
    if (fotosInput && fotosInput.files.length > 0) {
        for (let i = 0; i < fotosInput.files.length; i++) {
            fotos.push(fotosInput.files[i].name);
        }
    }

    // Capturar datos de estructura retirada
    const retiradaCodigo = document.getElementById('estructura_retirada_campo')?.value || '';
    
    // Construir objeto final
    const resultado = {
        retirada: {
            material: '-',
            altura: '-',
            apoyo: '-',
            codigo: retiradaCodigo || '-'
        },
        nueva: {
            material: datosUC.material || '-',
            altura: datosUC.altura || '-',
            poblacion: datosUC.poblacion || '-',
            disposicion: datosUC.disposicion || datosUC.apoyo || '-',
            apoyo: datosUC.apoyo || datosUC.disposicion || '-',
            codigo: datosUC.codigo || '-',
            fotos: fotos
        }
    };
    
    console.log('Resultado final capturarDatosUC:', resultado);
    return resultado;
}

// Funci√≥n para renderizar la tabla de iteraciones
function renderizarTablaIteraciones() {
    const tbody = document.getElementById('iterationTableBody');
    tbody.innerHTML = '';
    
    if (iteraciones.length === 0) {
        // Mostrar mensaje cuando no hay iteraciones
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="12" class="px-6 py-4 text-center text-gray-500 italic">
                No hay iteraciones agregadas. Selecciona una UC y haz clic en "Agregar Iteraci√≥n".
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    iteraciones.forEach((iter, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4">${iter.retirada.material}</td>
            <td class="px-6 py-4">${iter.retirada.altura}</td>
            <td class="px-6 py-4">${iter.retirada.apoyo}</td>
            <td class="px-6 py-4"><span class="font-mono text-xs bg-amber-100 px-2 py-1 rounded">${iter.retirada.codigo}</span></td>
            <td class="px-6 py-4">${iter.nueva.material}</td>
            <td class="px-6 py-4">${iter.nueva.altura}${iter.nueva.altura !== '-' ? 'm' : ''}</td>
            <td class="px-6 py-4">${iter.nueva.poblacion}</td>
            <td class="px-6 py-4">${iter.nueva.disposicion}</td>
            <td class="px-6 py-4">${iter.nueva.apoyo}</td>
            <td class="px-6 py-4"><span class="font-mono text-xs bg-emerald-100 px-2 py-1 rounded">${iter.nueva.codigo}</span></td>
            <td class="px-6 py-4">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${iter.nueva.fotos.length > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                    ${iter.nueva.fotos.length}
                </span>
            </td>
            <td class="px-6 py-4">
                <button type="button" class="text-red-600 hover:text-red-800 transition-colors" onclick="eliminarIteracion(${idx})" title="Eliminar iteraci√≥n">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Funci√≥n para agregar una iteraci√≥n
function agregarIteracion() {
    const datos = capturarDatosUC();
    
    // Validaci√≥n mejorada - verificar si tenemos al menos algo de informaci√≥n UC
    const tieneInformacionUC = datos.nueva.codigo !== '-' || 
                              datos.nueva.material !== '-' || 
                              datos.nueva.altura !== '-';
    
    if (!tieneInformacionUC) {
        alert('Por favor, selecciona una Unidad Constructiva usando el selector jer√°rquico antes de agregar la iteraci√≥n.');
        console.warn('‚ùå No se encontr√≥ informaci√≥n de UC. Ejecutando debug...');
        debugUCSelector(); // Ejecutar debug autom√°ticamente si hay error
        return;
    }
    
    // Verificar si tenemos informaci√≥n m√≠nima necesaria
    if (datos.nueva.codigo === '-' && datos.nueva.material === '-') {
        const confirmar = confirm('Se detect√≥ informaci√≥n limitada de la UC. ¬øDeseas continuar agregando la iteraci√≥n?');
        if (!confirmar) {
            debugUCSelector();
            return;
        }
    }
    
    iteraciones.push(datos);
    renderizarTablaIteraciones();
    
    console.log('‚úÖ Iteraci√≥n agregada correctamente:', datos);
    console.log('üìä Total de iteraciones:', iteraciones.length);
    
    // Opcional: Limpiar el selector de fotos despu√©s de agregar
    const fotosInput = document.getElementById('fotos');
    if (fotosInput) {
        fotosInput.value = '';
        const preview = document.getElementById('preview');
        if (preview) preview.innerHTML = '';
    }
    
    // Mostrar mensaje de √©xito con informaci√≥n de la UC
    const infoUC = datos.nueva.codigo !== '-' ? 
                   `UC: ${datos.nueva.codigo}` : 
                   `Material: ${datos.nueva.material}, Altura: ${datos.nueva.altura}m`;
    mostrarMensaje(`Iteraci√≥n agregada correctamente. ${infoUC}`, 'success');
}

// Funci√≥n para mostrar mensajes al usuario
function mostrarMensaje(mensaje, tipo = 'info') {
    // Crear elemento de mensaje
    const mensajeEl = document.createElement('div');
    mensajeEl.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-all duration-300 ${
        tipo === 'success' ? 'bg-green-500' : 
        tipo === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    mensajeEl.textContent = mensaje;
    
    document.body.appendChild(mensajeEl);
    
    // Remover despu√©s de 3 segundos
    setTimeout(() => {
        mensajeEl.remove();
    }, 3000);
}

// Funci√≥n para eliminar una iteraci√≥n
function eliminarIteracion(idx) {
    iteraciones.splice(idx, 1);
    renderizarTablaIteraciones();
}

// Evento para el bot√≥n Agregar Iteraci√≥n
const btnAgregar = document.getElementById('agregarIteracion');
if (btnAgregar) {
    btnAgregar.addEventListener('click', agregarIteracion);
    
    // Agregar bot√≥n de debug
    const debugBtn = document.createElement('button');
    debugBtn.textContent = 'üîç Debug UC';
    debugBtn.type = 'button';
    debugBtn.className = 'ml-2 px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm';
    debugBtn.onclick = debugUCSelector;
    debugBtn.title = 'Inspeccionar elementos del selector UC para debug';
    
    // Insertar el bot√≥n de debug despu√©s del bot√≥n agregar
    btnAgregar.parentElement.appendChild(debugBtn);
    
    console.log('‚úÖ Botones de iteraci√≥n inicializados');
}

// Serializar iteraciones antes de enviar el formulario
const formEstructuras = document.getElementById('formEstructuras');
if (formEstructuras) {
    formEstructuras.addEventListener('submit', function(e) {
        if (iteraciones.length === 0) {
            const confirmacion = confirm('No has agregado ninguna iteraci√≥n. ¬øDeseas continuar sin iteraciones?');
            if (!confirmacion) {
                e.preventDefault();
                return;
            }
        }
        
        document.getElementById('iteraciones_json').value = JSON.stringify(iteraciones);
        console.log('üì§ Enviando formulario con iteraciones:', iteraciones);
    });
}

// Funci√≥n para validar UC antes de env√≠o
function validarUCSeleccionado() {
    const ucCodigo = document.getElementById('uc_nueva')?.value;
    const ucDescripcion = document.getElementById('descripcion_uc')?.value;
    
    if (!ucCodigo && !ucDescripcion) {
        console.warn('‚ö†Ô∏è No se ha seleccionado ninguna UC');
        return false;
    }
    
    console.log('‚úÖ UC validado:', { ucCodigo, ucDescripcion });
    return true;
}

// Inicializar tabla vac√≠a al cargar y configurar eventos
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando sistema de iteraciones...');
    
    renderizarTablaIteraciones();
    
    // Verificar que los elementos necesarios existan
    const elementosNecesarios = [
        'agregarIteracion',
        'iterationTableBody',
        'uc_nueva',
        'descripcion_uc'
    ];
    
    const elementosFaltantes = elementosNecesarios.filter(id => !document.getElementById(id));
    
    if (elementosFaltantes.length > 0) {
        console.error('‚ùå Elementos faltantes:', elementosFaltantes);
    } else {
        console.log('‚úÖ Todos los elementos necesarios est√°n presentes');
    }
    
    // Agregar listener para cambios en el selector UC
    const ucNueva = document.getElementById('uc_nueva');
    if (ucNueva) {
        ucNueva.addEventListener('change', function() {
            console.log('üîÑ UC cambiado:', this.value);
            validarUCSeleccionado();
        });
    }
    
    console.log('‚úÖ Sistema de iteraciones inicializado correctamente');
});
</script>
